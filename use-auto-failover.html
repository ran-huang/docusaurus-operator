<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.16">
<title data-rh="true">Automatic Failover | TiDB in Kubernetes Docs</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ran-huang.github.io/docusaurus-operator/use-auto-failover"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Automatic Failover | TiDB in Kubernetes Docs"><meta data-rh="true" name="description" content="TiDB Operator manages the deployment and scaling of Pods based on StatefulSet. When some Pods or nodes fail, StatefulSet does not support automatically creating new Pods to replace the failed ones. To solve this issue, TiDB Operator supports the automatic failover feature by scaling Pods automatically."><meta data-rh="true" property="og:description" content="TiDB Operator manages the deployment and scaling of Pods based on StatefulSet. When some Pods or nodes fail, StatefulSet does not support automatically creating new Pods to replace the failed ones. To solve this issue, TiDB Operator supports the automatic failover feature by scaling Pods automatically."><link data-rh="true" rel="icon" href="/docusaurus-operator/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ran-huang.github.io/docusaurus-operator/use-auto-failover"><link data-rh="true" rel="alternate" href="https://ran-huang.github.io/docusaurus-operator/use-auto-failover" hreflang="en"><link data-rh="true" rel="alternate" href="https://ran-huang.github.io/docusaurus-operator/use-auto-failover" hreflang="x-default"><link rel="stylesheet" href="/docusaurus-operator/assets/css/styles.68554639.css">
<link rel="preload" href="/docusaurus-operator/assets/js/runtime~main.f81f0faa.js" as="script">
<link rel="preload" href="/docusaurus-operator/assets/js/main.5a4d47d5.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docusaurus-operator/"><div class="navbar__logo"><img src="/docusaurus-operator/img/tidb-logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/docusaurus-operator/img/tidb-logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">TiDB in Kubernetes</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docusaurus-operator/">Docs</a><a class="navbar__item navbar__link" href="/docusaurus-operator/architecture">Reference</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ran-huang/docusaurus-operator" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode (currently light mode)"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" href="/docusaurus-operator/">TiDB in Kubernetes</a><button aria-label="Toggle the collapsible sidebar category &#x27;TiDB in Kubernetes&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docusaurus-operator/get-started">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" href="/docusaurus-operator/category/deploy">Deploy</a><button aria-label="Toggle the collapsible sidebar category &#x27;Deploy&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docusaurus-operator/restore-data-using-tidb-lightning">Migrate</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active" href="/docusaurus-operator/category/manage">Manage</a><button aria-label="Toggle the collapsible sidebar category &#x27;Manage&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docusaurus-operator/enable-tls-for-mysql-client">Secure</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/scale-a-tidb-cluster">Scale</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docusaurus-operator/upgrade-a-tidb-cluster">Upgrade</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" tabindex="0" href="/docusaurus-operator/backup-restore-overview">Backup and Restore</a><button aria-label="Toggle the collapsible sidebar category &#x27;Backup and Restore&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docusaurus-operator/restart-a-tidb-cluster">Maintain</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/restart-a-tidb-cluster">Restart a TiDB Cluster in Kubernetes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/destroy-a-tidb-cluster">Destroy TiDB Clusters in Kubernetes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/view-logs">View TiDB Logs in Kubernetes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/modify-tidb-configuration">Modify TiDB Cluster Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docusaurus-operator/use-auto-failover">Automatic Failover</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/pause-sync-of-tidb-cluster">Pause Sync of a TiDB Cluster in Kubernetes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-multiple-tidb-operator">Maintain Different TiDB Clusters Separately Using Multiple Sets of TiDB Operator</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/maintain-a-kubernetes-node">Maintain Kubernetes Nodes that Hold the TiDB Cluster</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/migrate-to-helm3">Migrate from Helm 2 to Helm 3</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docusaurus-operator/monitor-a-tidb-cluster">Monitor and Alert</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docusaurus-operator/recover-deleted-cluster">Disaster Recovery</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docusaurus-operator/tips">Troubleshoot</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docusaurus-operator/faq">FAQ</a></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/docusaurus-operator/category/manage">Manage</a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">Maintain</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/docusaurus-operator/use-auto-failover">Automatic Failover</a></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Automatic failover</h1><p>TiDB Operator manages the deployment and scaling of Pods based on <a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/" target="_blank" rel="noopener noreferrer"><code>StatefulSet</code></a>. When some Pods or nodes fail, <code>StatefulSet</code> does not support automatically creating new Pods to replace the failed ones. To solve this issue, TiDB Operator supports the automatic failover feature by scaling Pods automatically.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="configure-automatic-failover">Configure automatic failover<a class="hash-link" href="#configure-automatic-failover" title="Direct link to heading">â€‹</a></h2><p>The automatic failover feature is enabled by default in TiDB Operator.</p><p>When deploying TiDB Operator, you can configure the waiting timeout for failover of the PD, TiKV, TiDB, and TiFlash components in a TiDB cluster in the <code>charts/tidb-operator/values.yaml</code> file. An example is as follows:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">controllerManager</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># autoFailover is whether tidb-operator should auto failover when failure occurs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">autoFailover</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># pd failover period default(5m)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">pdFailoverPeriod</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># tikv failover period default(5m)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">tikvFailoverPeriod</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># tidb failover period default(5m)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">tidbFailoverPeriod</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># tiflash failover period default(5m)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">tiflashFailoverPeriod</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 5m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In the example, <code>pdFailoverPeriod</code>, <code>tikvFailoverPeriod</code>, <code>tiflashFailoverPeriod</code> and <code>tidbFailoverPeriod</code> indicate the waiting timeout (5 minutes by default) after an instance failure is identified. After the timeout, TiDB Operator starts the automatic failover process.</p><p>In addition, when configuring a TiDB cluster, you can specify <code>spec.${component}.maxFailoverCount</code> for each component, which is the threshold of the maximum number of Pods that the TiDB Operator can create during automatic failover. For more information, see the <a href="/docusaurus-operator/configure-a-tidb-cluster#configure-automatic-failover-thresholds-of-pd-tidb-tikv-and-tiflash">TiDB component configuration documentation</a>.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>If there are not enough resources in the cluster for TiDB Operator to create new Pods, the newly scaled Pods will be in the pending status.</p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="automatic-failover-policies">Automatic failover policies<a class="hash-link" href="#automatic-failover-policies" title="Direct link to heading">â€‹</a></h2><p>There are six components in a TiDB cluster: PD, TiKV, TiDB, TiFlash, TiCDC, and Pump. Currently, TiCDC and Pump do not support the automatic failover feature. PD, TiKV, TiDB, and TiFlash have different failover policies. This section gives a detailed introduction to these policies.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="failover-with-pd">Failover with PD<a class="hash-link" href="#failover-with-pd" title="Direct link to heading">â€‹</a></h3><p>TiDB Operator collects the health status of PD members via the <code>pd/health</code> PD API and records the status in the <code>.status.pd.members</code> field of the TidbCluster CR.</p><p>Take a PD cluster with 3 Pods as an example. If a Pod fails for more than 5 minutes (<code>pdFailoverPeriod</code> is configurable), TiDB Operator automatically does the following operations:</p><ol><li>TiDB Operator records the Pod information in the <code>.status.pd.failureMembers</code> field of TidbCluster CR.</li><li>TiDB Operator takes the Pod offline: TiDB Operator calls PD API to remove the Pod from the member list, and then deletes the Pod and its PVC.</li><li>The StatefulSet controller recreates the Pod, and the recreated Pod joins the cluster as a new member.</li><li>When calculating the replicas of PD StatefulSet, TiDB Operator takes the deleted <code>.status.pd.failureMembers</code> into account, so it will create a new Pod. Then, 4 Pods will exist at the same time.</li></ol><p>When all the failed Pods in the cluster recover, TiDB Operator will automatically remove the newly created Pods, and the number of Pods gets back to the original.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><ul><li>For each PD cluster, the maximum number of Pods that TiDB Operator can create is <code>spec.pd.maxFailoverCount</code> (the default value is <code>3</code>). After the threshold is reached, TiDB Operator will not perform failover.</li><li>If most members in a PD cluster fail, which makes the PD cluster unavailable, TiDB Operator will not perform failover for the PD cluster.</li></ul></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="failover-with-tidb">Failover with TiDB<a class="hash-link" href="#failover-with-tidb" title="Direct link to heading">â€‹</a></h3><p>TiDB Operator collects the Pod health status by accessing the <code>/status</code> interface of each TiDB Pod and records the status in the <code>.status.tidb.members</code> field of the TidbCluster CR.</p><p>Take a TiDB cluster with 3 Pods as an example. If a Pod fails for more than 5 minutes (<code>tidbFailoverPeriod</code> is configurable), TiDB Operator automatically does the following operations:</p><ol><li>TiDB Operator records the Pod information in the <code>.status.tidb.failureMembers</code> field of TidbCluster CR.</li><li>When calculating the replicas of TiDB StatefulSet, TiDB Operator takes the <code>.status.tidb.failureMembers</code> into account, so it will create a new Pod. Then, 4 Pods will exist at the same time.</li></ol><p>When the failed Pod in the cluster recovers, TiDB Operator will automatically remove the newly created Pod, and the number of Pods gets back to 3.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>For each TiDB cluster, the maximum number of Pods that TiDB Operator can create is <code>spec.tidb.maxFailoverCount</code> (the default value is <code>3</code>). After the threshold is reached, TiDB Operator will not perform failover.</p></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="failover-with-tikv">Failover with TiKV<a class="hash-link" href="#failover-with-tikv" title="Direct link to heading">â€‹</a></h3><p>TiDB Operator collects the TiKV store health status by accessing the PD API and records the status in the <code>.status.tikv.stores</code> field in TidbCluster CR.</p><p>Take a TiKV cluster with 3 Pods as an example. When a TiKV Pod fails, the store status of the Pod changes to <code>Disconnected</code>. By default, after 30 minutes (configurable by changing <code>max-store-down-time = &quot;30m&quot;</code> in the <code>[schedule]</code> section of <code>pd.config</code>), the status changes to <code>Down</code>. Then, TiDB Operator automatically does the following operations:</p><ol><li>Wait for another 5 minutes (configurable by modifying <code>tikvFailoverPeriod</code>), if this TiKV Pod is still not recovered, TiDB Operator records the Pod information in the <code>.status.tikv.failureStores</code> field of TidbCluster CR.</li><li>When calculating the replicas of TiKV StatefulSet, TiDB Operator takes the <code>.status.tikv.failureStores</code> into account, so it will create a new Pod. Then, 4 Pods will exist at the same time.</li></ol><p>When the failed Pod in the cluster recovers, TiDB Operator <strong>DOES NOT</strong> remove the newly created Pod, but continues to keep 4 Pods. This is because scaling in TiKV Pods will trigger data migration, which might affect the cluster performance.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>For each TiKV cluster, the maximum number of Pods that TiDB Operator can create is <code>spec.tikv.maxFailoverCount</code> (the default value is <code>3</code>). After the threshold is reached, TiDB Operator will not perform failover.</p></div></div><p>If <strong>all</strong> failed Pods have recovered, and you want to remove the newly created Pods, you can follow the procedure below:</p><p>Configure <code>spec.tikv.recoverFailover: true</code> (Supported since TiDB Operator v1.1.5):</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch tc -n </span><span class="token variable" style="color:#36acaa">${namespace}</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${cluster_name}</span><span class="token plain"> --type merge -p </span><span class="token string" style="color:#e3116c">&#x27;{&quot;spec&quot;:{&quot;tikv&quot;:{&quot;recoverFailover&quot;: true}}}&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>TiDB Operator will remove the newly created Pods automatically. When the removal is finished, configure <code>spec.tikv.recoverFailover: false</code> to avoid the auto-scaling operation when the next failover occurs and recovers.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="failover-with-tiflash">Failover with TiFlash<a class="hash-link" href="#failover-with-tiflash" title="Direct link to heading">â€‹</a></h3><p>TiDB Operator collects the TiFlash store health status by accessing the PD API and records the status in the <code>.status.tiflash.stores</code> field in TidbCluster CR.</p><p>Take a TiFlash cluster with 3 Pods as an example. When a TiFlash Pod fails, the store status of the Pod changes to <code>Disconnected</code>. By default, after 30 minutes (configurable by changing <code>max-store-down-time = &quot;30m&quot;</code> in the <code>[schedule]</code> section of <code>pd.config</code>), the status changes to <code>Down</code>. Then, TiDB Operator automatically does the following operations:</p><ol><li>Wait for another 5 minutes (configurable by modifying <code>tiflashFailoverPeriod</code>), if the TiFlash Pod is still not recovered, TiDB Operator records the Pod information in the <code>.status.tiflash.failureStores</code> field of TidbCluster CR.</li><li>When calculating the replicas of TiFlash StatefulSet, TiDB Operator takes the <code>.status.tiflash.failureStores</code> into account, so it will create a new Pod. Then, 4 Pods will exist at the same time.</li></ol><p>When the failed Pod in the cluster recovers, TiDB Operator <strong>DOES NOT</strong> remove the newly created Pod, but continues to keep 4 Pods. This is because scaling in TiFlash Pods will trigger data migration, which might affect the cluster performance.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>For each TiFlash cluster, the maximum number of Pods that TiDB Operator can create is <code>spec.tiflash.maxFailoverCount</code> (the default value is <code>3</code>). After the threshold is reached, TiDB Operator will not perform failover.</p></div></div><p>If <strong>all</strong> of the failed Pods have recovered, and you want to remove the newly created Pods, you can follow the procedure below:</p><p>Configure <code>spec.tiflash.recoverFailover: true</code> (Supported since TiDB Operator v1.1.5):</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch tc -n </span><span class="token variable" style="color:#36acaa">${namespace}</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${cluster_name}</span><span class="token plain"> --type merge -p </span><span class="token string" style="color:#e3116c">&#x27;{&quot;spec&quot;:{&quot;tiflash&quot;:{&quot;recoverFailover&quot;: true}}}&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>TiDB Operator will remove the newly created Pods automatically. When the removal is finished, configure <code>spec.tiflash.recoverFailover: false</code> to avoid the auto-scaling operation when the next failover occurs and recovers.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="disable-automatic-failover">Disable automatic failover<a class="hash-link" href="#disable-automatic-failover" title="Direct link to heading">â€‹</a></h3><p>You can disable the automatic failover feature at the cluster or component level:</p><ul><li><p>To disable the automatic failover feature at the cluster level, set <code>controllerManager.autoFailover</code> to <code>false</code> in the <code>charts/tidb-operator/values.yaml</code> file when deploying TiDB Operator. An example is as follows:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">controllerManager</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># autoFailover is whether tidb-operator should auto failover when failure occurs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">autoFailover</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>To disable the automatic failover feature at the component level, set <code>spec.${component}.maxFailoverCount</code> of the target component to <code>0</code> in the TidbCluster CR when creating the TiDB cluster.</p></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/use-auto-failover.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docusaurus-operator/modify-tidb-configuration"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Modify TiDB Cluster Configuration</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docusaurus-operator/pause-sync-of-tidb-cluster"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Pause Sync of a TiDB Cluster in Kubernetes</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#configure-automatic-failover" class="table-of-contents__link toc-highlight">Configure automatic failover</a></li><li><a href="#automatic-failover-policies" class="table-of-contents__link toc-highlight">Automatic failover policies</a><ul><li><a href="#failover-with-pd" class="table-of-contents__link toc-highlight">Failover with PD</a></li><li><a href="#failover-with-tidb" class="table-of-contents__link toc-highlight">Failover with TiDB</a></li><li><a href="#failover-with-tikv" class="table-of-contents__link toc-highlight">Failover with TiKV</a></li><li><a href="#failover-with-tiflash" class="table-of-contents__link toc-highlight">Failover with TiFlash</a></li><li><a href="#disable-automatic-failover" class="table-of-contents__link toc-highlight">Disable automatic failover</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docusaurus-operator/">User Manual</a></li><li class="footer__item"><a class="footer__link-item" href="/docusaurus-operator/architecture">Reference</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/tidb" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://tidb.io" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>tidb.io<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/pingcap" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/pingcap/tidb-operator" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Source Code<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 TiDB in Kubernetes Docs, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/docusaurus-operator/assets/js/runtime~main.f81f0faa.js"></script>
<script src="/docusaurus-operator/assets/js/main.5a4d47d5.js"></script>
</body>
</html>