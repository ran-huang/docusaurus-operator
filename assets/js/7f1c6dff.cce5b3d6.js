"use strict";(self.webpackChunkpingcap_docs=self.webpackChunkpingcap_docs||[]).push([[6110],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return h}});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},l=Object.keys(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),d=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=d(e.components);return r.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},p=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,l=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),p=d(n),h=a,m=p["".concat(s,".").concat(h)]||p[h]||c[h]||l;return n?r.createElement(m,i(i({ref:t},u),{},{components:n})):r.createElement(m,i({ref:t},u))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var l=n.length,i=new Array(l);i[0]=p;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:a,i[1]=o;for(var d=2;d<l;d++)i[d]=n[d];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}p.displayName="MDXCreateElement"},7055:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return o},contentTitle:function(){return s},metadata:function(){return d},assets:function(){return u},toc:function(){return c},default:function(){return h}});var r=n(7462),a=n(3366),l=(n(7294),n(3905)),i=["components"],o={title:"TiDB Scheduler",summary:"Learn what is TiDB Scheduler and how it works."},s="TiDB Scheduler",d={unversionedId:"tidb-scheduler",id:"tidb-scheduler",title:"TiDB Scheduler",description:"TiDB Scheduler is a TiDB implementation of Kubernetes scheduler extender. TiDB Scheduler is used to add new scheduling rules to Kubernetes. This document introduces these new scheduling rules and how TiDB Scheduler works.",source:"@site/docs/tidb-scheduler.md",sourceDirName:".",slug:"/tidb-scheduler",permalink:"/docusaurus-operator/tidb-scheduler",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/tidb-scheduler.md",tags:[],version:"current",frontMatter:{title:"TiDB Scheduler",summary:"Learn what is TiDB Scheduler and how it works."},sidebar:"refSidebar",previous:{title:"TiDB Operator Architecture",permalink:"/docusaurus-operator/architecture"},next:{title:"Advanced StatefulSet Controller",permalink:"/docusaurus-operator/advanced-statefulset"}},u={},c=[{value:"tidb-scheduler and default-scheduler",id:"tidb-scheduler-and-default-scheduler",level:2},{value:"TiDB cluster scheduling requirements",id:"tidb-cluster-scheduling-requirements",level:2},{value:"PD component",id:"pd-component",level:3},{value:"TiKV component",id:"tikv-component",level:3},{value:"How TiDB Scheduler works",id:"how-tidb-scheduler-works",level:2}],p={toc:c};function h(e){var t=e.components,o=(0,a.Z)(e,i);return(0,l.kt)("wrapper",(0,r.Z)({},p,o,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"tidb-scheduler"},"TiDB Scheduler"),(0,l.kt)("p",null,"TiDB Scheduler is a TiDB implementation of ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/community/blob/master/contributors/design-proposals/scheduling/scheduler_extender.md"},"Kubernetes scheduler extender"),". TiDB Scheduler is used to add new scheduling rules to Kubernetes. This document introduces these new scheduling rules and how TiDB Scheduler works."),(0,l.kt)("h2",{id:"tidb-scheduler-and-default-scheduler"},"tidb-scheduler and default-scheduler"),(0,l.kt)("p",null,"A ",(0,l.kt)("a",{parentName:"p",href:"https://kubernetes.io/zh/docs/concepts/scheduling-eviction/kube-scheduler/"},"kube-scheduler")," is deployed by default in the Kubernetes cluster for Pod scheduling. The default scheduler name is ",(0,l.kt)("inlineCode",{parentName:"p"},"default-scheduler"),"."),(0,l.kt)("p",null,"In the early Kubernetes versions (< v1.16), the ",(0,l.kt)("inlineCode",{parentName:"p"},"default-scheduler")," was not flexible enough to support even scheduling for Pods. Therefore, to support even scheduling for the TiDB cluster Pods, TiDB Operator uses a TiDB Scheduler (",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-scheduler"),") to extend the scheduling rules of the ",(0,l.kt)("inlineCode",{parentName:"p"},"default-scheduler"),"."),(0,l.kt)("p",null,"Starting from Kubernetes v1.16, the ",(0,l.kt)("inlineCode",{parentName:"p"},"default-scheduler")," has introduced the ",(0,l.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/"},(0,l.kt)("inlineCode",{parentName:"a"},"EvenPodsSpread")," feature"),". This feature controls how Pods are spread across your Kubernetes cluster among failure-domains. It is in the beta phase in v1.18, and became generally available in v1.19."),(0,l.kt)("p",null,"Therefore, if the Kubernetes cluster meets one of the following conditions, you can use ",(0,l.kt)("inlineCode",{parentName:"p"},"default-scheduler")," directly instead of ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-scheduler"),". You need to configure ",(0,l.kt)("a",{parentName:"p",href:"/docusaurus-operator/configure-a-tidb-cluster#use-topologyspreadconstraints-to-make-pods-evenly-spread"},(0,l.kt)("inlineCode",{parentName:"a"},"topologySpreadConstraints"))," to make Pods evenly spread in different topologies."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"The Kubernetes version is v1.18.x and ",(0,l.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/"},"the ",(0,l.kt)("inlineCode",{parentName:"a"},"EvenPodsSpread")," feature gate")," is enabled."),(0,l.kt)("li",{parentName:"ul"},"The Kubernetes version >= v1.19.")),(0,l.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"When you change an existing TiDB clusters from using ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-scheduler")," to using ",(0,l.kt)("inlineCode",{parentName:"p"},"default-scheduler"),", it triggers the rolling update of the TiDB clusters."))),(0,l.kt)("h2",{id:"tidb-cluster-scheduling-requirements"},"TiDB cluster scheduling requirements"),(0,l.kt)("p",null,"A TiDB cluster includes three key components: PD, TiKV, and TiDB. Each consists of multiple nodes: PD is a Raft cluster, and TiKV is a multi-Raft group cluster. PD and TiKV components are stateful. If the ",(0,l.kt)("inlineCode",{parentName:"p"},"EvenPodsSpread")," feature gate is not enabled in the Kubernetes cluster, the default scheduling rules of the Kubernetes scheduler cannot meet the high availability scheduling requirements of the TiDB cluster, so the Kubernetes scheduling rules need to be extended."),(0,l.kt)("p",null,"Currently, pods can be scheduled according to specific dimensions by modifying ",(0,l.kt)("inlineCode",{parentName:"p"},"metadata.annotations")," in TidbCluster, such as:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"metadata:\n  annotations:\n    pingcap.com/ha-topology-key: kubernetes.io/hostname\n")),(0,l.kt)("p",null,"The configuration above indicates scheduling by the node dimension (default). If you want to schedule pods by other dimensions, such as ",(0,l.kt)("inlineCode",{parentName:"p"},"pingcap.com/ha-topology-key: zone"),", which means scheduling by zone, each node should also be labeled as follows:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl label nodes node1 zone=zone1\n")),(0,l.kt)("p",null,"Different nodes may have different labels or the same label, and if a node is not labeled, the scheduler will not schedule any pod to that node."),(0,l.kt)("p",null,"TiDB Scheduler implements the following customized scheduling rules. The following example is based on node scheduling, scheduling rules based on other dimensions are the same."),(0,l.kt)("h3",{id:"pd-component"},"PD component"),(0,l.kt)("p",null,"Scheduling rule 1: Make sure that the number of PD instances scheduled on each node is less than ",(0,l.kt)("inlineCode",{parentName:"p"},"Replicas / 2"),". For example:"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"PD cluster size (Replicas)"),(0,l.kt)("th",{parentName:"tr",align:null},"Maximum number of PD instances that can be scheduled on each node"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"1"),(0,l.kt)("td",{parentName:"tr",align:null},"1")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"2"),(0,l.kt)("td",{parentName:"tr",align:null},"1")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"3"),(0,l.kt)("td",{parentName:"tr",align:null},"1")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"4"),(0,l.kt)("td",{parentName:"tr",align:null},"1")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"5"),(0,l.kt)("td",{parentName:"tr",align:null},"2")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"..."),(0,l.kt)("td",{parentName:"tr",align:null})))),(0,l.kt)("h3",{id:"tikv-component"},"TiKV component"),(0,l.kt)("p",null,"Scheduling rule 2: If the number of Kubernetes nodes is less than three (in this case, TiKV cannot achieve high availability), scheduling is not limited; otherwise, the number of TiKV instances that can be scheduled on each node is no more than ",(0,l.kt)("inlineCode",{parentName:"p"},"ceil(Replicas / 3)"),". For example:"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"TiKV cluster size (Replicas)"),(0,l.kt)("th",{parentName:"tr",align:null},"Maximum number of TiKV instances that can be scheduled on each node"),(0,l.kt)("th",{parentName:"tr",align:null},"Best scheduling distribution"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"3"),(0,l.kt)("td",{parentName:"tr",align:null},"1"),(0,l.kt)("td",{parentName:"tr",align:null},"1,1,1")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"4"),(0,l.kt)("td",{parentName:"tr",align:null},"2"),(0,l.kt)("td",{parentName:"tr",align:null},"1,1,2")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"5"),(0,l.kt)("td",{parentName:"tr",align:null},"2"),(0,l.kt)("td",{parentName:"tr",align:null},"1,2,2")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"6"),(0,l.kt)("td",{parentName:"tr",align:null},"2"),(0,l.kt)("td",{parentName:"tr",align:null},"2,2,2")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"7"),(0,l.kt)("td",{parentName:"tr",align:null},"3"),(0,l.kt)("td",{parentName:"tr",align:null},"2,2,3")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"8"),(0,l.kt)("td",{parentName:"tr",align:null},"3"),(0,l.kt)("td",{parentName:"tr",align:null},"2,3,3")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"..."),(0,l.kt)("td",{parentName:"tr",align:null}),(0,l.kt)("td",{parentName:"tr",align:null})))),(0,l.kt)("h2",{id:"how-tidb-scheduler-works"},"How TiDB Scheduler works"),(0,l.kt)("p",null,(0,l.kt)("img",{loading:"lazy",alt:"TiDB Scheduler Overview",src:n(8364).Z,width:"2524",height:"1394"})),(0,l.kt)("p",null,"TiDB Scheduler adds customized scheduling rules by implementing Kubernetes ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/community/blob/master/contributors/design-proposals/scheduling/scheduler_extender.md"},"Scheduler extender"),"."),(0,l.kt)("p",null,"The TiDB Scheduler component is deployed as one or more Pods, though only one Pod is working at the same time. Each Pod has two Containers inside: one Container is a native ",(0,l.kt)("inlineCode",{parentName:"p"},"kube-scheduler"),", and the other is a ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-scheduler")," implemented as a Kubernetes scheduler extender."),(0,l.kt)("p",null,"If you configure the cluster to use ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-scheduler")," in the ",(0,l.kt)("inlineCode",{parentName:"p"},"TidbCluster")," CR, the ",(0,l.kt)("inlineCode",{parentName:"p"},".spec.schedulerName")," attribute of PD, TiDB, and TiKV Pods created by TiDB Operator is set to ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-scheduler"),". This means that the TiDB Scheduler is used for the scheduling."),(0,l.kt)("p",null,"The scheduling process of a Pod is as follows:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"First, ",(0,l.kt)("inlineCode",{parentName:"li"},"kube-scheduler")," pulls all Pods whose ",(0,l.kt)("inlineCode",{parentName:"li"},".spec.schedulerName")," is ",(0,l.kt)("inlineCode",{parentName:"li"},"tidb-scheduler"),". And Each Pod is filtered using the default Kubernetes scheduling rules."),(0,l.kt)("li",{parentName:"ul"},"Then, ",(0,l.kt)("inlineCode",{parentName:"li"},"kube-scheduler")," sends a request to the ",(0,l.kt)("inlineCode",{parentName:"li"},"tidb-scheduler")," service. Then ",(0,l.kt)("inlineCode",{parentName:"li"},"tidb-scheduler")," filters the sent nodes through the customized scheduling rules (as mentioned above), and returns schedulable nodes to ",(0,l.kt)("inlineCode",{parentName:"li"},"kube-scheduler"),"."),(0,l.kt)("li",{parentName:"ul"},"Finally, ",(0,l.kt)("inlineCode",{parentName:"li"},"kube-scheduler")," determines the nodes to be scheduled.")),(0,l.kt)("p",null,"If a Pod cannot be scheduled, see the ",(0,l.kt)("a",{parentName:"p",href:"/docusaurus-operator/deploy-failures#the-pod-is-in-the-pending-state"},"troubleshooting document")," to diagnose and solve the issue."))}h.isMDXComponent=!0},8364:function(e,t,n){t.Z=n.p+"assets/images/tidb-scheduler-overview-4e6d1f748bb1145c597f98b9ad32a6b5.png"}}]);