"use strict";(self.webpackChunkpingcap_docs=self.webpackChunkpingcap_docs||[]).push([[3735],{3905:function(e,t,a){a.d(t,{Zo:function(){return u},kt:function(){return m}});var r=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},l=Object.keys(e);for(r=0;r<l.length;r++)a=l[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)a=l[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var p=r.createContext({}),s=function(e){var t=r.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},u=function(e){var t=s(e.components);return r.createElement(p.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},c=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,l=e.originalType,p=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),c=s(a),m=n,f=c["".concat(p,".").concat(m)]||c[m]||d[m]||l;return a?r.createElement(f,o(o({ref:t},u),{},{components:a})):r.createElement(f,o({ref:t},u))}));function m(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var l=a.length,o=new Array(l);o[0]=c;var i={};for(var p in t)hasOwnProperty.call(t,p)&&(i[p]=t[p]);i.originalType=e,i.mdxType="string"==typeof e?e:n,o[1]=i;for(var s=2;s<l;s++)o[s]=a[s];return r.createElement.apply(null,o)}return r.createElement.apply(null,a)}c.displayName="MDXCreateElement"},7394:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return i},contentTitle:function(){return p},metadata:function(){return s},assets:function(){return u},toc:function(){return d},default:function(){return m}});var r=a(7462),n=a(3366),l=(a(7294),a(3905)),o=["components"],i={title:"Maintain Different TiDB Clusters Separately Using Multiple Sets of TiDB Operator",summary:"Learn how to deploy multiple sets of TiDB Operator to manage different TiDB clusters."},p="Maintain Different TiDB Clusters Separately Using Multiple Sets of TiDB Operator",s={unversionedId:"deploy-multiple-tidb-operator",id:"deploy-multiple-tidb-operator",title:"Maintain Different TiDB Clusters Separately Using Multiple Sets of TiDB Operator",description:"You can use one set of TiDB Operator to manage multiple TiDB clusters. If you have the following application needs, you can deploy multiple sets of TiDB Operator to manage different TiDB clusters:",source:"@site/docs/deploy-multiple-tidb-operator.md",sourceDirName:".",slug:"/deploy-multiple-tidb-operator",permalink:"/docusaurus-operator/deploy-multiple-tidb-operator",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/deploy-multiple-tidb-operator.md",tags:[],version:"current",frontMatter:{title:"Maintain Different TiDB Clusters Separately Using Multiple Sets of TiDB Operator",summary:"Learn how to deploy multiple sets of TiDB Operator to manage different TiDB clusters."},sidebar:"mySidebar",previous:{title:"Pause Sync of a TiDB Cluster in Kubernetes",permalink:"/docusaurus-operator/pause-sync-of-tidb-cluster"},next:{title:"Maintain Kubernetes Nodes that Hold the TiDB Cluster",permalink:"/docusaurus-operator/maintain-a-kubernetes-node"}},u={},d=[{value:"Deploy multiple sets of TiDB Operator",id:"deploy-multiple-sets-of-tidb-operator",level:2},{value:"Related parameters",id:"related-parameters",level:2}],c={toc:d};function m(e){var t=e.components,a=(0,n.Z)(e,o);return(0,l.kt)("wrapper",(0,r.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"maintain-different-tidb-clusters-separately-using-multiple-sets-of-tidb-operator"},"Maintain Different TiDB Clusters Separately Using Multiple Sets of TiDB Operator"),(0,l.kt)("p",null,"You can use one set of TiDB Operator to manage multiple TiDB clusters. If you have the following application needs, you can deploy multiple sets of TiDB Operator to manage different TiDB clusters:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"You need to ",(0,l.kt)("a",{parentName:"li",href:"/docusaurus-operator/canary-upgrade-tidb-operator"},"perform a canary upgrade on TiDB Operator")," so that the potential issues of the new version do not affect your application."),(0,l.kt)("li",{parentName:"ul"},"Multiple TiDB clusters exist in your organization, and each cluster belongs to different teams. Each team needs to manage their own cluster.")),(0,l.kt)("p",null,"This document describes how to deploy multiple sets of TiDB Operator to manage different TiDB clusters."),(0,l.kt)("p",null,"When you use TiDB Operator, ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-scheduler")," is not mandatory. Refer to ",(0,l.kt)("a",{parentName:"p",href:"/docusaurus-operator/tidb-scheduler#tidb-scheduler-and-default-scheduler"},"tidb-scheduler and default-scheduler")," to confirm whether you need to deploy ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-scheduler"),"."),(0,l.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("ul",{parentName:"div"},(0,l.kt)("li",{parentName:"ul"},"Currently, you can only deploy multiple sets of ",(0,l.kt)("inlineCode",{parentName:"li"},"tidb-controller-manager")," and ",(0,l.kt)("inlineCode",{parentName:"li"},"tidb-scheduler"),". Deploying multiple sets of AdvancedStatefulSet controller and ",(0,l.kt)("inlineCode",{parentName:"li"},"tidb-admission-webhook")," is not supported."),(0,l.kt)("li",{parentName:"ul"},"If you have deployed multiple sets of TiDB Operator and only some of them enable ",(0,l.kt)("a",{parentName:"li",href:"/docusaurus-operator/advanced-statefulset"},"Advanced StatefulSet"),", the same TidbCluster Custom Resource (CR) cannot be switched among these TiDB Operator."),(0,l.kt)("li",{parentName:"ul"},"This feature is supported since v1.1.10.")))),(0,l.kt)("h2",{id:"deploy-multiple-sets-of-tidb-operator"},"Deploy multiple sets of TiDB Operator"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Deploy the first set of TiDB Operator."),(0,l.kt)("p",{parentName:"li"},"Refer to ",(0,l.kt)("a",{parentName:"p",href:"/docusaurus-operator/deploy-tidb-operator#customize-tidb-operator"},"Deploy TiDB Operator - Customize TiDB Operator")," to deploy the first set of TiDB Operator. Add the following configuration in the ",(0,l.kt)("inlineCode",{parentName:"p"},"values.yaml"),":"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"controllerManager:\n  selector:\n  - user=dev\n"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Deploy the first TiDB cluster."),(0,l.kt)("ol",{parentName:"li"},(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Refer to ",(0,l.kt)("a",{parentName:"p",href:"/docusaurus-operator/configure-a-tidb-cluster#configure-tidb-deployment"},"Configure the TiDB Cluster - Configure TiDB deployment")," to configure the TidbCluster CR, and configure ",(0,l.kt)("inlineCode",{parentName:"p"},"labels")," to match the ",(0,l.kt)("inlineCode",{parentName:"p"},"selector")," set in the last step. For example:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: pingcap.com/v1alpha1\nkind: TidbCluster\nmetadata:\n  name: basic1\n  labels:\n    user: dev\nspec:\n  ...\n")),(0,l.kt)("p",{parentName:"li"},"If ",(0,l.kt)("inlineCode",{parentName:"p"},"labels")," is not set when you deploy the TiDB cluster, you can configure ",(0,l.kt)("inlineCode",{parentName:"p"},"labels")," by running the following command:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl -n ${namespace} label tidbcluster ${cluster_name} user=dev\n"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Refer to ",(0,l.kt)("a",{parentName:"p",href:"/docusaurus-operator/deploy-on-general-kubernetes"},"Deploy TiDB in General Kubernetes")," to deploy the TiDB cluster. Confirm that each component in the cluster is started normally.")))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Deploy the second set of TiDB Operator."),(0,l.kt)("p",{parentName:"li"},"Refer to ",(0,l.kt)("a",{parentName:"p",href:"/docusaurus-operator/deploy-tidb-operator"},"Deploy TiDB Operator")," to deploy the second set of TiDB Operator without ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-scheduler"),". Add the following configuration in the ",(0,l.kt)("inlineCode",{parentName:"p"},"values.yaml")," file, and deploy the second TiDB Operator (without ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-scheduler"),") in ",(0,l.kt)("strong",{parentName:"p"},"a different namespace")," (such as ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-admin-qa"),") with a ",(0,l.kt)("strong",{parentName:"p"},"different ",(0,l.kt)("a",{parentName:"strong",href:"https://helm.sh/docs/intro/using_helm/#three-big-concepts"},"Helm Release Name"))," (such as ",(0,l.kt)("inlineCode",{parentName:"p"},"helm install tidb-operator-qa ..."),"):"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"controllerManager:\n  selector:\n  - user=qa\nappendReleaseSuffix: true\nscheduler:\n  # If you do not need tidb-scheduler, set this value to false.\n  create: false\nadvancedStatefulset:\n  create: false\nadmissionWebhook:\n  create: false\n")),(0,l.kt)("blockquote",{parentName:"li"},(0,l.kt)("p",{parentName:"blockquote"},(0,l.kt)("strong",{parentName:"p"},"Note:")),(0,l.kt)("ul",{parentName:"blockquote"},(0,l.kt)("li",{parentName:"ul"},"It is recommended to deploy the new TiDB Operator in a separate namespace."),(0,l.kt)("li",{parentName:"ul"},"Set ",(0,l.kt)("inlineCode",{parentName:"li"},"appendReleaseSuffix")," to ",(0,l.kt)("inlineCode",{parentName:"li"},"true"),"."),(0,l.kt)("li",{parentName:"ul"},"If you configure ",(0,l.kt)("inlineCode",{parentName:"li"},"scheduler.create: true"),", a ",(0,l.kt)("inlineCode",{parentName:"li"},"tidb-scheduler")," named ",(0,l.kt)("inlineCode",{parentName:"li"},"{{ .scheduler.schedulerName }}-{{.Release.Name}}")," is created. To use this ",(0,l.kt)("inlineCode",{parentName:"li"},"tidb-scheduler"),", you need to configure ",(0,l.kt)("inlineCode",{parentName:"li"},"spec.schedulerName")," in the ",(0,l.kt)("inlineCode",{parentName:"li"},"TidbCluster")," CR to the name of this scheduler."),(0,l.kt)("li",{parentName:"ul"},"You need to set ",(0,l.kt)("inlineCode",{parentName:"li"},"advancedStatefulset.create: false")," and ",(0,l.kt)("inlineCode",{parentName:"li"},"admissionWebhook.create: false"),", because deploying multiple sets of AdvancedStatefulSet controller and ",(0,l.kt)("inlineCode",{parentName:"li"},"tidb-admission-webhook")," is not supported.")))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Deploy the second TiDB cluster."),(0,l.kt)("ol",{parentName:"li"},(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Refer to ",(0,l.kt)("a",{parentName:"p",href:"/docusaurus-operator/configure-a-tidb-cluster"},"Configure the TiDB Cluster")," to configure the TidbCluster CR, and configure ",(0,l.kt)("inlineCode",{parentName:"p"},"labels")," to match the ",(0,l.kt)("inlineCode",{parentName:"p"},"selector")," set in the last step. For example:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: pingcap.com/v1alpha1\nkind: TidbCluster\nmetadata:\n  name: basic2\n  labels:\n    user: qa\nspec:\n  ...\n")),(0,l.kt)("p",{parentName:"li"},"If ",(0,l.kt)("inlineCode",{parentName:"p"},"labels")," is not set when you deploy the TiDB cluster, you can configure ",(0,l.kt)("inlineCode",{parentName:"p"},"labels")," by running the following command:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl -n ${namespace} label tidbcluster ${cluster_name} user=qa\n"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Refer to ",(0,l.kt)("a",{parentName:"p",href:"/docusaurus-operator/deploy-on-general-kubernetes"},"Deploy TiDB in General Kubernetes")," to deploy the TiDB cluster. Confirm that each component in the cluster is started normally.")))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"View the logs of the two sets of TiDB Operator, and confirm that each TiDB Operator manages the TiDB cluster that matches the corresponding selectors."),(0,l.kt)("p",{parentName:"li"},"For example:"),(0,l.kt)("p",{parentName:"li"},"View the log of ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-controller-manager")," of the first TiDB Operator:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl -n tidb-admin logs tidb-controller-manager-55b887bdc9-lzdwv\n")),(0,l.kt)("details",null,(0,l.kt)("summary",null,"Output"),(0,l.kt)("pre",null,(0,l.kt)("code",null,'... I0113 02:50:13.195779       1 main.go:69] FLAG: --selector="user=dev" ... I0113 02:50:32.409378       1 tidbcluster_control.go:69] TidbCluster: [tidb-cluster-1/basic1] updated successfully I0113 02:50:32.773635       1 tidbcluster_control.go:69] TidbCluster: [tidb-cluster-1/basic1] updated successfully I0113 02:51:00.294241       1 tidbcluster_control.go:69] TidbCluster: [tidb-cluster-1/basic1] updated successfully'))),(0,l.kt)("p",{parentName:"li"},"View the log of ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-controller-manager")," of the second TiDB Operator:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl -n tidb-admin-qa logs tidb-controller-manager-qa-5dfcd7f9-vll4c\n")),(0,l.kt)("details",null,(0,l.kt)("summary",null,"Output"),(0,l.kt)("pre",null,(0,l.kt)("code",null,'... I0113 02:50:13.195779       1 main.go:69] FLAG: --selector="user=qa" ... I0113 03:38:43.859387       1 tidbcluster_control.go:69] TidbCluster: [tidb-cluster-2/basic2] updated successfully I0113 03:38:45.060028       1 tidbcluster_control.go:69] TidbCluster: [tidb-cluster-2/basic2] updated successfully I0113 03:38:46.261045       1 tidbcluster_control.go:69] TidbCluster: [tidb-cluster-2/basic2] updated successfully'))),(0,l.kt)("p",{parentName:"li"},"By comparing the logs of the two sets of TiDB Operator, you can confirm that the first TiDB Operator only manages the ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-cluster-1/basic1")," cluster, and the second TiDB Operator only manages the ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-cluster-2/basic2")," cluster."))),(0,l.kt)("p",null,"If you want to deploy a third or more sets of TiDB Operator, repeat step 3, step 4, and step 5."),(0,l.kt)("h2",{id:"related-parameters"},"Related parameters"),(0,l.kt)("p",null,"In the ",(0,l.kt)("inlineCode",{parentName:"p"},"values.yaml")," file in the ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-operator")," chart, the following parameters are related to the deployment of multiple sets of TiDB Operator:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("inlineCode",{parentName:"p"},"appendReleaseSuffix")),(0,l.kt)("p",{parentName:"li"},"  If this parameter is set to ",(0,l.kt)("inlineCode",{parentName:"p"},"true"),", when you deploy TiDB Operator, the Helm chart automatically adds a suffix (",(0,l.kt)("inlineCode",{parentName:"p"},"-{{ .Release.Name }}"),") to the name of resources related to ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-controller-manager")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-scheduler"),"."),(0,l.kt)("p",{parentName:"li"},"  For example, if you execute ",(0,l.kt)("inlineCode",{parentName:"p"},"helm install canary pingcap/tidb-operator ..."),", the name of the ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-controller-manager")," deployment is ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-controller-manager-canary"),"."),(0,l.kt)("p",{parentName:"li"},"  If you need to deploy multiple sets of TiDB Operator, set this parameter to ",(0,l.kt)("inlineCode",{parentName:"p"},"true"),"."),(0,l.kt)("p",{parentName:"li"},"  Default value: ",(0,l.kt)("inlineCode",{parentName:"p"},"false"),".")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("inlineCode",{parentName:"p"},"controllerManager.create")),(0,l.kt)("p",{parentName:"li"},"  Controls whether to create ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-controller-manager"),"."),(0,l.kt)("p",{parentName:"li"},"  Default value: ",(0,l.kt)("inlineCode",{parentName:"p"},"true"),".")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("inlineCode",{parentName:"p"},"controllerManager.selector")),(0,l.kt)("p",{parentName:"li"},"  Sets the ",(0,l.kt)("inlineCode",{parentName:"p"},"-selector")," parameter for ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-controller-manager"),". The parameter is used to filter the CRs controlled by ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-controller-manager")," according to the CR labels. If multiple selectors exist, the selectors are in ",(0,l.kt)("inlineCode",{parentName:"p"},"and")," relationship."),(0,l.kt)("p",{parentName:"li"},"  Default value: ",(0,l.kt)("inlineCode",{parentName:"p"},"[]")," (",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-controller-manager")," controls all CRs)."),(0,l.kt)("p",{parentName:"li"},"  Example:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"selector:\n- canary-release=v1\n- k1==v1\n- k2!=v2\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("inlineCode",{parentName:"p"},"scheduler.create")),(0,l.kt)("p",{parentName:"li"},"  Controls whether to create ",(0,l.kt)("inlineCode",{parentName:"p"},"tidb-scheduler"),"."),(0,l.kt)("p",{parentName:"li"},"  Default value: ",(0,l.kt)("inlineCode",{parentName:"p"},"true"),"."))))}m.isMDXComponent=!0}}]);