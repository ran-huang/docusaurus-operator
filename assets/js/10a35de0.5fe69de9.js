"use strict";(self.webpackChunkpingcap_docs=self.webpackChunkpingcap_docs||[]).push([[8821],{3905:function(e,t,r){r.d(t,{Zo:function(){return c},kt:function(){return m}});var a=r(7294);function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function s(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function i(e,t){if(null==e)return{};var r,a,n=function(e,t){if(null==e)return{};var r,a,n={},o=Object.keys(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var p=a.createContext({}),l=function(e){var t=a.useContext(p),r=t;return e&&(r="function"==typeof e?e(t):s(s({},t),e)),r},c=function(e){var t=l(e.components);return a.createElement(p.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var r=e.components,n=e.mdxType,o=e.originalType,p=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),u=l(r),m=n,h=u["".concat(p,".").concat(m)]||u[m]||d[m]||o;return r?a.createElement(h,s(s({ref:t},c),{},{components:r})):a.createElement(h,s({ref:t},c))}));function m(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=r.length,s=new Array(o);s[0]=u;var i={};for(var p in t)hasOwnProperty.call(t,p)&&(i[p]=t[p]);i.originalType=e,i.mdxType="string"==typeof e?e:n,s[1]=i;for(var l=2;l<o;l++)s[l]=r[l];return a.createElement.apply(null,s)}return a.createElement.apply(null,r)}u.displayName="MDXCreateElement"},6478:function(e,t,r){r.r(t),r.d(t,{frontMatter:function(){return i},contentTitle:function(){return p},metadata:function(){return l},assets:function(){return c},toc:function(){return d},default:function(){return m}});var a=r(7462),n=r(3366),o=(r(7294),r(3905)),s=["components"],i={title:"Restore Data from GCS",summary:"Learn how to restore the backup data from GCS."},p="Restore Data from GCS",l={unversionedId:"restore-from-gcs",id:"restore-from-gcs",title:"Restore Data from GCS",description:"This document describes how to restore the TiDB cluster data backed up using TiDB Operator in Kubernetes.",source:"@site/docs/restore-from-gcs.md",sourceDirName:".",slug:"/restore-from-gcs",permalink:"/docusaurus-operator/restore-from-gcs",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/restore-from-gcs.md",tags:[],version:"current",frontMatter:{title:"Restore Data from GCS",summary:"Learn how to restore the backup data from GCS."},sidebar:"mySidebar",previous:{title:"Back up Data to GCS Using Dumpling",permalink:"/docusaurus-operator/backup-to-gcs"},next:{title:"Back up Data to PV",permalink:"/docusaurus-operator/backup-to-pv-using-br"}},c={},d=[{value:"User scenarios",id:"user-scenarios",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Prepare the restore environment",id:"prepare-the-restore-environment",level:3},{value:"Get the required database account privileges",id:"get-the-required-database-account-privileges",level:3},{value:"Restore process",id:"restore-process",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2}],u={toc:d};function m(e){var t=e.components,r=(0,n.Z)(e,s);return(0,o.kt)("wrapper",(0,a.Z)({},u,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"restore-data-from-gcs"},"Restore Data from GCS"),(0,o.kt)("p",null,"This document describes how to restore the TiDB cluster data backed up using TiDB Operator in Kubernetes."),(0,o.kt)("p",null,"The restore method described in this document is implemented based on CustomResourceDefinition (CRD) in TiDB Operator v1.1 or later versions. For the underlying implementation, ",(0,o.kt)("a",{parentName:"p",href:"https://docs.pingcap.com/tidb/stable/tidb-lightning-backends#tidb-lightning-tidb-backend"},"TiDB Lightning TiDB-backend")," is used to perform the restore."),(0,o.kt)("p",null,"TiDB Lightning is a tool used for fast full import of large amounts of data into a TiDB cluster. It reads data from local disks, Google Cloud Storage (GCS) or Amazon S3. TiDB Lightning supports three backends: ",(0,o.kt)("inlineCode",{parentName:"p"},"Importer-backend"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"Local-backend"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"TiDB-backend"),". In this document, ",(0,o.kt)("inlineCode",{parentName:"p"},"TiDB-backend")," is used. For the differences of these backends and how to choose backends, see ",(0,o.kt)("a",{parentName:"p",href:"https://docs.pingcap.com/tidb/stable/tidb-lightning-backends"},"TiDB Lightning Backends"),". To import data using ",(0,o.kt)("inlineCode",{parentName:"p"},"Importer-backend")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"Local-backend"),", see ",(0,o.kt)("a",{parentName:"p",href:"/docusaurus-operator/restore-data-using-tidb-lightning"},"Import Data"),"."),(0,o.kt)("p",null,"This document shows an example in which the backup data stored in the specified path on ",(0,o.kt)("a",{parentName:"p",href:"https://cloud.google.com/storage/docs/"},"GCS")," is restored to the TiDB cluster."),(0,o.kt)("h2",{id:"user-scenarios"},"User scenarios"),(0,o.kt)("p",null,"You can use the restore solution introduced in this document if you need to export the backup data from GCS to a TiDB cluster, with the following requirements:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"To restore data with lower resource usage and lower network bandwidth usage. A restore speed of 50 GB/h is acceptable."),(0,o.kt)("li",{parentName:"ul"},"To import data into the cluster with ACID compliance."),(0,o.kt)("li",{parentName:"ul"},"The TiDB cluster can still provide services during the restore process.")),(0,o.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,o.kt)("p",null,"Before you perform the data restore, you need to prepare the restore environment and get the required database account privileges."),(0,o.kt)("h3",{id:"prepare-the-restore-environment"},"Prepare the restore environment"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Download ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/pingcap/tidb-operator/blob/v1.2.0/manifests/backup/backup-rbac.yaml"},(0,o.kt)("inlineCode",{parentName:"a"},"backup-rbac.yaml"))," and execute the following command to create the role-based access control (RBAC) resources in the ",(0,o.kt)("inlineCode",{parentName:"p"},"test2")," namespace:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f backup-rbac.yaml -n test2\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Grant permissions to the remote storage."),(0,o.kt)("p",{parentName:"li"},"Refer to ",(0,o.kt)("a",{parentName:"p",href:"/docusaurus-operator/grant-permissions-to-remote-storage#gcs-account-permissions"},"GCS account permissions"),".")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Create the ",(0,o.kt)("inlineCode",{parentName:"p"},"restore-demo2-tidb-secret")," secret which stores the root account and password needed to access the TiDB cluster:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl create secret generic restore-demo2-tidb-secret --from-literal=user=root --from-literal=password=${password} --namespace=test2\n")))),(0,o.kt)("h3",{id:"get-the-required-database-account-privileges"},"Get the required database account privileges"),(0,o.kt)("p",null,"Before you use TiDB Lightning to restore the backup data in GCS to the TiDB cluster, make sure that you have the following database account privileges:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:"left"},"Privileges"),(0,o.kt)("th",{parentName:"tr",align:"left"},"Scope"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},"SELECT"),(0,o.kt)("td",{parentName:"tr",align:"left"},"Tables")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},"INSERT"),(0,o.kt)("td",{parentName:"tr",align:"left"},"Tables")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},"UPDATE"),(0,o.kt)("td",{parentName:"tr",align:"left"},"Tables")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},"DELETE"),(0,o.kt)("td",{parentName:"tr",align:"left"},"Tables")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},"CREATE"),(0,o.kt)("td",{parentName:"tr",align:"left"},"Databases, tables")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},"DROP"),(0,o.kt)("td",{parentName:"tr",align:"left"},"Databases, tables")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},"ALTER"),(0,o.kt)("td",{parentName:"tr",align:"left"},"Tables")))),(0,o.kt)("h2",{id:"restore-process"},"Restore process"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Create the restore custom resource (CR) and restore the backup data to the TiDB cluster:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f restore.yaml\n")),(0,o.kt)("p",{parentName:"li"},"The ",(0,o.kt)("inlineCode",{parentName:"p"},"restore.yaml")," file has the following content:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"---\napiVersion: pingcap.com/v1alpha1\nkind: Restore\nmetadata:\n  name: demo2-restore\n  namespace: test2\nspec:\n  to:\n    host: ${tidb_host}\n    port: ${tidb_port}\n    user: ${tidb_user}\n    secretName: restore-demo2-tidb-secret\n  gcs:\n    projectId: ${project_id}\n    secretName: gcs-secret\n    path: gcs://${backup_path}\n  # storageClassName: local-storage\n  storageSize: 1Gi\n")),(0,o.kt)("p",{parentName:"li"},"The example above restores data from the ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.gcs.path")," path on GCS to the ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.to.host")," TiDB cluster. For more information about GCS configuration, refer to ",(0,o.kt)("a",{parentName:"p",href:"/docusaurus-operator/backup-restore-overview#gcs-fields"},"GCS fields"),"."),(0,o.kt)("p",{parentName:"li"},"For more information about the ",(0,o.kt)("inlineCode",{parentName:"p"},"Restore")," CR fields, refer to ",(0,o.kt)("a",{parentName:"p",href:"/docusaurus-operator/backup-restore-overview#restore-cr-fields"},"Restore CR fields"),".")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"After creating the ",(0,o.kt)("inlineCode",{parentName:"p"},"Restore")," CR, execute the following command to check the restore status:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get rt -n test2 -owide\n")))),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"TiDB Operator creates a PVC for data recovery. The backup data is downloaded from the remote storage to the PV first, and then restored. If you want to delete this PVC after the recovery is completed, you can refer to ",(0,o.kt)("a",{parentName:"p",href:"/docusaurus-operator/cheat-sheet#delete-resources"},"Delete Resource")," to delete the recovery Pod first, and then delete the PVC."))),(0,o.kt)("h2",{id:"troubleshooting"},"Troubleshooting"),(0,o.kt)("p",null,"If you encounter any problem during the restore process, refer to ",(0,o.kt)("a",{parentName:"p",href:"/docusaurus-operator/deploy-failures"},"Common Deployment Failures"),"."))}m.isMDXComponent=!0}}]);