"use strict";(self.webpackChunkpingcap_docs=self.webpackChunkpingcap_docs||[]).push([[3995],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return h}});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=c(n),h=o,d=m["".concat(l,".").concat(h)]||m[h]||u[h]||a;return n?r.createElement(d,i(i({ref:t},p),{},{components:n})):r.createElement(d,i({ref:t},p))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,i=new Array(a);i[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var c=2;c<a;c++)i[c]=n[c];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},6322:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return c},assets:function(){return p},toc:function(){return u},default:function(){return h}});var r=n(7462),o=n(3366),a=(n(7294),n(3905)),i=["components"],s={title:"Common Network Issues of TiDB in Kubernetes",summary:"Learn the common network issues of TiDB in Kubernetes and their solutions."},l="Common Network Issues of TiDB in Kubernetes",c={unversionedId:"network-issues",id:"network-issues",title:"Common Network Issues of TiDB in Kubernetes",description:"This document describes the common network issues of TiDB in Kubernetes and their solutions.",source:"@site/docs/network-issues.md",sourceDirName:".",slug:"/network-issues",permalink:"/docusaurus-operator/network-issues",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/network-issues.md",tags:[],version:"current",frontMatter:{title:"Common Network Issues of TiDB in Kubernetes",summary:"Learn the common network issues of TiDB in Kubernetes and their solutions."},sidebar:"mySidebar",previous:{title:"Common Cluster Exceptions of TiDB in Kubernetes",permalink:"/docusaurus-operator/exceptions"},next:{title:"TiDB FAQs in Kubernetes",permalink:"/docusaurus-operator/faq"}},p={},u=[{value:"Network connection failure between Pods",id:"network-connection-failure-between-pods",level:2},{value:"Unable to access the TiDB service",id:"unable-to-access-the-tidb-service",level:2}],m={toc:u};function h(e){var t=e.components,n=(0,o.Z)(e,i);return(0,a.kt)("wrapper",(0,r.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"common-network-issues-of-tidb-in-kubernetes"},"Common Network Issues of TiDB in Kubernetes"),(0,a.kt)("p",null,"This document describes the common network issues of TiDB in Kubernetes and their solutions."),(0,a.kt)("h2",{id:"network-connection-failure-between-pods"},"Network connection failure between Pods"),(0,a.kt)("p",null,"In a TiDB cluster, you can access most Pods by using the Pod's domain name (allocated by the Headless Service). The exception is when TiDB Operator collects the cluster information or issues control commands, it accesses the PD (Placement Driver) cluster using the ",(0,a.kt)("inlineCode",{parentName:"p"},"service-name")," of the PD service."),(0,a.kt)("p",null,"When you find some network connection issues among Pods from the log or monitoring metrics, or when you find the network connection among Pods might be abnormal according to the problematic condition, follow the following process to diagnose and narrow down the problem:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Confirm that the endpoints of the Service and Headless Service are normal:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl -n ${namespace} get endpoints ${cluster_name}-pd\nkubectl -n ${namespace} get endpoints ${cluster_name}-tidb\nkubectl -n ${namespace} get endpoints ${cluster_name}-pd-peer\nkubectl -n ${namespace} get endpoints ${cluster_name}-tikv-peer\nkubectl -n ${namespace} get endpoints ${cluster_name}-tidb-peer\n")),(0,a.kt)("p",{parentName:"li"},"The ",(0,a.kt)("inlineCode",{parentName:"p"},"ENDPOINTS")," field shown in the above command must be a comma-separated list of ",(0,a.kt)("inlineCode",{parentName:"p"},"cluster_ip:port"),". If the field is empty or incorrect, check the health of the Pod and whether ",(0,a.kt)("inlineCode",{parentName:"p"},"kube-controller-manager")," is working properly.")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Enter the Pod's Network Namespace to diagnose network problems:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"tkctl debug -n ${namespace} ${pod_name}\n")),(0,a.kt)("p",{parentName:"li"},"After the remote shell is started, use the ",(0,a.kt)("inlineCode",{parentName:"p"},"dig")," command to diagnose the DNS resolution. If the DNS resolution is abnormal, refer to ",(0,a.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/administer-cluster/dns-debugging-resolution/"},"Debugging DNS Resolution")," for troubleshooting."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"dig ${HOSTNAME}\n")),(0,a.kt)("p",{parentName:"li"},"Use the ",(0,a.kt)("inlineCode",{parentName:"p"},"ping")," command to diagnose the connection with the destination IP (the Pod IP resolved using ",(0,a.kt)("inlineCode",{parentName:"p"},"dig"),"):"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"ping ${TARGET_IP}\n")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"If the ",(0,a.kt)("inlineCode",{parentName:"p"},"ping")," check fails, refer to ",(0,a.kt)("a",{parentName:"p",href:"https://www.praqma.com/stories/debugging-kubernetes-networking/"},"Debugging Kubernetes Networking")," for troubleshooting.")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"If the ",(0,a.kt)("inlineCode",{parentName:"p"},"ping")," check succeeds, continue to check whether the target port is open by using ",(0,a.kt)("inlineCode",{parentName:"p"},"telnet"),":"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"telnet ${TARGET_IP} ${TARGET_PORT}\n")),(0,a.kt)("p",{parentName:"li"},"  If the ",(0,a.kt)("inlineCode",{parentName:"p"},"telnet")," check fails, check whether the port corresponding to the Pod is correctly exposed and whether the port of the application is correctly configured:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"# Checks whether the ports are consistent.\nkubectl -n ${namespace} get po ${pod_name} -ojson | jq '.spec.containers[].ports[].containerPort'\n\n# Checks whether the application is correctly configured to serve the specified port.\n# The default port of PD is 2379 when not configured.\nkubectl -n ${namespace} -it exec ${pod_name} -- cat /etc/pd/pd.toml | grep client-urls\n# The default port of PD is 20160 when not configured.\nkubectl -n ${namespace} -it exec ${pod_name} -- cat /etc/tikv/tikv.toml | grep addr\n# The default port of TiDB is 4000 when not configured.\nkubectl -n ${namespace} -it exec ${pod_name} -- cat /etc/tidb/tidb.toml | grep port\n")))))),(0,a.kt)("h2",{id:"unable-to-access-the-tidb-service"},"Unable to access the TiDB service"),(0,a.kt)("p",null,"If you cannot access the TiDB service, first check whether the TiDB service is deployed successfully using the following method:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Check whether all components of the cluster are up and the status of each component is ",(0,a.kt)("inlineCode",{parentName:"p"},"Running"),"."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get po -n ${namespace}\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Check whether the TiDB service correctly generates the endpoint object:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get endpoints -n ${namespaces} ${cluster_name}-tidb\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Check the log of TiDB components to see whether errors are reported."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl logs -f ${pod_name} -n ${namespace} -c tidb\n")))),(0,a.kt)("p",null,"If the cluster is successfully deployed, check the network using the following steps:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"If you cannot access the TiDB service using ",(0,a.kt)("inlineCode",{parentName:"p"},"NodePort"),", try to access the TiDB service using the ",(0,a.kt)("inlineCode",{parentName:"p"},"clusterIP")," on the node. If the ",(0,a.kt)("inlineCode",{parentName:"p"},"clusterIP")," works, the network within the Kubernetes cluster is normal. Then the possible issues are as follows:"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Network failure exists between the client and the node."),(0,a.kt)("li",{parentName:"ul"},"Check whether the ",(0,a.kt)("inlineCode",{parentName:"li"},"externalTrafficPolicy")," attribute of the TiDB service is ",(0,a.kt)("inlineCode",{parentName:"li"},"Local"),". If it is ",(0,a.kt)("inlineCode",{parentName:"li"},"Local"),", you must access the client using the IP of the node where the TiDB Pod is located."))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"If you still cannot access the TiDB service using the ",(0,a.kt)("inlineCode",{parentName:"p"},"clusterIP"),", connect using ",(0,a.kt)("inlineCode",{parentName:"p"},"<PodIP>:4000")," on the TiDB service backend. If the ",(0,a.kt)("inlineCode",{parentName:"p"},"PodIP")," works, you can confirm that the problem is in the connection between ",(0,a.kt)("inlineCode",{parentName:"p"},"clusterIP")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"PodIP"),". Check the following items:"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Check whether ",(0,a.kt)("inlineCode",{parentName:"p"},"kube-proxy")," on each node is working."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get po -n kube-system -l k8s-app=kube-proxy\n"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Check whether the TiDB service rule is correct in the ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," rules."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"iptables-save -t nat |grep ${clusterIP}\n"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Check whether the corresponding endpoint is correct:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get endpoints -n ${namespaces} ${cluster_name}-tidb\n"))))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"If you cannot access the TiDB service even using ",(0,a.kt)("inlineCode",{parentName:"p"},"PodIP"),", the problem is on the Pod level network. Check the following items:"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Check whether the relevant route rules on the node are correct."),(0,a.kt)("li",{parentName:"ul"},"Check whether the network plugin service works well."),(0,a.kt)("li",{parentName:"ul"},"Refer to ",(0,a.kt)("a",{parentName:"li",href:"#network-connection-failure-between-pods"},"network connection failure between Pods")," section.")))))}h.isMDXComponent=!0}}]);