"use strict";(self.webpackChunkpingcap_docs=self.webpackChunkpingcap_docs||[]).push([[331],{3905:function(e,t,a){a.d(t,{Zo:function(){return c},kt:function(){return u}});var n=a(7294);function l(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){l(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,l=function(e,t){if(null==e)return{};var a,n,l={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(l[a]=e[a]);return l}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(l[a]=e[a])}return l}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,l=e.mdxType,i=e.originalType,s=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),d=p(a),u=l,h=d["".concat(s,".").concat(u)]||d[u]||m[u]||i;return a?n.createElement(h,r(r({ref:t},c),{},{components:a})):n.createElement(h,r({ref:t},c))}));function u(e,t){var a=arguments,l=t&&t.mdxType;if("string"==typeof e||l){var i=a.length,r=new Array(i);r[0]=d;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:l,r[1]=o;for(var p=2;p<i;p++)r[p]=a[p];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},3190:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return o},contentTitle:function(){return s},metadata:function(){return p},assets:function(){return c},toc:function(){return m},default:function(){return u}});var n=a(7462),l=a(3366),i=(a(7294),a(3905)),r=["components"],o={title:"Deploy the HTAP Storage Engine Tiflash for an Existing TiDB Cluster",summary:"Learn how to deploy TiFlash, the TiDB HTAP storage engine, on Kubernetes for an existing TiDB cluster."},s="Deploy the HTAP Storage Engine Tiflash for an Existing TiDB Cluster",p={unversionedId:"deploy-tiflash",id:"deploy-tiflash",title:"Deploy the HTAP Storage Engine Tiflash for an Existing TiDB Cluster",description:"This document describes how to add or remove the TiDB HTAP storage engine TiFlash for an existing TiDB cluster in Kubernetes. As a columnar storage extension of TiKV, TiFlash provides both good isolation level and strong consistency guarantee.",source:"@site/docs/deploy-tiflash.md",sourceDirName:".",slug:"/deploy-tiflash",permalink:"/docusaurus-operator/deploy-tiflash",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/deploy-tiflash.md",tags:[],version:"current",frontMatter:{title:"Deploy the HTAP Storage Engine Tiflash for an Existing TiDB Cluster",summary:"Learn how to deploy TiFlash, the TiDB HTAP storage engine, on Kubernetes for an existing TiDB cluster."},sidebar:"mySidebar",previous:{title:"Deploy a TiDB Cluster on ARM64 Machines",permalink:"/docusaurus-operator/deploy-cluster-on-arm64"},next:{title:"Build Multiple Interconnected AWS EKS Clusters",permalink:"/docusaurus-operator/build-multi-aws-eks"}},c={},m=[{value:"User scenarios",id:"user-scenarios",level:2},{value:"Deploy TiFlash",id:"deploy-tiflash",level:2},{value:"Adding PVs to TiFlash",id:"adding-pvs-to-tiflash",level:2},{value:"Remove TiFlash",id:"remove-tiflash",level:2}],d={toc:m};function u(e){var t=e.components,a=(0,l.Z)(e,r);return(0,i.kt)("wrapper",(0,n.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"deploy-the-htap-storage-engine-tiflash-for-an-existing-tidb-cluster"},"Deploy the HTAP Storage Engine Tiflash for an Existing TiDB Cluster"),(0,i.kt)("p",null,"This document describes how to add or remove the TiDB HTAP storage engine TiFlash for an existing TiDB cluster in Kubernetes. As a columnar storage extension of TiKV, TiFlash provides both good isolation level and strong consistency guarantee."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"If a TiDB cluster has not been deployed yet, instead of referring to this document, you can ",(0,i.kt)("a",{parentName:"p",href:"/docusaurus-operator/configure-a-tidb-cluster"},"configure a TiDB cluster in Kubernetes")," with the TiFlash-related parameters, and then ",(0,i.kt)("a",{parentName:"p",href:"/docusaurus-operator/deploy-on-general-kubernetes"},"deploy the TiDB cluster"),"."))),(0,i.kt)("h2",{id:"user-scenarios"},"User scenarios"),(0,i.kt)("p",null,"This document is applicable to scenarios in which you already have a TiDB cluster and need to use TiDB HTAP capabilities by deploying TiFlash, such as the following:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Hybrid workload scenarios with online real-time analytic processing"),(0,i.kt)("li",{parentName:"ul"},"Real-time stream processing scenarios"),(0,i.kt)("li",{parentName:"ul"},"Data hub scenarios")),(0,i.kt)("h2",{id:"deploy-tiflash"},"Deploy TiFlash"),(0,i.kt)("p",null,"If you need to deploy TiFlash for an existing TiDB cluster, do the following:"),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"If your server does not have an external network, you can download the required Docker image on the machine with an external network, upload the Docker image to your server, and then use ",(0,i.kt)("inlineCode",{parentName:"p"},"docker load")," to install the Docker image on the server. For details, see ",(0,i.kt)("a",{parentName:"p",href:"/docusaurus-operator/deploy-on-general-kubernetes#deploy-the-tidb-cluster"},"deploy the TiDB cluster"),"."))),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Edit the ",(0,i.kt)("inlineCode",{parentName:"p"},"TidbCluster")," Custom Resource (CR):"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl eidt tc ${cluster_name} -n ${namespace}\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add the TiFlash configuration as the following example:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"spec:\ntiflash:\n    # To deploy the enterprise edition of TiFlash, change the value of `baseImage` to `pingcap/tiflash-enterprise`.\n    baseImage: pingcap/tiflash\n    maxFailoverCount: 0\n    replicas: 1\n    storageClaims:\n    - resources:\n        requests:\n          storage: 100Gi\n      storageClassName: local-storage\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"TiFlash supports mounting multiple Persistent Volumes (PVs). If you want to configure multiple PVs for TiFlash, configure multiple ",(0,i.kt)("inlineCode",{parentName:"p"},"resources")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"tiflash.storageClaims"),", each ",(0,i.kt)("inlineCode",{parentName:"p"},"resources")," with a separate ",(0,i.kt)("inlineCode",{parentName:"p"},"requests.storage")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"storageClassName"),". For example:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"tiflash:\n    baseImage: pingcap/tiflash\n    maxFailoverCount: 0\n    replicas: 1\n    storageClaims:\n    - resources:\n        requests:\n            storage: 100Gi\n      storageClassName: local-storage\n    - resources:\n        requests:\n            storage: 100Gi\n      storageClassName: local-storage\n")),(0,i.kt)("div",{parentName:"li",className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("ul",{parentName:"div"},(0,i.kt)("li",{parentName:"ul"},"When deploying TiFlash for the first time, it is recommended that you plan how many PVs are required and configure the number of ",(0,i.kt)("inlineCode",{parentName:"li"},"resources")," items in ",(0,i.kt)("inlineCode",{parentName:"li"},"storageClaims")," accordingly."),(0,i.kt)("li",{parentName:"ul"},"Once the deployment of TiFlash is completed, if you need to mount additional PVs for TiFlash, updating ",(0,i.kt)("inlineCode",{parentName:"li"},"storageClaims")," directly to add disks does not take effect. This is because TiDB Operator manages TiFlash by creating a ",(0,i.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/"},"StatefulSet"),", and the ",(0,i.kt)("inlineCode",{parentName:"li"},"StatefulSet")," does not support modifying ",(0,i.kt)("inlineCode",{parentName:"li"},"volumeClaimTemplates")," after being created."))))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Configure the relevant parameters of ",(0,i.kt)("inlineCode",{parentName:"p"},"spec.tiflash.config")," in TidbCluster CR. For example:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'spec:\n  tiflash:\n    config:\n      config: |\n        [flash]\n          [flash.flash_cluster]\n            log = "/data0/logs/flash_cluster_manager.log"\n        [logger]\n          count = 10\n          level = "information"\n          errorlog = "/data0/logs/error.log"\n          log = "/data0/logs/server.log"\n')),(0,i.kt)("p",{parentName:"li"},"For more TiFlash parameters that can be configured, refer to ",(0,i.kt)("a",{parentName:"p",href:"https://docs.pingcap.com/tidb/stable/tiflash-configuration"},"TiFlash Configuration Documentation"),"."),(0,i.kt)("div",{parentName:"li",className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"For different TiFlash versions, note the following configuration differences:"),(0,i.kt)("ul",{parentName:"div"},(0,i.kt)("li",{parentName:"ul"},"If TiFlash version <= v4.0.4, you need to set ",(0,i.kt)("inlineCode",{parentName:"li"},"spec.tiflash.config.config.flash.service_addr")," to ",(0,i.kt)("inlineCode",{parentName:"li"},"${clusterName}-tiflash-POD_NUM.${clusterName}-tiflash-peer.${namespace}.svc:3930")," in TidbCluster CR, where ",(0,i.kt)("inlineCode",{parentName:"li"},"${clusterName}")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"${namespace}")," need to be replaced according to the real case."),(0,i.kt)("li",{parentName:"ul"},"If TiFlash version >= v4.0.5, there is no need to manually configure ",(0,i.kt)("inlineCode",{parentName:"li"},"spec.tiflash.config.config.flash.service_addr"),"."),(0,i.kt)("li",{parentName:"ul"},"If you upgrade from TiFlash v4.0.4 or an earlier version to TiFlash v4.0.5 or a later version, you need to delete the configuration of ",(0,i.kt)("inlineCode",{parentName:"li"},"spec.tiflash.config.config.flash.service_addr")," from the ",(0,i.kt)("inlineCode",{parentName:"li"},"TidbCluster")," CR.")))))),(0,i.kt)("h2",{id:"adding-pvs-to-tiflash"},"Adding PVs to TiFlash"),(0,i.kt)("p",null,"Once the deployment of TiFlash is completed, to add PVs for TiFlash, you need to update the ",(0,i.kt)("inlineCode",{parentName:"p"},"storageClaims")," to add disks, and then manually delete the TiFlash StatefulSet. The following are the detailed steps."),(0,i.kt)("div",{className:"admonition admonition-danger alert alert--danger"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"Warning")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Deleting the TiFlash StatefulSet makes the TiFlash cluster unavailable during the deletion and affects related business. You must be cautious about whether to do the following."))),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Edit the TidbCluster Custom Resource (CR)."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl edit tc ${cluster_name} -n ${namespace}\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"TiDB Operator automatically mounts PVs in the ",(0,i.kt)("strong",{parentName:"p"},"order")," of the items in the ",(0,i.kt)("inlineCode",{parentName:"p"},"storageClaims")," list. If you need to add more ",(0,i.kt)("inlineCode",{parentName:"p"},"resources")," items to TiFlash, make sure to append new items only to the ",(0,i.kt)("strong",{parentName:"p"},"end")," of the original items, and ",(0,i.kt)("strong",{parentName:"p"},"DO NOT")," modify the order of the original items. For example:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"tiflash:\n    baseImage: pingcap/tiflash\n    maxFailoverCount: 0\n    replicas: 1\n    storageClaims:\n    - resources:\n        requests:\n            storage: 100Gi\n      storageClassName: local-storage\n    - resources:\n        requests:\n            storage: 100Gi\n      storageClassName: local-storage\n    - resources: #newly added\n        requests:  #newly added\n            storage: 100Gi  #newly added\n      storageClassName: local-storage  #newly added\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Manually delete the TiFlash StatefulSet by running the following command. Then, wait for the TiDB Operator to recreate the TiFlash StatefulSet."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl delete sts -n ${namespace} ${cluster_name}-tiflash\n")))),(0,i.kt)("h2",{id:"remove-tiflash"},"Remove TiFlash"),(0,i.kt)("p",null,"If your TiDB cluster no longer needs the TiDB HTAP storage engine TiFlash, take the following steps to remove TiFlash:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Adjust the number of replicas of the tables replicated to the TiFlash cluster."),(0,i.kt)("p",{parentName:"li"},"To completely remove TiFlash, you need to set the number of replicas of all tables replicated to the TiFlash to ",(0,i.kt)("inlineCode",{parentName:"p"},"0"),"."),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"To connect to the TiDB service, refer to the steps in ",(0,i.kt)("a",{parentName:"p",href:"/docusaurus-operator/access-tidb"},"Access the TiDB Cluster in Kubernetes"),".")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"To adjust the number of replicas of the tables replicated to the TiFlash cluster, run the following command:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"alter table <db_name>.<table_name> set tiflash replica 0;\n"))))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Wait for the TiFlash replicas of the related tables to be deleted."),(0,i.kt)("p",{parentName:"li"},"Connect to the TiDB service and run the following command. If you can not find the replication information of the related tables, it means that the replicas are deleted:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT * FROM information_schema.tiflash_replica WHERE TABLE_SCHEMA = '<db_name>' and TABLE_NAME = '<table_name>';\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"To remove TiFlash Pods, run the following command to modify ",(0,i.kt)("inlineCode",{parentName:"p"},"spec.tiflash.replicas")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"0"),":"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'kubectl patch tidbcluster ${cluster_name} -n ${namespace} --type merge -p \'{"spec":{"tiflash":{"replicas": 0}}}\n'))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Check the state of TiFlash Pods and TiFlash stores."),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Run the following command to check whether you delete the TiFlash Pod successfully:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get pod -n ${namespace} -l app.kubernetes.io/component=tiflash,app.kubernetes.io/instance=${cluster_name}\n")),(0,i.kt)("p",{parentName:"li"}," If the output is empty, it means that you delete the Pod of the TiFlash cluster successfully.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"To check whether the stores of the TiFlash are in the ",(0,i.kt)("inlineCode",{parentName:"p"},"Tombstone")," state, run the following command:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get tidbcluster ${cluster_name} -n ${namespace} -o yaml\n")),(0,i.kt)("p",{parentName:"li"}," The value of the ",(0,i.kt)("inlineCode",{parentName:"p"},"status.tiflash")," field in the output result is similar to the example below."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"},'tiflash:\n    ...\n    tombstoneStores:\n    "88":\n        id: "88"\n        ip: basic-tiflash-0.basic-tiflash-peer.default.svc\n        lastHeartbeatTime: "2020-12-31T04:42:12Z"\n        lastTransitionTime: null\n        leaderCount: 0\n        podName: basic-tiflash-0\n        state: Tombstone\n    "89":\n        id: "89"\n        ip: basic-tiflash-1.basic-tiflash-peer.default.svc\n        lastHeartbeatTime: "2020-12-31T04:41:50Z"\n        lastTransitionTime: null\n        leaderCount: 0\n        podName: basic-tiflash-1\n        state: Tombstone\n')),(0,i.kt)("p",{parentName:"li"}," Only after you delete all Pods of the TiFlash cluster successfully and all the TiFlash stores have changed to the ",(0,i.kt)("inlineCode",{parentName:"p"},"Tombstone")," state, can you perform the next operation.")))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Delete the TiFlash StatefulSet."),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"To modify the TidbCluster CR and delete the ",(0,i.kt)("inlineCode",{parentName:"p"},"spec.tiflash")," field, run the following command:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'kubectl patch tidbcluster ${cluster_name} -n ${namespace} --type json -p \'[{"op":"remove", "path":"/spec/tiflash"}]\'\n'))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"To delete the TiFlash StatefulSet, run the following command:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl delete statefulsets -n ${namespace} -l app.kubernetes.io/component=tiflash,app.kubernetes.io/instance=${cluster_name}\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"To check whether you delete the StatefulSet of the TiFlash cluster successfully, run the following command:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get sts -n ${namespace} -l app.kubernetes.io/component=tiflash,app.kubernetes.io/instance=${cluster_name}\n")),(0,i.kt)("p",{parentName:"li"}," If the output is empty, it means that you delete the StatefulSet of the TiFlash cluster successfully.")))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"(Optional) Delete PVC and PV."),(0,i.kt)("p",{parentName:"li"},"If you confirm that you do not use the data in TiFlash, and you want to delete the data, you need to strictly follow the steps below to delete the data in TiFlash:"),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Delete the PVC object corresponding to the PV"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl delete pvc -n ${namespace} -l app.kubernetes.io/component=tiflash,app.kubernetes.io/instance=${cluster_name}\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"If the PV reclaim policy is ",(0,i.kt)("inlineCode",{parentName:"p"},"Retain"),", the corresponding PV is still retained after you delete the PVC object. If you want to delete the PV, you can set the reclaim policy of the PV to ",(0,i.kt)("inlineCode",{parentName:"p"},"Delete"),", and the PV can be deleted and recycled automatically."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'kubectl patch pv ${pv_name} -p \'{"spec":{"persistentVolumeReclaimPolicy":"Delete"}}\'\n')),(0,i.kt)("p",{parentName:"li"}," In the above command, ",(0,i.kt)("inlineCode",{parentName:"p"},"${pv_name}")," represents the PV name of the TiFlash cluster. You can check the PV name by running the following command:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get pv -l app.kubernetes.io/component=tiflash,app.kubernetes.io/instance=${cluster_name}\n")))))))}u.isMDXComponent=!0}}]);