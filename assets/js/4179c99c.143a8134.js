"use strict";(self.webpackChunkpingcap_docs=self.webpackChunkpingcap_docs||[]).push([[4167],{3905:function(e,t,a){a.d(t,{Zo:function(){return u},kt:function(){return d}});var n=a(7294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var l=n.createContext({}),p=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},u=function(e){var t=p(e.components);return n.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),m=p(a),d=o,h=m["".concat(l,".").concat(d)]||m[d]||c[d]||r;return a?n.createElement(h,i(i({ref:t},u),{},{components:a})):n.createElement(h,i({ref:t},u))}));function d(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=a.length,i=new Array(r);i[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var p=2;p<r;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},8966:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return p},assets:function(){return u},toc:function(){return c},default:function(){return d}});var n=a(7462),o=a(3366),r=(a(7294),a(3905)),i=["components"],s={title:"Aggregate Monitoring Data of Multiple TiDB Clusters",summary:"Learn how to aggregate monitoring data of multiple TiDB clusters by Thanos query."},l="Aggregate Monitoring Data of Multiple TiDB Clusters",p={unversionedId:"aggregate-multiple-cluster-monitor-data",id:"aggregate-multiple-cluster-monitor-data",title:"Aggregate Monitoring Data of Multiple TiDB Clusters",description:"This document describes how to aggregate the monitoring data of multiple TiDB clusters by Thanos to provide centralized monitoring service.",source:"@site/docs/aggregate-multiple-cluster-monitor-data.md",sourceDirName:".",slug:"/aggregate-multiple-cluster-monitor-data",permalink:"/docusaurus-operator/aggregate-multiple-cluster-monitor-data",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/aggregate-multiple-cluster-monitor-data.md",tags:[],version:"current",frontMatter:{title:"Aggregate Monitoring Data of Multiple TiDB Clusters",summary:"Learn how to aggregate monitoring data of multiple TiDB clusters by Thanos query."},sidebar:"mySidebar",previous:{title:"Access TiDB Dashboard",permalink:"/docusaurus-operator/access-dashboard"},next:{title:"Enable Dynamic Configuration for TidbMonitor",permalink:"/docusaurus-operator/enable-monitor-dynamic-configuration"}},u={},c=[{value:"Thanos",id:"thanos",level:2},{value:"Aggregate monitoring data via Thanos Query",id:"aggregate-monitoring-data-via-thanos-query",level:2},{value:"Configure Thanos Query",id:"configure-thanos-query",level:3},{value:"Access the Thanos Query panel",id:"access-the-thanos-query-panel",level:3},{value:"Configure Grafana",id:"configure-grafana",level:3},{value:"Add or remove TidbMonitor",id:"add-or-remove-tidbmonitor",level:3},{value:"Configure archives and storage of Thanos Sidecar",id:"configure-archives-and-storage-of-thanos-sidecar",level:3},{value:"RemoteWrite mode",id:"remotewrite-mode",level:2}],m={toc:c};function d(e){var t=e.components,a=(0,o.Z)(e,i);return(0,r.kt)("wrapper",(0,n.Z)({},m,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"aggregate-monitoring-data-of-multiple-tidb-clusters"},"Aggregate Monitoring Data of Multiple TiDB Clusters"),(0,r.kt)("p",null,"This document describes how to aggregate the monitoring data of multiple TiDB clusters by Thanos to provide centralized monitoring service."),(0,r.kt)("h2",{id:"thanos"},"Thanos"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://thanos.io/tip/thanos/design.md/"},"Thanos")," is a high availability solution for Prometheus that simplifies the availability guarantee of Prometheus."),(0,r.kt)("p",null,"Thanos provides ",(0,r.kt)("a",{parentName:"p",href:"https://thanos.io/tip/components/query.md/"},"Thanos Query")," component as a unified query solution across multiple Prometheus clusters. You can use this feature to aggregate monitoring data of multiple TiDB clusters."),(0,r.kt)("h2",{id:"aggregate-monitoring-data-via-thanos-query"},"Aggregate monitoring data via Thanos Query"),(0,r.kt)("h3",{id:"configure-thanos-query"},"Configure Thanos Query"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Configure a Thanos Sidecar container for each TidbMonitor."),(0,r.kt)("p",{parentName:"li"},"A configuration example is as follows."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl -n ${namespace} apply -f https://raw.githubusercontent.com/pingcap/tidb-operator/master/examples/monitor-with-thanos/tidb-monitor.yaml\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Deploy the Thanos Query component."),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Download the ",(0,r.kt)("inlineCode",{parentName:"p"},"thanos-query.yaml")," file for Thanos Query deployment:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"curl -sl -O https://raw.githubusercontent.com/pingcap/tidb-operator/master/examples/monitor-with-thanos/thanos-query.yaml\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Manually modify the ",(0,r.kt)("inlineCode",{parentName:"p"},"--store")," parameter in the ",(0,r.kt)("inlineCode",{parentName:"p"},"thanos-query.yaml")," file by updating ",(0,r.kt)("inlineCode",{parentName:"p"},"basic-prometheus:10901")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"basic-prometheus.${namespace}:10901"),"."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"${namespace}")," is the namespace where TidbMonitor is deployed.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Execute the ",(0,r.kt)("inlineCode",{parentName:"p"},"kubectl apply")," command for deployment."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"kubectl -n ${thanos_namespace} apply -f thanos-query.yaml\n")),(0,r.kt)("p",{parentName:"li"},"In the command above, ",(0,r.kt)("inlineCode",{parentName:"p"},"${thanos_namespace}")," is the namespace where the Thanos Query component is deployed."))))),(0,r.kt)("p",null,"In Thanos Query, a Prometheus instance corresponds to a store and also corresponds to a TidbMonitor. After deploying Thanos Query, you can provide a uniform query interface for monitoring data through Thanos Query's API."),(0,r.kt)("h3",{id:"access-the-thanos-query-panel"},"Access the Thanos Query panel"),(0,r.kt)("p",null,"To access the Thanos Query panel, execute the following command, and then access ",(0,r.kt)("a",{parentName:"p",href:"http://127.0.0.1:9090"},"http://127.0.0.1:9090")," in your browser:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl port-forward -n ${thanos_namespace} svc/thanos-query 9090\n")),(0,r.kt)("p",null,"If you want to access the Thanos Query panel using NodePort or LoadBalancer, refer to the following documents:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/docusaurus-operator/access-tidb#nodeport"},"NodePort method")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/docusaurus-operator/access-tidb#loadbalancer"},"LoadBalancer way"))),(0,r.kt)("h3",{id:"configure-grafana"},"Configure Grafana"),(0,r.kt)("p",null,"After deploying Thanos Query, to query the monitoring data of multiple TidbMonitors, take the following steps:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Log in to Grafana."),(0,r.kt)("li",{parentName:"ol"},"In the left navigation bar, select ",(0,r.kt)("inlineCode",{parentName:"li"},"Configuration")," > ",(0,r.kt)("inlineCode",{parentName:"li"},"Data Sources"),"."),(0,r.kt)("li",{parentName:"ol"},"Add or modify a DataSource in the Prometheus type."),(0,r.kt)("li",{parentName:"ol"},"Set the URL under HTTP to ",(0,r.kt)("inlineCode",{parentName:"li"},"http://thanos-query.${thanos_namespace}:9090"),".")),(0,r.kt)("h3",{id:"add-or-remove-tidbmonitor"},"Add or remove TidbMonitor"),(0,r.kt)("p",null,"In Thanos Query, a Prometheus instance corresponds to a monitor store and also corresponds to a TidbMonitor. If you need to add, update, or remove a monitor store from the Thanos Query, update the ",(0,r.kt)("inlineCode",{parentName:"p"},"--store")," configuration of the Thanos Query component, and perform a rolling update to the Thanos Query component."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"spec:\n containers:\n   - args:\n       - query\n       - --grpc-address=0.0.0.0:10901\n       - --http-address=0.0.0.0:9090\n       - --log.level=debug\n       - --log.format=logfmt\n       - --query.replica-label=prometheus_replica\n       - --query.replica-label=rule_replica\n       - --store=<TidbMonitorName1>-prometheus.<TidbMonitorNs1>:10901\n       - --store=<TidbMonitorName2>-prometheus.<TidbMonitorNs2>:10901\n")),(0,r.kt)("h3",{id:"configure-archives-and-storage-of-thanos-sidecar"},"Configure archives and storage of Thanos Sidecar"),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"To ensure successful configuration, you must first create the S3 bucket. If you choose AWS S3, refer to ",(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/AmazonS3/latest/userguide/create-bucket-overview.html"},"AWS documentation - Create AWS S3 Bucket")," and ",(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/general/latest/gr/s3.html"},"AWS documentation - AWS S3 Endpoint List")," for instructions."))),(0,r.kt)("p",null,"Thanos Sidecar supports replicating monitoring data to S3 remote storage."),(0,r.kt)("p",null,"The configuration of the ",(0,r.kt)("inlineCode",{parentName:"p"},"TidbMonitor")," CR is as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  thanos:\n    baseImage: thanosio/thanos\n    version: v0.17.2\n    objectStorageConfig:\n      key: objectstorage.yaml\n      name: thanos-objectstorage\n")),(0,r.kt)("p",null,"Meanwhile, you need to create a Secret. The example is as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Secret\nmetadata:\n  name: thanos-objectstorage\ntype: Opaque\nstringData:\n  objectstorage.yaml: |\n    type: S3\n    config:\n      bucket: "xxxxxx"\n      endpoint: "xxxx"\n      region: ""\n      access_key: "xxxx"\n      insecure: true\n      signature_version2: true\n      secret_key: "xxxx"\n      put_user_metadata: {}\n      http_config:\n        idle_conn_timeout: 90s\n        response_header_timeout: 2m\n      trace:\n        enable: true\n      part_size: 41943040\n')),(0,r.kt)("h2",{id:"remotewrite-mode"},"RemoteWrite mode"),(0,r.kt)("p",null,"Besides aggregating data via Thanos Query, you can also push monitoring data to Thanos using Prometheus' RemoteWrite feature."),(0,r.kt)("p",null,"To enable the RemoteWrite mode, specify the Prometheus RemoteWrite configuration when you create the TidbMonitor CR. For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: pingcap.com/v1alpha1\nkind: TidbMonitor\nmetadata:\n  name: basic\nspec:\n  clusters:\n  - name: basic\n  prometheus:\n    baseImage: prom/prometheus\n    version: v2.27.1\n    remoteWrite:\n      - url: "http://thanos-receiver:19291/api/v1/receive"\n  grafana:\n    baseImage: grafana/grafana\n    version: 7.5.11\n  initializer:\n    baseImage: registry.cn-beijing.aliyuncs.com/tidb/tidb-monitor-initializer\n    version: v5.3.0\n  reloader:\n    baseImage: registry.cn-beijing.aliyuncs.com/tidb/tidb-monitor-reloader\n    version: v1.0.1\n  imagePullPolicy: IfNotPresent\n')),(0,r.kt)("p",null,"After RemoteWrite is enabled, Prometheus pushes the monitoring data to ",(0,r.kt)("a",{parentName:"p",href:"https://thanos.io/tip/components/receive.md/"},"Thanos Receiver"),". For more information, refer to ",(0,r.kt)("a",{parentName:"p",href:"https://thanos.io/v0.8/proposals/201812_thanos-remote-receive/"},"the design of Thanos Receiver"),"."),(0,r.kt)("p",null,"For details on the deployment, refer to ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/pingcap/tidb-operator/tree/master/examples/monitor-prom-remotewrite"},"this example of integrating TidbMonitor with Thanos Receiver"),"."))}d.isMDXComponent=!0}}]);