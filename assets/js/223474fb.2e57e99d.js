"use strict";(self.webpackChunkpingcap_docs=self.webpackChunkpingcap_docs||[]).push([[6719],{3905:function(e,t,a){a.d(t,{Zo:function(){return d},kt:function(){return u}});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var p=n.createContext({}),s=function(e){var t=n.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},d=function(e){var t=s(e.components);return n.createElement(p.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,p=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),c=s(a),u=r,k=c["".concat(p,".").concat(u)]||c[u]||m[u]||i;return a?n.createElement(k,l(l({ref:t},d),{},{components:a})):n.createElement(k,l({ref:t},d))}));function u(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,l=new Array(i);l[0]=c;var o={};for(var p in t)hasOwnProperty.call(t,p)&&(o[p]=t[p]);o.originalType=e,o.mdxType="string"==typeof e?e:r,l[1]=o;for(var s=2;s<i;s++)l[s]=a[s];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},4116:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return o},contentTitle:function(){return p},metadata:function(){return s},assets:function(){return d},toc:function(){return m},default:function(){return u}});var n=a(7462),r=a(3366),i=(a(7294),a(3905)),l=["components"],o={title:"Deploy TiDB on Alibaba Cloud Kubernetes",summary:"Learn how to deploy a TiDB cluster on Alibaba Cloud Kubernetes."},p="Deploy TiDB on Alibaba Cloud Kubernetes",s={unversionedId:"deploy-on-alibaba-cloud",id:"deploy-on-alibaba-cloud",title:"Deploy TiDB on Alibaba Cloud Kubernetes",description:"This document describes how to deploy a TiDB cluster on Alibaba Cloud Kubernetes with your laptop (Linux or macOS) for development or testing.",source:"@site/docs/deploy-on-alibaba-cloud.md",sourceDirName:".",slug:"/deploy-on-alibaba-cloud",permalink:"/deploy-on-alibaba-cloud",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/deploy-on-alibaba-cloud.md",tags:[],version:"current",frontMatter:{title:"Deploy TiDB on Alibaba Cloud Kubernetes",summary:"Learn how to deploy a TiDB cluster on Alibaba Cloud Kubernetes."},sidebar:"mySidebar",previous:{title:"Deploy TiDB on Azure AKS",permalink:"/deploy-on-azure-aks"},next:{title:"Deploy a TiDB Cluster on ARM64 Machines",permalink:"/deploy-cluster-on-arm64"}},d={},m=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Required privileges",id:"required-privileges",level:3},{value:"Overview of things to create",id:"overview-of-things-to-create",level:2},{value:"Deploy",id:"deploy",level:2},{value:"Deploy ACK, TiDB Operator and the node pool for TiDB cluster",id:"deploy-ack-tidb-operator-and-the-node-pool-for-tidb-cluster",level:3},{value:"Deploy the TiDB cluster and monitor",id:"deploy-the-tidb-cluster-and-monitor",level:3},{value:"Access the database",id:"access-the-database",level:2},{value:"Monitor",id:"monitor",level:2},{value:"Upgrade",id:"upgrade",level:2},{value:"Scale out the TiDB cluster",id:"scale-out-the-tidb-cluster",level:2},{value:"Configure",id:"configure",level:2},{value:"Configure TiDB Operator",id:"configure-tidb-operator",level:3},{value:"Configure the TiDB cluster",id:"configure-the-tidb-cluster",level:3},{value:"Manage multiple TiDB clusters",id:"manage-multiple-tidb-clusters",level:2},{value:"Manage multiple Kubernetes clusters",id:"manage-multiple-kubernetes-clusters",level:2},{value:"Destroy",id:"destroy",level:2},{value:"Limitation",id:"limitation",level:2}],c={toc:m};function u(e){var t=e.components,a=(0,r.Z)(e,l);return(0,i.kt)("wrapper",(0,n.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"deploy-tidb-on-alibaba-cloud-kubernetes"},"Deploy TiDB on Alibaba Cloud Kubernetes"),(0,i.kt)("p",null,"This document describes how to deploy a TiDB cluster on Alibaba Cloud Kubernetes with your laptop (Linux or macOS) for development or testing."),(0,i.kt)("p",null,"To deploy TiDB Operator and the TiDB cluster in a self-managed Kubernetes environment, refer to ",(0,i.kt)("a",{parentName:"p",href:"/deploy-tidb-operator"},"Deploy TiDB Operator")," and ",(0,i.kt)("a",{parentName:"p",href:"/deploy-on-general-kubernetes"},"Deploy TiDB in General Kubernetes"),"."),(0,i.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://github.com/aliyun/aliyun-cli"},(0,i.kt)("inlineCode",{parentName:"a"},"aliyun-cli"))," >= 3.0.15 and ",(0,i.kt)("a",{parentName:"p",href:"https://www.alibabacloud.com/help/doc-detail/90766.htm?spm=a2c63.l28256.a3.4.7b52a893EFVglq"},"configure ",(0,i.kt)("inlineCode",{parentName:"a"},"aliyun-cli"))),(0,i.kt)("blockquote",{parentName:"li"},(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("strong",{parentName:"p"},"Note:")),(0,i.kt)("p",{parentName:"blockquote"},"The access key must be granted permissions to control the corresponding resources."))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/tools/install-kubectl/"},"kubectl")," >= 1.12")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://helm.sh"},"Helm 3"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://stedolan.github.io/jq/download/"},"jq")," >= 1.6")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://learn.hashicorp.com/terraform/getting-started/install.html"},"terraform")," 0.12.*"))),(0,i.kt)("p",null,"You can use ",(0,i.kt)("a",{parentName:"p",href:"https://shell.aliyun.com"},"Cloud Shell")," of Alibaba Cloud to perform operations. All the tools have been pre-installed and configured in the Cloud Shell of Alibaba Cloud."),(0,i.kt)("h3",{id:"required-privileges"},"Required privileges"),(0,i.kt)("p",null,"To deploy a TiDB cluster, make sure you have the following privileges:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"AliyunECSFullAccess"),(0,i.kt)("li",{parentName:"ul"},"AliyunESSFullAccess"),(0,i.kt)("li",{parentName:"ul"},"AliyunVPCFullAccess"),(0,i.kt)("li",{parentName:"ul"},"AliyunSLBFullAccess"),(0,i.kt)("li",{parentName:"ul"},"AliyunCSFullAccess"),(0,i.kt)("li",{parentName:"ul"},"AliyunEIPFullAccess"),(0,i.kt)("li",{parentName:"ul"},"AliyunECIFullAccess"),(0,i.kt)("li",{parentName:"ul"},"AliyunVPNGatewayFullAccess"),(0,i.kt)("li",{parentName:"ul"},"AliyunNATGatewayFullAccess")),(0,i.kt)("h2",{id:"overview-of-things-to-create"},"Overview of things to create"),(0,i.kt)("p",null,"In the default configuration, you will create:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"A new VPC")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"An ECS instance as the bastion machine")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"A managed ACK (Alibaba Cloud Kubernetes) cluster with the following ECS instance worker nodes:"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"An auto-scaling group of 2 * instances (2 cores, 2 GB RAM). The default auto-scaling group of managed Kubernetes must have at least two instances to host the whole system service, like CoreDNS"),(0,i.kt)("li",{parentName:"ul"},"An auto-scaling group of 3 * ",(0,i.kt)("inlineCode",{parentName:"li"},"ecs.g5.large")," instances for deploying the PD cluster"),(0,i.kt)("li",{parentName:"ul"},"An auto-scaling group of 3 * ",(0,i.kt)("inlineCode",{parentName:"li"},"ecs.i2.2xlarge")," instances for deploying the TiKV cluster"),(0,i.kt)("li",{parentName:"ul"},"An auto-scaling group of 2 * ",(0,i.kt)("inlineCode",{parentName:"li"},"ecs.c5.4xlarge")," instances for deploying the TiDB cluster"),(0,i.kt)("li",{parentName:"ul"},"An auto-scaling group of 1 * ",(0,i.kt)("inlineCode",{parentName:"li"},"ecs.c5.xlarge")," instance for deploying monitoring components"),(0,i.kt)("li",{parentName:"ul"},"A 100 GB cloud disk used to store monitoring data")))),(0,i.kt)("p",null,"All the instances except ACK mandatory workers are deployed across availability zones (AZs) to provide cross-AZ high availability. The auto-scaling group ensures the desired number of healthy instances, so the cluster can auto-recover from node failure or even AZ failure."),(0,i.kt)("h2",{id:"deploy"},"Deploy"),(0,i.kt)("h3",{id:"deploy-ack-tidb-operator-and-the-node-pool-for-tidb-cluster"},"Deploy ACK, TiDB Operator and the node pool for TiDB cluster"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Configure the target region and Alibaba Cloud key (you can also set these variables in the ",(0,i.kt)("inlineCode",{parentName:"p"},"terraform")," command prompt):"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"export TF_VAR_ALICLOUD_REGION=${REGION} && \\\nexport TF_VAR_ALICLOUD_ACCESS_KEY=${ACCESS_KEY} && \\\nexport TF_VAR_ALICLOUD_SECRET_KEY=${SECRET_KEY}\n")),(0,i.kt)("p",{parentName:"li"},"The ",(0,i.kt)("inlineCode",{parentName:"p"},"variables.tf")," file contains default settings of variables used for deploying the cluster. You can change it or use the ",(0,i.kt)("inlineCode",{parentName:"p"},"-var")," option to override a specific variable to fit your need.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Use Terraform to set up the cluster."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"git clone --depth=1 https://github.com/pingcap/tidb-operator && \\\ncd tidb-operator/deploy/aliyun\n")),(0,i.kt)("p",{parentName:"li"},"You can create or modify ",(0,i.kt)("inlineCode",{parentName:"p"},"terraform.tfvars")," to set the values of the variables, and configure the cluster to fit your needs. You can view the configurable variables and their descriptions in ",(0,i.kt)("inlineCode",{parentName:"p"},"variables.tf"),". The following is an example of how to configure the ACK cluster name, the TiDB cluster name, the TiDB Operator version, and the number of PD, TiKV, and TiDB nodes."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"},'cluster_name = "testack"\ntidb_cluster_name = "testdb"\ntikv_count = 3\ntidb_count = 2\npd_count = 3\noperator_version = "v1.2.7"\n')),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"To deploy TiFlash in the cluster, set ",(0,i.kt)("inlineCode",{parentName:"p"},"create_tiflash_node_pool = true")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"terraform.tfvars"),". You can also configure the node count and instance type of the TiFlash node pool by modifying ",(0,i.kt)("inlineCode",{parentName:"p"},"tiflash_count")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"tiflash_instance_type"),". By default, the value of ",(0,i.kt)("inlineCode",{parentName:"p"},"tiflash_count")," is ",(0,i.kt)("inlineCode",{parentName:"p"},"2"),", and the value of ",(0,i.kt)("inlineCode",{parentName:"p"},"tiflash_instance_type")," is ",(0,i.kt)("inlineCode",{parentName:"p"},"ecs.i2.2xlarge"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"To deploy TiCDC in the cluster, set ",(0,i.kt)("inlineCode",{parentName:"p"},"create_cdc_node_pool = true")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"terraform.tfvars"),". You can also configure the node count and instance type of the TiCDC node pool by modifying ",(0,i.kt)("inlineCode",{parentName:"p"},"cdc_count")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"cdc_instance_type"),". By default, the value of ",(0,i.kt)("inlineCode",{parentName:"p"},"cdc_count")," is ",(0,i.kt)("inlineCode",{parentName:"p"},"3"),", and the value of ",(0,i.kt)("inlineCode",{parentName:"p"},"cdc_instance_type")," is ",(0,i.kt)("inlineCode",{parentName:"p"},"ecs.c5.2xlarge"),"."))),(0,i.kt)("blockquote",{parentName:"li"},(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("strong",{parentName:"p"},"Note:")),(0,i.kt)("p",{parentName:"blockquote"},"Check the ",(0,i.kt)("inlineCode",{parentName:"p"},"operator_version")," in the ",(0,i.kt)("inlineCode",{parentName:"p"},"variables.tf")," file for the default TiDB Operator version of the current scripts. If the default version is not your desired one, configure ",(0,i.kt)("inlineCode",{parentName:"p"},"operator_version")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"terraform.tfvars"),".")),(0,i.kt)("p",{parentName:"li"},"After the configuration, execute the following commands to initialize and deploy the cluster:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"terraform init\n")),(0,i.kt)("p",{parentName:"li"},'Input "yes" to confirm execution when you run the following ',(0,i.kt)("inlineCode",{parentName:"p"},"apply")," command:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"terraform apply\n")),(0,i.kt)("p",{parentName:"li"},"If you get an error while running ",(0,i.kt)("inlineCode",{parentName:"p"},"terraform apply"),", fix the error (for example, lack of permission) according to the error description and run ",(0,i.kt)("inlineCode",{parentName:"p"},"terraform apply")," again."),(0,i.kt)("p",{parentName:"li"},"It takes 5 to 10 minutes to create the whole stack using ",(0,i.kt)("inlineCode",{parentName:"p"},"terraform apply"),". Once the installation is complete, the basic cluster information is printed:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"},"Apply complete! Resources: 3 added, 0 changed, 1 destroyed.\n\nOutputs:\n\nbastion_ip = 47.96.174.214\ncluster_id = c2d9b20854a194f158ef2bc8ea946f20e\n\nkubeconfig_file = /tidb-operator/deploy/aliyun/credentials/kubeconfig\nmonitor_endpoint = not_created\nregion = cn-hangzhou\nssh_key_file = /tidb-operator/deploy/aliyun/credentials/my-cluster-keyZ.pem\ntidb_endpoint = not_created\ntidb_version = v3.0.0\nvpc_id = vpc-bp1v8i5rwsc7yh8dwyep5\n")),(0,i.kt)("blockquote",{parentName:"li"},(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("strong",{parentName:"p"},"Note:")),(0,i.kt)("p",{parentName:"blockquote"},"You can use the ",(0,i.kt)("inlineCode",{parentName:"p"},"terraform output")," command to get the output again."))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"You can then interact with the ACK cluster using ",(0,i.kt)("inlineCode",{parentName:"p"},"kubectl")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"helm"),":"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"export KUBECONFIG=$PWD/credentials/kubeconfig\n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl version\n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"helm ls\n")))),(0,i.kt)("h3",{id:"deploy-the-tidb-cluster-and-monitor"},"Deploy the TiDB cluster and monitor"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Prepare the ",(0,i.kt)("inlineCode",{parentName:"p"},"TidbCluster")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"TidbMonitor")," CR files:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"cp manifests/db.yaml.example db.yaml && cp manifests/db-monitor.yaml.example db-monitor.yaml\n")),(0,i.kt)("p",{parentName:"li"},"To complete the CR file configuration, refer to ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/pingcap/tidb-operator/blob/master/docs/api-references/docs.md"},"TiDB Operator API documentation")," and ",(0,i.kt)("a",{parentName:"p",href:"/configure-a-tidb-cluster"},"Configure a TiDB Cluster"),"."),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"To deploy TiFlash, configure ",(0,i.kt)("inlineCode",{parentName:"p"},"spec.tiflash")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"db.yaml")," as follows:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"spec\n  ...\n  tiflash:\n    baseImage: pingcap/tiflash\n    maxFailoverCount: 0\n    nodeSelector:\n      dedicated: TIDB_CLUSTER_NAME-tiflash\n    replicas: 1\n    storageClaims:\n    - resources:\n        requests:\n          storage: 100Gi\n      storageClassName: local-volume\n    tolerations:\n    - effect: NoSchedule\n      key: dedicated\n      operator: Equal\n      value: TIDB_CLUSTER_NAME-tiflash\n")),(0,i.kt)("p",{parentName:"li"},"  To configure other parameters, refer to ",(0,i.kt)("a",{parentName:"p",href:"/configure-a-tidb-cluster"},"Configure a TiDB Cluster"),"."),(0,i.kt)("p",{parentName:"li"},"  Modify ",(0,i.kt)("inlineCode",{parentName:"p"},"replicas"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"storageClaims[].resources.requests.storage"),", and ",(0,i.kt)("inlineCode",{parentName:"p"},"storageClassName")," according to your needs."),(0,i.kt)("blockquote",{parentName:"li"},(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("strong",{parentName:"p"},"Warning:")),(0,i.kt)("p",{parentName:"blockquote"},"Since TiDB Operator will mount PVs automatically in the ",(0,i.kt)("strong",{parentName:"p"},"order")," of the items in the ",(0,i.kt)("inlineCode",{parentName:"p"},"storageClaims")," list, if you need to add more disks to TiFlash, make sure to append the new item only to the ",(0,i.kt)("strong",{parentName:"p"},"end")," of the original items, and ",(0,i.kt)("strong",{parentName:"p"},"DO NOT")," modify the order of the original items."))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"To deploy TiCDC, configure ",(0,i.kt)("inlineCode",{parentName:"p"},"spec.ticdc")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"db.yaml")," as follows:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"spec\n  ...\n  ticdc:\n    baseImage: pingcap/ticdc\n    nodeSelector:\n      dedicated: TIDB_CLUSTER_NAME-cdc\n    replicas: 3\n    tolerations:\n    - effect: NoSchedule\n      key: dedicated\n      operator: Equal\n      value: TIDB_CLUSTER_NAME-cdc\n")),(0,i.kt)("p",{parentName:"li"},"  Modify ",(0,i.kt)("inlineCode",{parentName:"p"},"replicas")," according to your needs."))),(0,i.kt)("p",{parentName:"li"},"To deploy Enterprise Edition of TiDB/PD/TiKV/TiFlash/TiCDC, edit the ",(0,i.kt)("inlineCode",{parentName:"p"},"db.yaml")," file to set ",(0,i.kt)("inlineCode",{parentName:"p"},"spec.<tidb/pd/tikv/tiflash/ticdc>.baseImage")," to the enterprise image (",(0,i.kt)("inlineCode",{parentName:"p"},"pingcap/<tidb/pd/tikv/tiflash/ticdc>-enterprise"),")."),(0,i.kt)("p",{parentName:"li"},"For example:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  ...\n  pd:\n    baseImage: pingcap/pd-enterprise\n  ...\n  tikv:\n    baseImage: pingcap/tikv-enterprise\n")),(0,i.kt)("blockquote",{parentName:"li"},(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("strong",{parentName:"p"},"Note:")),(0,i.kt)("ul",{parentName:"blockquote"},(0,i.kt)("li",{parentName:"ul"},"Replace all the ",(0,i.kt)("inlineCode",{parentName:"li"},"TIDB_CLUSTER_NAME")," in the ",(0,i.kt)("inlineCode",{parentName:"li"},"db.yaml")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"db-monitor.yaml")," files with ",(0,i.kt)("inlineCode",{parentName:"li"},"tidb_cluster_name")," configured in the deployment of ACK."),(0,i.kt)("li",{parentName:"ul"},"Make sure the number of PD, TiKV, TiFlash, TiCDC, or TiDB nodes is >= the ",(0,i.kt)("inlineCode",{parentName:"li"},"replicas")," value of the corresponding component in ",(0,i.kt)("inlineCode",{parentName:"li"},"db.yaml"),"."),(0,i.kt)("li",{parentName:"ul"},"Make sure ",(0,i.kt)("inlineCode",{parentName:"li"},"spec.initializer.version")," in ",(0,i.kt)("inlineCode",{parentName:"li"},"db-monitor.yaml")," is the same as ",(0,i.kt)("inlineCode",{parentName:"li"},"spec.version")," in ",(0,i.kt)("inlineCode",{parentName:"li"},"db.yaml"),". Otherwise, the monitor might not display correctly.")))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Create ",(0,i.kt)("inlineCode",{parentName:"p"},"Namespace"),":"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl --kubeconfig credentials/kubeconfig create namespace ${namespace}\n")),(0,i.kt)("blockquote",{parentName:"li"},(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("strong",{parentName:"p"},"Note:")),(0,i.kt)("p",{parentName:"blockquote"},"You can give the ",(0,i.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/"},(0,i.kt)("inlineCode",{parentName:"a"},"namespace"))," a name that is easy to memorize, such as the same name as ",(0,i.kt)("inlineCode",{parentName:"p"},"tidb_cluster_name"),"."))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Deploy the TiDB cluster:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl --kubeconfig credentials/kubeconfig create -f db.yaml -n ${namespace} &&\nkubectl --kubeconfig credentials/kubeconfig create -f db-monitor.yaml -n ${namespace}\n")))),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"If you need to deploy a TiDB cluster on ARM64 machines, refer to ",(0,i.kt)("a",{parentName:"p",href:"/deploy-cluster-on-arm64"},"Deploy a TiDB Cluster on ARM64 Machines"),"."))),(0,i.kt)("h2",{id:"access-the-database"},"Access the database"),(0,i.kt)("p",null,"You can connect the TiDB cluster via the bastion instance. All necessary information is in the output printed after installation is finished (replace the ",(0,i.kt)("inlineCode",{parentName:"p"},"${}")," parts with values from the output):"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"ssh -i credentials/${cluster_name}-key.pem root@${bastion_ip}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"mysql -h ${tidb_lb_ip} -P 4000 -u root\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"tidb_lb_ip")," is the LoadBalancer IP of the TiDB service."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("ul",{parentName:"div"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_default_authentication_plugin"},"The default authentication plugin of MySQL 8.0")," is updated from ",(0,i.kt)("inlineCode",{parentName:"li"},"mysql_native_password")," to ",(0,i.kt)("inlineCode",{parentName:"li"},"caching_sha2_password"),". Therefore, if you use MySQL client from MySQL 8.0 to access the TiDB service (TiDB version < v4.0.7), and if the user account has a password, you need to explicitly specify the ",(0,i.kt)("inlineCode",{parentName:"li"},"--default-auth=mysql_native_password")," parameter."),(0,i.kt)("li",{parentName:"ul"},"By default, TiDB (starting from v4.0.2) periodically shares usage details with PingCAP to help understand how to improve the product. For details about what is shared and how to disable the sharing, see ",(0,i.kt)("a",{parentName:"li",href:"https://docs.pingcap.com/tidb/stable/telemetry"},"Telemetry"),".")))),(0,i.kt)("h2",{id:"monitor"},"Monitor"),(0,i.kt)("p",null,"Visit ",(0,i.kt)("inlineCode",{parentName:"p"},"<monitor-lb>:3000")," to view the Grafana dashboards. ",(0,i.kt)("inlineCode",{parentName:"p"},"monitor-lb")," is the LoadBalancer IP of the Monitor service."),(0,i.kt)("p",null,"The initial login user account and password:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"User: admin"),(0,i.kt)("li",{parentName:"ul"},"Password: admin")),(0,i.kt)("div",{className:"admonition admonition-danger alert alert--danger"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"Warning")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"If you already have a VPN connecting to your VPC or plan to set up one, it is strongly recommended that you go to the ",(0,i.kt)("inlineCode",{parentName:"p"},"spec.grafana.service.annotations")," section in the ",(0,i.kt)("inlineCode",{parentName:"p"},"db-monitor.yaml")," file and set ",(0,i.kt)("inlineCode",{parentName:"p"},"service.beta.kubernetes.io/alicloud-loadbalancer-address-type")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"intranet")," for security."))),(0,i.kt)("h2",{id:"upgrade"},"Upgrade"),(0,i.kt)("p",null,"To upgrade the TiDB cluster, modify the ",(0,i.kt)("inlineCode",{parentName:"p"},"spec.version")," variable by executing ",(0,i.kt)("inlineCode",{parentName:"p"},'kubectl --kubeconfig credentials/kubeconfig patch tc ${tidb_cluster_name} -n ${namespace} --type merge -p \'{"spec":{"version":"${version}"}}'),"."),(0,i.kt)("p",null,"This may take a while to complete. You can watch the process using the following command:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get pods --namespace ${namespace} -o wide --watch\n")),(0,i.kt)("h2",{id:"scale-out-the-tidb-cluster"},"Scale out the TiDB cluster"),(0,i.kt)("p",null,"To scale out the TiDB cluster, modify ",(0,i.kt)("inlineCode",{parentName:"p"},"tikv_count"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"tiflash_count"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"cdc_count"),", or ",(0,i.kt)("inlineCode",{parentName:"p"},"tidb_count")," in the ",(0,i.kt)("inlineCode",{parentName:"p"},"terraform.tfvars")," file, and then run ",(0,i.kt)("inlineCode",{parentName:"p"},"terraform apply")," to scale out the number of nodes for the corresponding components."),(0,i.kt)("p",null,"After the nodes scale out, modify the ",(0,i.kt)("inlineCode",{parentName:"p"},"replicas")," of the corresponding components by running ",(0,i.kt)("inlineCode",{parentName:"p"},"kubectl --kubeconfig credentials/kubeconfig edit tc ${tidb_cluster_name} -n ${namespace}"),"."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("ul",{parentName:"div"},(0,i.kt)("li",{parentName:"ul"},"Because it is impossible to determine which node will be taken offline during the scale-in process, the scale-in of TiDB clusters is currently not supported."),(0,i.kt)("li",{parentName:"ul"},"The scale-out process takes a few minutes. You can watch the status by running ",(0,i.kt)("inlineCode",{parentName:"li"},"kubectl --kubeconfig credentials/kubeconfig get po -n ${namespace} --watch"),".")))),(0,i.kt)("h2",{id:"configure"},"Configure"),(0,i.kt)("h3",{id:"configure-tidb-operator"},"Configure TiDB Operator"),(0,i.kt)("p",null,"You can set the variables in ",(0,i.kt)("inlineCode",{parentName:"p"},"terraform.tfvars")," to configure TiDB Operator. Most configuration items can be modified after you understand the semantics based on the comments of the ",(0,i.kt)("inlineCode",{parentName:"p"},"variable"),". Note that the ",(0,i.kt)("inlineCode",{parentName:"p"},"operator_helm_values")," configuration item can provide a customized ",(0,i.kt)("inlineCode",{parentName:"p"},"values.yaml")," configuration file for TiDB Operator. For example:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Set ",(0,i.kt)("inlineCode",{parentName:"p"},"operator_helm_values")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"terraform.tfvars"),":"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-hcl"},'operator_helm_values = "./my-operator-values.yaml"\n'))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Set ",(0,i.kt)("inlineCode",{parentName:"p"},"operator_helm_values")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"main.tf"),":"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-hcl"},'operator_helm_values = file("./my-operator-values.yaml")\n')))),(0,i.kt)("p",null,"In the default configuration, the Terraform script creates a new VPC. To use the existing VPC, set ",(0,i.kt)("inlineCode",{parentName:"p"},"vpc_id")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"variable.tf"),". In this case, Kubernetes nodes are not deployed in AZs with vSwitch not configured."),(0,i.kt)("h3",{id:"configure-the-tidb-cluster"},"Configure the TiDB cluster"),(0,i.kt)("p",null,"See ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/pingcap/tidb-operator/blob/master/docs/api-references/docs.md"},"TiDB Operator API Documentation")," and ",(0,i.kt)("a",{parentName:"p",href:"/configure-a-tidb-cluster"},"Configure a TiDB Cluster"),"."),(0,i.kt)("h2",{id:"manage-multiple-tidb-clusters"},"Manage multiple TiDB clusters"),(0,i.kt)("p",null,"To manage multiple TiDB clusters in a single Kubernetes cluster, you need to edit ",(0,i.kt)("inlineCode",{parentName:"p"},"./main.tf")," and add the ",(0,i.kt)("inlineCode",{parentName:"p"},"tidb-cluster")," declaration based on your needs. For example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-hcl"},'module "tidb-cluster-dev" {\n  source = "../modules/aliyun/tidb-cluster"\n  providers = {\n    helm = helm.default\n  }\n\n  cluster_name = "dev-cluster"\n  ack          = module.tidb-operator\n\n  pd_count                   = 1\n  tikv_count                 = 1\n  tidb_count                 = 1\n}\n\nmodule "tidb-cluster-staging" {\n  source = "../modules/aliyun/tidb-cluster"\n  providers = {\n    helm = helm.default\n  }\n\n  cluster_name = "staging-cluster"\n  ack          = module.tidb-operator\n\n  pd_count                   = 3\n  tikv_count                 = 3\n  tidb_count                 = 2\n}\n')),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"You need to set a unique ",(0,i.kt)("inlineCode",{parentName:"p"},"cluster_name")," for each TiDB cluster."))),(0,i.kt)("p",null,"All the configurable parameters in ",(0,i.kt)("inlineCode",{parentName:"p"},"tidb-cluster")," are as follows:"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:"left"},"Parameter"),(0,i.kt)("th",{parentName:"tr",align:"left"},"Description"),(0,i.kt)("th",{parentName:"tr",align:"left"},"Default value"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"ack")),(0,i.kt)("td",{parentName:"tr",align:"left"},"The structure that enwraps the target Kubernetes cluster information (required)"),(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"nil"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"cluster_name")),(0,i.kt)("td",{parentName:"tr",align:"left"},"The TiDB cluster name (required and unique)"),(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"nil"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"tidb_version")),(0,i.kt)("td",{parentName:"tr",align:"left"},"The TiDB cluster version"),(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"v3.0.1"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"tidb_cluster_chart_version")),(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"tidb-cluster")," helm chart version"),(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"v1.0.1"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"pd_count")),(0,i.kt)("td",{parentName:"tr",align:"left"},"The number of PD nodes"),(0,i.kt)("td",{parentName:"tr",align:"left"},"3")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"pd_instance_type")),(0,i.kt)("td",{parentName:"tr",align:"left"},"The PD instance type"),(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"ecs.g5.large"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"tikv_count")),(0,i.kt)("td",{parentName:"tr",align:"left"},"The number of TiKV nodes"),(0,i.kt)("td",{parentName:"tr",align:"left"},"3")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"tikv_instance_type")),(0,i.kt)("td",{parentName:"tr",align:"left"},"The TiKV instance type"),(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"ecs.i2.2xlarge"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"tiflash_count")),(0,i.kt)("td",{parentName:"tr",align:"left"},"The count of TiFlash nodes"),(0,i.kt)("td",{parentName:"tr",align:"left"},"2")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"tiflash_instance_type")),(0,i.kt)("td",{parentName:"tr",align:"left"},"The TiFlash instance type"),(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"ecs.i2.2xlarge"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"cdc_count")),(0,i.kt)("td",{parentName:"tr",align:"left"},"The count of TiCDC nodes"),(0,i.kt)("td",{parentName:"tr",align:"left"},"3")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"cdc_instance_type")),(0,i.kt)("td",{parentName:"tr",align:"left"},"The TiCDC instance type"),(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"ecs.c5.2xlarge"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"tidb_count")),(0,i.kt)("td",{parentName:"tr",align:"left"},"The number of TiDB nodes"),(0,i.kt)("td",{parentName:"tr",align:"left"},"2")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"tidb_instance_type")),(0,i.kt)("td",{parentName:"tr",align:"left"},"The TiDB instance type"),(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"ecs.c5.4xlarge"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"monitor_instance_type")),(0,i.kt)("td",{parentName:"tr",align:"left"},"The instance type of monitoring components"),(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"ecs.c5.xlarge"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"override_values")),(0,i.kt)("td",{parentName:"tr",align:"left"},"The ",(0,i.kt)("inlineCode",{parentName:"td"},"values.yaml")," configuration file of the TiDB cluster. You can read it using the ",(0,i.kt)("inlineCode",{parentName:"td"},"file()")," function"),(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"nil"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"local_exec_interpreter")),(0,i.kt)("td",{parentName:"tr",align:"left"},"The interpreter that executes the command line instruction"),(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},'["/bin/sh", "-c"]'))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"create_tidb_cluster_release")),(0,i.kt)("td",{parentName:"tr",align:"left"},"Whether to create the TiDB cluster using Helm"),(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"false"))))),(0,i.kt)("h2",{id:"manage-multiple-kubernetes-clusters"},"Manage multiple Kubernetes clusters"),(0,i.kt)("p",null,"It is recommended to use a separate Terraform module to manage a specific Kubernetes cluster. (A Terraform module is a directory that contains the ",(0,i.kt)("inlineCode",{parentName:"p"},".tf")," script.)"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"deploy/aliyun")," combines multiple reusable Terraform scripts in ",(0,i.kt)("inlineCode",{parentName:"p"},"deploy/modules"),". To manage multiple clusters, perform the following operations in the root directory of the ",(0,i.kt)("inlineCode",{parentName:"p"},"tidb-operator")," project:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Create a directory for each cluster. For example:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"mkdir -p deploy/aliyun-staging\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Refer to ",(0,i.kt)("inlineCode",{parentName:"p"},"main.tf")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"deploy/aliyun")," and write your own script. For example:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-hcl"},'provider "alicloud" {\n    region     = ${REGION}\n    access_key = ${ACCESS_KEY}\n    secret_key = ${SECRET_KEY}\n}\n\nmodule "tidb-operator" {\n    source     = "../modules/aliyun/tidb-operator"\n\n    region          = ${REGION}\n    access_key      = ${ACCESS_KEY}\n    secret_key      = ${SECRET_KEY}\n    cluster_name    = "example-cluster"\n    key_file        = "ssh-key.pem"\n    kubeconfig_file = "kubeconfig"\n}\n\nprovider "helm" {\n    alias    = "default"\n    insecure = true\n    install_tiller = false\n    kubernetes {\n        config_path = module.tidb-operator.kubeconfig_filename\n    }\n}\n\nmodule "tidb-cluster" {\n    source = "../modules/aliyun/tidb-cluster"\n    providers = {\n        helm = helm.default\n    }\n\n    cluster_name = "example-cluster"\n    ack          = module.tidb-operator\n}\n\nmodule "bastion" {\n    source = "../modules/aliyun/bastion"\n\n    bastion_name             = "example-bastion"\n    key_name                 = module.tidb-operator.key_name\n    vpc_id                   = module.tidb-operator.vpc_id\n    vswitch_id               = module.tidb-operator.vswitch_ids[0]\n    enable_ssh_to_worker     = true\n    worker_security_group_id = module.tidb-operator.security_group_id\n}\n')))),(0,i.kt)("p",null,"You can customize this script. For example, you can remove the ",(0,i.kt)("inlineCode",{parentName:"p"},'module "bastion"')," declaration if you do not need the bastion machine."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"You can copy the ",(0,i.kt)("inlineCode",{parentName:"p"},"deploy/aliyun")," directory. But you cannot copy a directory on which the ",(0,i.kt)("inlineCode",{parentName:"p"},"terraform apply")," operation is currently performed. In this case, it is recommended to clone the repository again and then copy it."))),(0,i.kt)("h2",{id:"destroy"},"Destroy"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Refer to ",(0,i.kt)("a",{parentName:"p",href:"/destroy-a-tidb-cluster"},"Destroy a TiDB cluster")," to delete the cluster.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Destroy the ACK cluster by running the following command:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"terraform destroy\n")))),(0,i.kt)("p",null,"If the Kubernetes cluster is not successfully created, the ",(0,i.kt)("inlineCode",{parentName:"p"},"destroy")," operation might return an error and fail. In such cases, manually remove the Kubernetes resources from the local state:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"terraform state list\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"terraform state rm module.ack.alicloud_cs_managed_kubernetes.k8s\n")),(0,i.kt)("p",null,"It may take a long time to finish destroying the cluster."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"You have to manually delete the cloud disk used by the components in the Alibaba Cloud console."))),(0,i.kt)("h2",{id:"limitation"},"Limitation"),(0,i.kt)("p",null,"You cannot change ",(0,i.kt)("inlineCode",{parentName:"p"},"pod cidr"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"service cidr"),", and worker instance types once the cluster is created."))}u.isMDXComponent=!0}}]);