"use strict";(self.webpackChunkpingcap_docs=self.webpackChunkpingcap_docs||[]).push([[3399],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return d}});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var c=r.createContext({}),l=function(e){var t=r.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=l(e.components);return r.createElement(c.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,s=e.originalType,c=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),m=l(n),d=a,f=m["".concat(c,".").concat(d)]||m[d]||p[d]||s;return n?r.createElement(f,i(i({ref:t},u),{},{components:n})):r.createElement(f,i({ref:t},u))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var s=n.length,i=new Array(s);i[0]=m;var o={};for(var c in t)hasOwnProperty.call(t,c)&&(o[c]=t[c]);o.originalType=e,o.mdxType="string"==typeof e?e:a,i[1]=o;for(var l=2;l<s;l++)i[l]=n[l];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},4623:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return o},contentTitle:function(){return c},metadata:function(){return l},assets:function(){return u},toc:function(){return p},default:function(){return d}});var r=n(7462),a=n(3366),s=(n(7294),n(3905)),i=["components"],o={title:"Pause Sync of a TiDB Cluster in Kubernetes",summary:"Introduce how to pause sync of a TiDB cluster in Kubernetes"},c="Pause Sync of a TiDB Cluster in Kubernetes",l={unversionedId:"pause-sync-of-tidb-cluster",id:"pause-sync-of-tidb-cluster",title:"Pause Sync of a TiDB Cluster in Kubernetes",description:"This document introduces how to pause sync of a TiDB cluster in Kubernetes using configuration.",source:"@site/docs/pause-sync-of-tidb-cluster.md",sourceDirName:".",slug:"/pause-sync-of-tidb-cluster",permalink:"/docusaurus-operator/pause-sync-of-tidb-cluster",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/pause-sync-of-tidb-cluster.md",tags:[],version:"current",frontMatter:{title:"Pause Sync of a TiDB Cluster in Kubernetes",summary:"Introduce how to pause sync of a TiDB cluster in Kubernetes"},sidebar:"mySidebar",previous:{title:"Automatic Failover",permalink:"/docusaurus-operator/use-auto-failover"},next:{title:"Maintain Different TiDB Clusters Separately Using Multiple Sets of TiDB Operator",permalink:"/docusaurus-operator/deploy-multiple-tidb-operator"}},u={},p=[{value:"What is sync in TiDB Operator",id:"what-is-sync-in-tidb-operator",level:2},{value:"Use scenarios",id:"use-scenarios",level:2},{value:"Pause sync",id:"pause-sync",level:2},{value:"Resume sync",id:"resume-sync",level:2}],m={toc:p};function d(e){var t=e.components,n=(0,a.Z)(e,i);return(0,s.kt)("wrapper",(0,r.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"pause-sync-of-a-tidb-cluster-in-kubernetes"},"Pause Sync of a TiDB Cluster in Kubernetes"),(0,s.kt)("p",null,"This document introduces how to pause sync of a TiDB cluster in Kubernetes using configuration."),(0,s.kt)("h2",{id:"what-is-sync-in-tidb-operator"},"What is sync in TiDB Operator"),(0,s.kt)("p",null,"In TiDB Operator, controller regulates the state of the TiDB cluster in Kubernetes. The controller constantly compares the desired state recorded in the ",(0,s.kt)("inlineCode",{parentName:"p"},"TidbCluster")," object with the actual state of the TiDB cluster. This process is referred to as ",(0,s.kt)("strong",{parentName:"p"},"sync")," generally. For more details, refer to ",(0,s.kt)("a",{parentName:"p",href:"/docusaurus-operator/architecture"},"TiDB Operator Architecture"),"."),(0,s.kt)("h2",{id:"use-scenarios"},"Use scenarios"),(0,s.kt)("p",null,"Here are some cases where you might need to pause sync of a TiDB cluster in Kubernetes."),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},"Avoid unexpected rolling update"),(0,s.kt)("p",{parentName:"li"},"  To prevent new versions of TiDB Operator from introducing compatibility issues into the clusters, before updating TiDB Operator, you can pause sync of TiDB clusters. After updating TiDB Operator, you can resume syncing clusters one by one, or specify a time for resume. In this way, you can observe how the rolling update of TiDB Operator would affect the cluster.")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},"Avoid multiple rolling restarts"),(0,s.kt)("p",{parentName:"li"},"  In some cases, you might need to continuously modify the cluster over a period of time, but do not want to restart the TiDB cluster many times. To avoid multiple rolling restarts, you can pause sync of the cluster. During the sync pausing, any change of the configuration does not take effect on the cluster. After you finish the modification, resume sync of the TiDB cluster. All changes can be applied in a single rolling restart.")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},"Maintenance window"),(0,s.kt)("p",{parentName:"li"},"  In some situations, you can update or restart the TiDB cluster only during a maintenance window. When outside the maintenance window, you can pause sync of the TiDB cluster, so that any modification to the specs does not take effect. When inside the maintenance window, you can resume sync of the TiDB cluster to allow TiDB cluster to rolling update or restart."))),(0,s.kt)("h2",{id:"pause-sync"},"Pause sync"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},"Execute the following command to edit the TiDB cluster configuration. ",(0,s.kt)("inlineCode",{parentName:"p"},"${cluster_name}")," represents the name of the TiDB cluster, and ",(0,s.kt)("inlineCode",{parentName:"p"},"${namespace}")," refers to the TiDB cluster namespace."),(0,s.kt)("p",{parentName:"li"},'{{< copyable "shell-regular" >}}'),(0,s.kt)("pre",{parentName:"li"},(0,s.kt)("code",{parentName:"pre",className:"language-shell"},'kubectl patch tc ${cluster_name} -n ${namespace} --type merge -p \'{"spec":{"paused": true}}\'\n'))),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},"To confirm the sync status of a TiDB cluster, execute the following command. ",(0,s.kt)("inlineCode",{parentName:"p"},"${pod_name}")," is the name of tidb-controller-manager Pod, and ",(0,s.kt)("inlineCode",{parentName:"p"},"${namespace}")," is the namespace of TiDB Operator."),(0,s.kt)("p",{parentName:"li"},'{{< copyable "shell-regular" >}}'),(0,s.kt)("pre",{parentName:"li"},(0,s.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl logs ${pod_name} -n ${namespace} | grep paused\n")),(0,s.kt)("p",{parentName:"li"},"The expected output is as follows. The sync of all components in the TiDB cluster is paused."),(0,s.kt)("pre",{parentName:"li"},(0,s.kt)("code",{parentName:"pre"},"I1207 11:09:59.029949       1 pd_member_manager.go:92] tidb cluster default/basic is paused, skip syncing for pd service\nI1207 11:09:59.029977       1 pd_member_manager.go:136] tidb cluster default/basic is paused, skip syncing for pd headless service\nI1207 11:09:59.035437       1 pd_member_manager.go:191] tidb cluster default/basic is paused, skip syncing for pd statefulset\nI1207 11:09:59.035462       1 tikv_member_manager.go:116] tikv cluster default/basic is paused, skip syncing for tikv service\nI1207 11:09:59.036855       1 tikv_member_manager.go:175] tikv cluster default/basic is paused, skip syncing for tikv statefulset\nI1207 11:09:59.036886       1 tidb_member_manager.go:132] tidb cluster default/basic is paused, skip syncing for tidb headless service\nI1207 11:09:59.036895       1 tidb_member_manager.go:258] tidb cluster default/basic is paused, skip syncing for tidb service\nI1207 11:09:59.039358       1 tidb_member_manager.go:188] tidb cluster default/basic is paused, skip syncing for tidb statefulset\n")))),(0,s.kt)("h2",{id:"resume-sync"},"Resume sync"),(0,s.kt)("p",null,"To resume the sync of the TiDB cluster, configure ",(0,s.kt)("inlineCode",{parentName:"p"},"spec.paused: false")," in the TidbCluster CR."),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},"Execute the following command to edit the TiDB cluster configuration. ",(0,s.kt)("inlineCode",{parentName:"p"},"${cluster_name}")," represents the name of the TiDB cluster, and ",(0,s.kt)("inlineCode",{parentName:"p"},"${namespace}")," refers to the TiDB cluster namespace."),(0,s.kt)("p",{parentName:"li"},'{{< copyable "shell-regular" >}}'),(0,s.kt)("pre",{parentName:"li"},(0,s.kt)("code",{parentName:"pre",className:"language-shell"},'kubectl patch tc ${cluster_name} -n ${namespace} --type merge -p \'{"spec":{"paused": false}}\'\n'))),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},"To confirm the sync status of a TiDB cluster, execute the following command. ",(0,s.kt)("inlineCode",{parentName:"p"},"${pod_name}")," represents the name of the tidb-controller-manager Pod, and ",(0,s.kt)("inlineCode",{parentName:"p"},"${namespace}")," represents the namespace of TiDB Operator."),(0,s.kt)("p",{parentName:"li"},'{{< copyable "shell-regular" >}}'),(0,s.kt)("pre",{parentName:"li"},(0,s.kt)("code",{parentName:"pre",className:"language-shell"},'kubectl logs ${pod_name} -n ${namespace} | grep "Finished syncing TidbCluster"\n')),(0,s.kt)("p",{parentName:"li"},"The expected output is as follows. The ",(0,s.kt)("inlineCode",{parentName:"p"},"finished syncing")," timestamp is later than the ",(0,s.kt)("inlineCode",{parentName:"p"},"paused")," timestamp, which indicates that sync of the TiDB cluster has been resumed."),(0,s.kt)("pre",{parentName:"li"},(0,s.kt)("code",{parentName:"pre"},'I1207 11:14:59.361353       1 tidb_cluster_controller.go:136] Finished syncing TidbCluster "default/basic" (368.816685ms)\nI1207 11:15:28.982910       1 tidb_cluster_controller.go:136] Finished syncing TidbCluster "default/basic" (97.486818ms)\nI1207 11:15:29.360446       1 tidb_cluster_controller.go:136] Finished syncing TidbCluster "default/basic" (377.51187ms)\n')))))}d.isMDXComponent=!0}}]);