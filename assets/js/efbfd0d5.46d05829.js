"use strict";(self.webpackChunkpingcap_docs=self.webpackChunkpingcap_docs||[]).push([[994],{3905:function(e,t,a){a.d(t,{Zo:function(){return m},kt:function(){return u}});var r=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},o=Object.keys(e);for(r=0;r<o.length;r++)a=o[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)a=o[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var c=r.createContext({}),p=function(e){var t=r.useContext(c),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},m=function(e){var t=p(e.components);return r.createElement(c.Provider,{value:t},e.children)},l={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,o=e.originalType,c=e.parentName,m=i(e,["components","mdxType","originalType","parentName"]),d=p(a),u=n,h=d["".concat(c,".").concat(u)]||d[u]||l[u]||o;return a?r.createElement(h,s(s({ref:t},m),{},{components:a})):r.createElement(h,s({ref:t},m))}));function u(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=a.length,s=new Array(o);s[0]=d;var i={};for(var c in t)hasOwnProperty.call(t,c)&&(i[c]=t[c]);i.originalType=e,i.mdxType="string"==typeof e?e:n,s[1]=i;for(var p=2;p<o;p++)s[p]=a[p];return r.createElement.apply(null,s)}return r.createElement.apply(null,a)}d.displayName="MDXCreateElement"},5428:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return i},contentTitle:function(){return c},metadata:function(){return p},assets:function(){return m},toc:function(){return l},default:function(){return u}});var r=a(7462),n=a(3366),o=(a(7294),a(3905)),s=["components"],i={title:"Grant Permissions to Remote Storage",summary:"Learn how to grant permissions to access remote storage for backup and restore."},c="Grant Permissions to Remote Storage",p={unversionedId:"grant-permissions-to-remote-storage",id:"grant-permissions-to-remote-storage",title:"Grant Permissions to Remote Storage",description:"This document describes how to grant permissions to access remote storage for backup and restore. During the backup process, TiDB cluster data is backed up to the remote storage. During the restore process, the backup data is restored from the remote storage to the TiDB cluster.",source:"@site/docs/grant-permissions-to-remote-storage.md",sourceDirName:".",slug:"/grant-permissions-to-remote-storage",permalink:"/docusaurus-operator/grant-permissions-to-remote-storage",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/grant-permissions-to-remote-storage.md",tags:[],version:"current",frontMatter:{title:"Grant Permissions to Remote Storage",summary:"Learn how to grant permissions to access remote storage for backup and restore."},sidebar:"mySidebar",previous:{title:"Backup and Restore Overview",permalink:"/docusaurus-operator/backup-restore-overview"},next:{title:"Amazon S3 Compatible Storage",permalink:"/docusaurus-operator/category/amazon-s3-compatible-storage"}},m={},l=[{value:"AWS account permissions",id:"aws-account-permissions",level:2},{value:"Grant permissions by AccessKey and SecretKey",id:"grant-permissions-by-accesskey-and-secretkey",level:3},{value:"Grant permissions by associating IAM with Pod",id:"grant-permissions-by-associating-iam-with-pod",level:3},{value:"Grant permissions by associating IAM with ServiceAccount",id:"grant-permissions-by-associating-iam-with-serviceaccount",level:3},{value:"GCS account permissions",id:"gcs-account-permissions",level:2},{value:"Grant permissions by the service account",id:"grant-permissions-by-the-service-account",level:3}],d={toc:l};function u(e){var t=e.components,a=(0,n.Z)(e,s);return(0,o.kt)("wrapper",(0,r.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"grant-permissions-to-remote-storage"},"Grant Permissions to Remote Storage"),(0,o.kt)("p",null,"This document describes how to grant permissions to access remote storage for backup and restore. During the backup process, TiDB cluster data is backed up to the remote storage. During the restore process, the backup data is restored from the remote storage to the TiDB cluster."),(0,o.kt)("h2",{id:"aws-account-permissions"},"AWS account permissions"),(0,o.kt)("p",null,"Amazon Web Service (AWS) provides different methods to grant permissions for different types of Kubernetes clusters. This document describes the following three methods."),(0,o.kt)("h3",{id:"grant-permissions-by-accesskey-and-secretkey"},"Grant permissions by AccessKey and SecretKey"),(0,o.kt)("p",null,"The AWS client can read ",(0,o.kt)("inlineCode",{parentName:"p"},"AWS_ACCESS_KEY_ID")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"AWS_SECRET_ACCESS_KEY")," from the process environment variables to obtain the associated user or role permissions."),(0,o.kt)("p",null,"Create the ",(0,o.kt)("inlineCode",{parentName:"p"},"s3-secret")," secret by running the following command. Use the AWS account's AccessKey and SecretKey. The secret stores the credential used for accessing S3-compatible storage."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl create secret generic s3-secret --from-literal=access_key=xxx --from-literal=secret_key=yyy --namespace=test1\n")),(0,o.kt)("h3",{id:"grant-permissions-by-associating-iam-with-pod"},"Grant permissions by associating IAM with Pod"),(0,o.kt)("p",null,"If you associate the user's ",(0,o.kt)("a",{parentName:"p",href:"https://aws.amazon.com/cn/iam/"},"IAM")," role with the resources of the running Pods, the processes running in the Pods can have the permissions of the role. This method is provided by ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/jtblin/kube2iam"},(0,o.kt)("inlineCode",{parentName:"a"},"kube2iam")),"."),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("ul",{parentName:"div"},(0,o.kt)("li",{parentName:"ul"},"When you use this method to grant permissions, you can ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/jtblin/kube2iam#usage"},"create the ",(0,o.kt)("inlineCode",{parentName:"a"},"kube2iam")," environment")," in the Kubernetes cluster and deploy TiDB Operator and the TiDB cluster."),(0,o.kt)("li",{parentName:"ul"},"This method is not applicable to the ",(0,o.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/concepts/policy/pod-security-policy"},(0,o.kt)("inlineCode",{parentName:"a"},"hostNetwork"))," mode. Make sure the value of ",(0,o.kt)("inlineCode",{parentName:"li"},"spec.tikv.hostNetwork")," is set to ",(0,o.kt)("inlineCode",{parentName:"li"},"false"),".")))),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Create an IAM role."),(0,o.kt)("p",{parentName:"li"},"First, ",(0,o.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html"},"create an IAM User")," for your account."),(0,o.kt)("p",{parentName:"li"},"Then, Give the required permission to the IAM role you have created. Refer to ",(0,o.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_manage-attach-detach.html"},"Adding and Removing IAM Identity Permissions")," for details."),(0,o.kt)("p",{parentName:"li"},"Because the ",(0,o.kt)("inlineCode",{parentName:"p"},"Backup")," CR needs to access the Amazon S3 storage, the IAM role is granted the ",(0,o.kt)("inlineCode",{parentName:"p"},"AmazonS3FullAccess")," permission.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Associate IAM with the TiKV Pod:"),(0,o.kt)("p",{parentName:"li"},"When you use BR to back up TiDB data, the TiKV Pod also needs to perform read and write operations on S3-compatible storage as the BR Pod does. Therefore, you need to add annotations to the TiKV Pod to associate it with the IAM role."),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'kubectl patch tc demo1 -n test1 --type merge -p \'{"spec":{"tikv":{"annotations":{"iam.amazonaws.com/role":"arn:aws:iam::123456789012:role/user"}}}}\'\n')),(0,o.kt)("p",{parentName:"li"},"After the TiKV Pod is restarted, check whether the Pod has the annotation."))),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},(0,o.kt)("inlineCode",{parentName:"p"},"arn:aws:iam::123456789012:role/user")," is the IAM role created in Step 1."))),(0,o.kt)("h3",{id:"grant-permissions-by-associating-iam-with-serviceaccount"},"Grant permissions by associating IAM with ServiceAccount"),(0,o.kt)("p",null,"If you associate the user's ",(0,o.kt)("a",{parentName:"p",href:"https://aws.amazon.com/cn/iam/"},"IAM")," role with ",(0,o.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#serviceaccount"},(0,o.kt)("inlineCode",{parentName:"a"},"serviceAccount"))," of Kubernetes, the Pods using the ",(0,o.kt)("inlineCode",{parentName:"p"},"serviceAccount")," can have the permissions of the role. This method is provided by ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/aws/amazon-eks-pod-identity-webhook"},(0,o.kt)("inlineCode",{parentName:"a"},"EKS Pod Identity Webhook")),"."),(0,o.kt)("p",null,"When you use this method to grant permissions, you can ",(0,o.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/create-cluster.html"},"create the EKS cluster")," and deploy TiDB Operator and the TiDB cluster."),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Enable the IAM role for the ",(0,o.kt)("inlineCode",{parentName:"p"},"serviceAccount")," in the cluster:"),(0,o.kt)("p",{parentName:"li"},"Refer to ",(0,o.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html"},"AWS documentation"),".")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Create the IAM role:"),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/eks/latest/userguide/create-service-account-iam-policy-and-role.html"},"Create an IAM role")," and grant the ",(0,o.kt)("inlineCode",{parentName:"p"},"AmazonS3FullAccess")," permissions to the role. Edit the role's ",(0,o.kt)("inlineCode",{parentName:"p"},"Trust relationships"),".")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Associate IAM with the ",(0,o.kt)("inlineCode",{parentName:"p"},"ServiceAccount")," resources."),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl annotate sa tidb-backup-manager -n eks.amazonaws.com/role-arn=arn:aws:iam::123456789012:role/user --namespace=test1\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Associate the ",(0,o.kt)("inlineCode",{parentName:"p"},"ServiceAccount")," with the TiKV Pod:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'kubectl patch tc demo1 -n test1 --type merge -p \'{"spec":{"tikv":{"serviceAccount": "tidb-backup-manager"}}}\'\n')),(0,o.kt)("p",{parentName:"li"},"Modify the value of ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.tikv.serviceAccount")," to ",(0,o.kt)("inlineCode",{parentName:"p"},"tidb-backup-manager"),". After the TiKV Pod is restarted, check whether the Pod's ",(0,o.kt)("inlineCode",{parentName:"p"},"serviceAccountName")," is changed."))),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},(0,o.kt)("inlineCode",{parentName:"p"},"arn:aws:iam::123456789012:role/user")," is the IAM role created in Step 2."))),(0,o.kt)("h2",{id:"gcs-account-permissions"},"GCS account permissions"),(0,o.kt)("h3",{id:"grant-permissions-by-the-service-account"},"Grant permissions by the service account"),(0,o.kt)("p",null,"Create the ",(0,o.kt)("inlineCode",{parentName:"p"},"gcs-secret")," secret which stores the credential used to access GCS. The ",(0,o.kt)("inlineCode",{parentName:"p"},"google-credentials.json")," file stores the service account key that you have downloaded from the GCP console. Refer to ",(0,o.kt)("a",{parentName:"p",href:"https://cloud.google.com/docs/authentication/getting-started"},"GCP documentation")," for details."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl create secret generic gcs-secret --from-file=credentials=./google-credentials.json -n test1\n")))}u.isMDXComponent=!0}}]);