"use strict";(self.webpackChunkpingcap_docs=self.webpackChunkpingcap_docs||[]).push([[5462],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return h}});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=c(n),h=o,m=p["".concat(l,".").concat(h)]||p[h]||d[h]||i;return n?a.createElement(m,r(r({ref:t},u),{},{components:n})):a.createElement(m,r({ref:t},u))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,r=new Array(i);r[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,r[1]=s;for(var c=2;c<i;c++)r[c]=n[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},9203:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return c},assets:function(){return u},toc:function(){return d},default:function(){return h}});var a=n(7462),o=n(3366),i=(n(7294),n(3905)),r=["components"],s={title:"Common Deployment Failures of TiDB in Kubernetes",summary:"Learn the common deployment failures of TiDB in Kubernetes and their solutions."},l="Common Deployment Failures of TiDB in Kubernetes",c={unversionedId:"deploy-failures",id:"deploy-failures",title:"Common Deployment Failures of TiDB in Kubernetes",description:"This document describes the common deployment failures of TiDB in Kubernetes and their solutions.",source:"@site/docs/deploy-failures.md",sourceDirName:".",slug:"/deploy-failures",permalink:"/deploy-failures",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/deploy-failures.md",tags:[],version:"current",frontMatter:{title:"Common Deployment Failures of TiDB in Kubernetes",summary:"Learn the common deployment failures of TiDB in Kubernetes and their solutions."},sidebar:"mySidebar",previous:{title:"Tips for troubleshooting TiDB in Kubernetes",permalink:"/tips"},next:{title:"Common Cluster Exceptions of TiDB in Kubernetes",permalink:"/exceptions"}},u={},d=[{value:"The Pod is not created normally",id:"the-pod-is-not-created-normally",level:2},{value:"The Pod is in the Pending state",id:"the-pod-is-in-the-pending-state",level:2},{value:"CPU or memory resources are insufficient",id:"cpu-or-memory-resources-are-insufficient",level:3},{value:"StorageClass of the PVC does not exist",id:"storageclass-of-the-pvc-does-not-exist",level:3},{value:"Insufficient available PVs",id:"insufficient-available-pvs",level:3},{value:"The high availability scheduling policy of tidb-scheduler is not satisfied",id:"the-high-availability-scheduling-policy-of-tidb-scheduler-is-not-satisfied",level:2},{value:"The Pod is in the <code>CrashLoopBackOff</code> state",id:"the-pod-is-in-the-crashloopbackoff-state",level:2},{value:"View the log of the current container",id:"view-the-log-of-the-current-container",level:3},{value:"View the log when the container was last restarted",id:"view-the-log-when-the-container-was-last-restarted",level:3},{value:"&quot;cluster id mismatch&quot;",id:"cluster-id-mismatch",level:3},{value:"<code>ulimit</code> is not big enough",id:"ulimit-is-not-big-enough",level:3},{value:"Other causes",id:"other-causes",level:3}],p={toc:d};function h(e){var t=e.components,n=(0,o.Z)(e,r);return(0,i.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"common-deployment-failures-of-tidb-in-kubernetes"},"Common Deployment Failures of TiDB in Kubernetes"),(0,i.kt)("p",null,"This document describes the common deployment failures of TiDB in Kubernetes and their solutions."),(0,i.kt)("h2",{id:"the-pod-is-not-created-normally"},"The Pod is not created normally"),(0,i.kt)("p",null,"After creating a cluster, if the Pod is not created, you can diagnose it using the following commands:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get tidbclusters -n ${namespace} && \\\nkubectl describe tidbclusters -n ${namespace} ${cluster_name} && \\\nkubectl get statefulsets -n ${namespace} && \\\nkubectl describe statefulsets -n ${namespace} ${cluster_name}-pd\n")),(0,i.kt)("p",null,"After creating a backup/restore task, if the Pod is not created, you can perform a diagnostic operation by executing the following commands:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get backups -n ${namespace}\nkubectl get jobs -n ${namespace}\nkubectl describe backups -n ${namespace} ${backup_name}\nkubectl describe backupschedules -n ${namespace} ${backupschedule_name}\nkubectl describe jobs -n ${namespace} ${backupjob_name}\nkubectl describe restores -n ${namespace} ${restore_name}\n")),(0,i.kt)("h2",{id:"the-pod-is-in-the-pending-state"},"The Pod is in the Pending state"),(0,i.kt)("p",null,"The Pending state of a Pod is usually caused by conditions of insufficient resources, for example:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The ",(0,i.kt)("inlineCode",{parentName:"li"},"StorageClass")," of the PVC used by PD, TiKV, TiFlash, Pump, Monitor, Backup, and Restore Pods does not exist or the PV is insufficient."),(0,i.kt)("li",{parentName:"ul"},"No nodes in the Kubernetes cluster can satisfy the CPU or memory resources requested by the Pod"),(0,i.kt)("li",{parentName:"ul"},"The number of TiKV or PD replicas and the number of nodes in the cluster do not satisfy the high availability scheduling policy of tidb-scheduler")),(0,i.kt)("p",null,"You can check the specific reason for Pending by using the ",(0,i.kt)("inlineCode",{parentName:"p"},"kubectl describe pod")," command:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl describe po -n ${namespace} ${pod_name}\n")),(0,i.kt)("h3",{id:"cpu-or-memory-resources-are-insufficient"},"CPU or memory resources are insufficient"),(0,i.kt)("p",null,"If the CPU or memory resources are insufficient, you can lower the CPU or memory resources requested by the corresponding component for scheduling, or add a new Kubernetes node."),(0,i.kt)("h3",{id:"storageclass-of-the-pvc-does-not-exist"},"StorageClass of the PVC does not exist"),(0,i.kt)("p",null,"If the ",(0,i.kt)("inlineCode",{parentName:"p"},"StorageClass")," of the PVC cannot be found, take the following steps:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Get the available ",(0,i.kt)("inlineCode",{parentName:"p"},"StorageClass")," in the cluster:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get storageclass\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Change ",(0,i.kt)("inlineCode",{parentName:"p"},"storageClassName")," to the name of the ",(0,i.kt)("inlineCode",{parentName:"p"},"StorageClass")," available in the cluster.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Update the configuration file:"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"If you want to start the TiDB cluster, execute ",(0,i.kt)("inlineCode",{parentName:"li"},"kubectl edit tc ${cluster_name} -n ${namespace}")," to update the cluster."),(0,i.kt)("li",{parentName:"ul"},"If you want to run a backup/restore task, first execute ",(0,i.kt)("inlineCode",{parentName:"li"},"kubectl delete bk ${backup_name} -n ${namespace}")," to delete the old backup/restore task, and then execute ",(0,i.kt)("inlineCode",{parentName:"li"},"kubectl apply -f backup.yaml")," to create a new backup/restore task."))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Delete StatefulSet and the corresponding PVCs:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl delete pvc -n ${namespace} ${pvc_name} && \\\nkubectl delete sts -n ${namespace} ${statefulset_name}\n")))),(0,i.kt)("h3",{id:"insufficient-available-pvs"},"Insufficient available PVs"),(0,i.kt)("p",null,"If a ",(0,i.kt)("inlineCode",{parentName:"p"},"StorageClass")," exists in the cluster but the available PV is insufficient, you need to add PV resources correspondingly. For Local PV, you can expand it by referring to ",(0,i.kt)("a",{parentName:"p",href:"/configure-storage-class#local-pv-configuration"},"Local PV Configuration"),"."),(0,i.kt)("h2",{id:"the-high-availability-scheduling-policy-of-tidb-scheduler-is-not-satisfied"},"The high availability scheduling policy of tidb-scheduler is not satisfied"),(0,i.kt)("p",null,"tidb-scheduler has a high availability scheduling policy for PD and TiKV. For the same TiDB cluster, if there are N replicas of TiKV or PD, then the number of PD Pods that can be scheduled to each node is ",(0,i.kt)("inlineCode",{parentName:"p"},"M=(N-1)/2")," (if N<3, then M=1) at most, and the number of TiKV Pods that can be scheduled to each node is ",(0,i.kt)("inlineCode",{parentName:"p"},"M=ceil(N/3)")," (if N<3, then M=1; ",(0,i.kt)("inlineCode",{parentName:"p"},"ceil")," means rounding up) at most."),(0,i.kt)("p",null,"If the Pod's state becomes ",(0,i.kt)("inlineCode",{parentName:"p"},"Pending")," because the high availability scheduling policy is not satisfied, you need to add more nodes in the cluster."),(0,i.kt)("h2",{id:"the-pod-is-in-the-crashloopbackoff-state"},"The Pod is in the ",(0,i.kt)("inlineCode",{parentName:"h2"},"CrashLoopBackOff")," state"),(0,i.kt)("p",null,"A Pod in the ",(0,i.kt)("inlineCode",{parentName:"p"},"CrashLoopBackOff")," state means that the container in the Pod repeatedly aborts (in the loop of abort - restart by ",(0,i.kt)("inlineCode",{parentName:"p"},"kubelet")," - abort). There are many potential causes of ",(0,i.kt)("inlineCode",{parentName:"p"},"CrashLoopBackOff"),"."),(0,i.kt)("h3",{id:"view-the-log-of-the-current-container"},"View the log of the current container"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl -n ${namespace} logs -f ${pod_name}\n")),(0,i.kt)("h3",{id:"view-the-log-when-the-container-was-last-restarted"},"View the log when the container was last restarted"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl -n ${namespace} logs -p ${pod_name}\n")),(0,i.kt)("p",null,"After checking the error messages in the log, you can refer to ",(0,i.kt)("a",{parentName:"p",href:"https://pingcap.com/docs/stable/how-to/troubleshoot/cluster-setup#cannot-start-tidb-server"},"Cannot start ",(0,i.kt)("inlineCode",{parentName:"a"},"tidb-server")),", ",(0,i.kt)("a",{parentName:"p",href:"https://pingcap.com/docs/stable/how-to/troubleshoot/cluster-setup#cannot-start-tikv-server"},"Cannot start ",(0,i.kt)("inlineCode",{parentName:"a"},"tikv-server")),", and ",(0,i.kt)("a",{parentName:"p",href:"https://pingcap.com/docs/stable/how-to/troubleshoot/cluster-setup#cannot-start-pd-server"},"Cannot start ",(0,i.kt)("inlineCode",{parentName:"a"},"pd-server"))," for further troubleshooting."),(0,i.kt)("h3",{id:"cluster-id-mismatch"},'"cluster id mismatch"'),(0,i.kt)("p",null,'When the "cluster id mismatch" message appears in the TiKV Pod log, the TiKV Pod might have used old data from other or previous TiKV Pod. If the data on the local disk remain uncleared when you configure local storage in the cluster, or the data is not recycled by the local volume provisioner due to a forced deletion of PV, this error might occur.'),(0,i.kt)("p",null,"If you confirm that the TiKV should join the cluster as a new node and that the data on the PV should be deleted, you can delete the TiKV Pod and the corresponding PVC. The TiKV Pod automatically rebuilds and binds the new PV for use. When configuring local storage, delete local storage on the machine to avoid Kubernetes using old data. In cluster operation and maintenance, manage PV using the local volume provisioner and do not delete it forcibly. You can manage the lifecycle of PV by creating, deleting PVCs, and setting ",(0,i.kt)("inlineCode",{parentName:"p"},"reclaimPolicy")," for the PV."),(0,i.kt)("h3",{id:"ulimit-is-not-big-enough"},(0,i.kt)("inlineCode",{parentName:"h3"},"ulimit")," is not big enough"),(0,i.kt)("p",null,"TiKV might fail to start when ",(0,i.kt)("inlineCode",{parentName:"p"},"ulimit")," is not big enough. In this case, you can modify the ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/security/limits.conf")," file of the Kubernetes node to increase the ",(0,i.kt)("inlineCode",{parentName:"p"},"ulimit"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"root soft nofile 1000000\nroot hard nofile 1000000\nroot soft core unlimited\nroot soft stack 10240\n")),(0,i.kt)("h3",{id:"other-causes"},"Other causes"),(0,i.kt)("p",null,"If you cannot confirm the cause from the log and ",(0,i.kt)("inlineCode",{parentName:"p"},"ulimit")," is also a normal value, troubleshoot the issue by ",(0,i.kt)("a",{parentName:"p",href:"/tips#use-the-diagnostic-mode"},"using the diagnostic mode"),"."))}h.isMDXComponent=!0}}]);