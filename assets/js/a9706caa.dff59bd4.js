"use strict";(self.webpackChunkpingcap_docs=self.webpackChunkpingcap_docs||[]).push([[4960],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return d}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),m=p(n),d=r,k=m["".concat(s,".").concat(d)]||m[d]||u[d]||l;return n?a.createElement(k,o(o({ref:t},c),{},{components:n})):a.createElement(k,o({ref:t},c))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,o=new Array(l);o[0]=m;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:r,o[1]=i;for(var p=2;p<l;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},1902:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return i},contentTitle:function(){return s},metadata:function(){return p},assets:function(){return c},toc:function(){return u},default:function(){return d}});var a=n(7462),r=n(3366),l=(n(7294),n(3905)),o=["components"],i={title:"Build Multiple Interconnected AWS EKS Clusters",summary:"Learn how to build multiple interconnected AWS EKS clusters and prepare for deploying a TiDB cluster across multiple EKS clusters."},s="Build Multiple Interconnected AWS EKS Clusters",p={unversionedId:"build-multi-aws-eks",id:"build-multi-aws-eks",title:"Build Multiple Interconnected AWS EKS Clusters",description:"This document describes how to create multiple AWS EKS clusters and configure network peering between these clusters. These interconnected clusters can be used for deploying TiDB clusters across multiple Kubernetes clusters. The example in this document shows how to configure three-cluster network peering.",source:"@site/docs/build-multi-aws-eks.md",sourceDirName:".",slug:"/build-multi-aws-eks",permalink:"/build-multi-aws-eks",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/build-multi-aws-eks.md",tags:[],version:"current",frontMatter:{title:"Build Multiple Interconnected AWS EKS Clusters",summary:"Learn how to build multiple interconnected AWS EKS clusters and prepare for deploying a TiDB cluster across multiple EKS clusters."},sidebar:"mySidebar",previous:{title:"Deploy the HTAP Storage Engine Tiflash for an Existing TiDB Cluster",permalink:"/deploy-tiflash"},next:{title:"Build Multiple Interconnected GCP GKE Clusters",permalink:"/build-multi-gcp-gke"}},c={},u=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Step 1. Start the Kubernetes cluster",id:"step-1-start-the-kubernetes-cluster",level:2},{value:"Step 2. Configure the network",id:"step-2-configure-the-network",level:2},{value:"Set up VPC peering",id:"set-up-vpc-peering",level:3},{value:"Update the security groups for the instances",id:"update-the-security-groups-for-the-instances",level:3},{value:"Configure load balancers",id:"configure-load-balancers",level:3},{value:"Configure CoreDNS",id:"configure-coredns",level:3},{value:"Step 3. Verify the network interconnectivity",id:"step-3-verify-the-network-interconnectivity",level:2},{value:"Step 4. Deploy TiDB Operator",id:"step-4-deploy-tidb-operator",level:2},{value:"Step 5. Deploy TiDB clusters",id:"step-5-deploy-tidb-clusters",level:2},{value:"What&#39;s next",id:"whats-next",level:2}],m={toc:u};function d(e){var t=e.components,n=(0,r.Z)(e,o);return(0,l.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"build-multiple-interconnected-aws-eks-clusters"},"Build Multiple Interconnected AWS EKS Clusters"),(0,l.kt)("p",null,"This document describes how to create multiple AWS EKS clusters and configure network peering between these clusters. These interconnected clusters can be used for ",(0,l.kt)("a",{parentName:"p",href:"/deploy-tidb-cluster-across-multiple-kubernetes"},"deploying TiDB clusters across multiple Kubernetes clusters"),". The example in this document shows how to configure three-cluster network peering."),(0,l.kt)("p",null,"If you need to deploy TiDB on a single AWS EKS cluster, refer to ",(0,l.kt)("a",{parentName:"p",href:"/deploy-on-aws-eks"},"Deploy TiDB on AWS EKS"),"."),(0,l.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,l.kt)("p",null,"Before you deploy EKS clusters, make sure you have completed the following preparations:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"Install ",(0,l.kt)("a",{parentName:"p",href:"https://helm.sh/docs/intro/install/"},"Helm 3"),". You need to use Helm to install TiDB Operator.")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"Complete all steps in ",(0,l.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/eks/latest/userguide/getting-started-eksctl.html"},"Getting started with Amazon EKS\u2014eksctl"),"."),(0,l.kt)("p",{parentName:"li"},"  This tutorial includes the following tasks:"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"Install and configure the AWS CLI (",(0,l.kt)("inlineCode",{parentName:"li"},"awscli"),")."),(0,l.kt)("li",{parentName:"ul"},"Install and configure the CLI for creating Kubernetes clusters (",(0,l.kt)("inlineCode",{parentName:"li"},"eksctl"),")."),(0,l.kt)("li",{parentName:"ul"},"Install the Kubernetes CLI (",(0,l.kt)("inlineCode",{parentName:"li"},"kubectl"),")"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"Grant AWS Access Key the ",(0,l.kt)("a",{parentName:"p",href:"https://eksctl.io/usage/minimum-iam-policies/"},"minimum permissions required for ",(0,l.kt)("inlineCode",{parentName:"a"},"eksctl"))," and the ",(0,l.kt)("a",{parentName:"p",href:"https://aws-quickstart.github.io/quickstart-linux-bastion/#_aws_account"},"permissions required for creating a Linux bastion"),"."))),(0,l.kt)("p",null,"To verify whether you have correctly configured the AWS CLI, run the ",(0,l.kt)("inlineCode",{parentName:"p"},"aws configure list")," command. If the output shows the values of ",(0,l.kt)("inlineCode",{parentName:"p"},"access_key")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"secret_key"),", you have successfully configured the AWS CLI. Otherwise, you need to reconfigure the AWS CLI."),(0,l.kt)("h2",{id:"step-1-start-the-kubernetes-cluster"},"Step 1. Start the Kubernetes cluster"),(0,l.kt)("p",null,"Define the configuration files of three EKS clusters as ",(0,l.kt)("inlineCode",{parentName:"p"},"cluster_1.yaml"),", ",(0,l.kt)("inlineCode",{parentName:"p"},"cluster_2.yaml"),", and ",(0,l.kt)("inlineCode",{parentName:"p"},"cluster_3.yaml"),", and create three clusters using ",(0,l.kt)("inlineCode",{parentName:"p"},"eksctl"),"."),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Define the configuration file of cluster 1, and create cluster 1."),(0,l.kt)("ol",{parentName:"li"},(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Save the following content as ",(0,l.kt)("inlineCode",{parentName:"p"},"cluster_1.yaml"),". ",(0,l.kt)("inlineCode",{parentName:"p"},"${cluster_1}")," is the name of the EKS cluster. ",(0,l.kt)("inlineCode",{parentName:"p"},"${region_1}")," is the Region that the EKS cluster is deployed in. ",(0,l.kt)("inlineCode",{parentName:"p"},"${cidr_block_1}")," is the CIDR block for the VPC that the EKS cluster is deployed in."),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: eksctl.io/v1alpha5\nkind: ClusterConfig\n\nmetadata:\n  name: ${cluster_1}\n  region: ${region_1}\n\n# nodeGroups ...\n\nvpc:\n  cidr: ${cidr_block_1}\n")),(0,l.kt)("p",{parentName:"li"},"For the configuration of the ",(0,l.kt)("inlineCode",{parentName:"p"},"nodeGroups")," field, refer to ",(0,l.kt)("a",{parentName:"p",href:"/deploy-on-aws-eks#create-an-eks-cluster-and-a-node-pool"},"Create an EKS cluster and a node pool"),".")),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Create cluster 1 by running the following command:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"eksctl create cluster -f cluster_1.yaml\n")))),(0,l.kt)("p",{parentName:"li"},"After running the command above, wait until the EKS cluster is successfully created and the node group is created and added to the EKS cluster. This process might take 5 to 20 minutes. For more cluster configuration, refer to ",(0,l.kt)("a",{parentName:"p",href:"https://eksctl.io/usage/creating-and-managing-clusters/#using-config-files"},"Using Config Files"),".")),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Follow the instructions in the previous step and create cluster 2 and cluster 3."),(0,l.kt)("p",{parentName:"li"},"The CIDR block for each EKS cluster ",(0,l.kt)("strong",{parentName:"p"},"must not")," overlap with that of each other."),(0,l.kt)("p",{parentName:"li"},"In the following sections:"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"${cluster_1}"),", ",(0,l.kt)("inlineCode",{parentName:"li"},"${cluster_2}"),", and ",(0,l.kt)("inlineCode",{parentName:"li"},"${cluster_3}")," refer to the cluster names."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"${region_1}"),", ",(0,l.kt)("inlineCode",{parentName:"li"},"${region_2}"),", and ",(0,l.kt)("inlineCode",{parentName:"li"},"${region_3}")," refer to the Regions that the clusters are deployed in."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"${cidr_block_1}"),", ",(0,l.kt)("inlineCode",{parentName:"li"},"${cidr_block_2}"),", and ",(0,l.kt)("inlineCode",{parentName:"li"},"${cidr_block_3}")," refer to the CIDR blocks for the VPCs that the clusters are deployed in."))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"After the clusters are created, obtain the Kubernetes context of each cluster. The contexts are used in the subsequent ",(0,l.kt)("inlineCode",{parentName:"p"},"kubectl")," commands."),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl config get-contexts\n")),(0,l.kt)("details",null,(0,l.kt)("summary",null,"Expected output"),(0,l.kt)("p",{parentName:"li"},"The context is in the ",(0,l.kt)("code",null,"NAME")," column."),(0,l.kt)("pre",null,(0,l.kt)("code",null,"CURRENT   NAME                                 CLUSTER                      AUTHINFO                            NAMESPACE *         pingcap@tidb-1.us-west-1.eksctl.io   tidb-1.us-west-1.eksctl.io   pingcap@tidb-1.us-west-1.eksctl.io pingcap@tidb-2.us-west-2.eksctl.io   tidb-2.us-west-2.eksctl.io   pingcap@tidb-2.us-west-2.eksctl.io pingcap@tidb-3.us-east-1.eksctl.io   tidb-3.us-east-1.eksctl.io   pingcap@tidb-3.us-east-1.eksctl.io"))),(0,l.kt)("p",{parentName:"li"},"In the following sections, ",(0,l.kt)("inlineCode",{parentName:"p"},"${context_1}"),", ",(0,l.kt)("inlineCode",{parentName:"p"},"${context_2}"),", and ",(0,l.kt)("inlineCode",{parentName:"p"},"${context_3}")," refer to the context of each cluster."))),(0,l.kt)("h2",{id:"step-2-configure-the-network"},"Step 2. Configure the network"),(0,l.kt)("h3",{id:"set-up-vpc-peering"},"Set up VPC peering"),(0,l.kt)("p",null,"To allow the three clusters to access each other, you need to create a VPC peering connection between the VPCs of every two clusters. For details on VPC peering, see ",(0,l.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/vpc/latest/peering/what-is-vpc-peering.html"},"AWS documentation"),"."),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Get the VPC ID of each cluster."),(0,l.kt)("p",{parentName:"li"},"The following example gets the VPC ID of cluster 1:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"eksctl get cluster ${cluster_1} --region ${region_1}\n")),(0,l.kt)("details",null,(0,l.kt)("summary",null,"Expected output"),(0,l.kt)("p",{parentName:"li"},"The VPC ID is in the ",(0,l.kt)("code",null,"VPC")," column."),(0,l.kt)("pre",null,(0,l.kt)("code",null,"NAME          VERSION STATUS  CREATED                 VPC                       SUBNETS                                                                                                                   SECURITYGROUPS tidb-1        1.20    ACTIVE  2021-11-22T06:40:20Z    vpc-0b15ed35c02af5288   subnet-058777d55881c4095, subnet-06def2041b6fa3fa0,subnet-0869c7e73e09c3174,subnet-099d10845f6cbaf82,subnet-0a1a58db5cb087fed, subnet-0f68b302678c4d36b     sg-0cb299e7ec153c595"))),(0,l.kt)("p",{parentName:"li"},"In the following sections, ",(0,l.kt)("inlineCode",{parentName:"p"},"${vpc_id_1}"),", ",(0,l.kt)("inlineCode",{parentName:"p"},"${vpc_id_2}"),", and ",(0,l.kt)("inlineCode",{parentName:"p"},"${vpc_id_3}")," refer to the VPC ID of each cluster.")),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Create a VPC peering connection between cluster 1 and cluster 2."),(0,l.kt)("ol",{parentName:"li"},(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Refer to ",(0,l.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/vpc/latest/peering/create-vpc-peering-connection.html#create-vpc-peering-connection-local"},"AWS documentation")," and create a VPC peering. Use ",(0,l.kt)("inlineCode",{parentName:"p"},"${vpc_id_1}")," as the requester VPC and ",(0,l.kt)("inlineCode",{parentName:"p"},"${vpc_id_2}")," as the accepter VPC.")),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Refer to ",(0,l.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/vpc/latest/peering/create-vpc-peering-connection.html#accept-vpc-peering-connection"},"AWS documentation")," and complete creating a VPC peering.")))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Follow the instructions in the previous step. Create a VPC peering connection between cluster 1 and cluster 3 and a VPC peering connection between cluster 2 and cluster 3.")),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/vpc/latest/peering/vpc-peering-routing.html"},"Update the route tables")," for the VPC peering connection of the three clusters."),(0,l.kt)("p",{parentName:"li"},"You need to update the route tables of all subnets used by the clusters. Add two routes in each route table."),(0,l.kt)("p",{parentName:"li"},"The following example shows the route table of cluster 1:"),(0,l.kt)("table",{parentName:"li"},(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Destination"),(0,l.kt)("th",{parentName:"tr",align:null},"Target"),(0,l.kt)("th",{parentName:"tr",align:null},"Status"),(0,l.kt)("th",{parentName:"tr",align:null},"Propagated"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${cidr_block_2}")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${vpc_peering_id_12}")),(0,l.kt)("td",{parentName:"tr",align:null},"Active"),(0,l.kt)("td",{parentName:"tr",align:null},"No")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${cidr_block_3}")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${vpc_peering_id_13}")),(0,l.kt)("td",{parentName:"tr",align:null},"Active"),(0,l.kt)("td",{parentName:"tr",align:null},"No")))),(0,l.kt)("p",{parentName:"li"},"The ",(0,l.kt)("strong",{parentName:"p"},"Destination")," of each route is the CIDR block of another cluster. The ",(0,l.kt)("strong",{parentName:"p"},"Target")," is the VPC peering ID of the two clusters."))),(0,l.kt)("h3",{id:"update-the-security-groups-for-the-instances"},"Update the security groups for the instances"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Update the security group for cluster 1."),(0,l.kt)("ol",{parentName:"li"},(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Enter the ",(0,l.kt)("a",{parentName:"p",href:"https://us-west-2.console.aws.amazon.com/ec2/v2/home#SecurityGroups"},"AWS Security Groups Console")," and select the security group of cluster 1. The name of the security group is similar to ",(0,l.kt)("inlineCode",{parentName:"p"},"eksctl-${cluster_1}-cluster/ClusterSharedNodeSecurityGroup"),".")),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Add inbound rules to the security group to allow traffic from cluster 2 and cluster 3."),(0,l.kt)("table",{parentName:"li"},(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Type"),(0,l.kt)("th",{parentName:"tr",align:null},"Protocol"),(0,l.kt)("th",{parentName:"tr",align:null},"Port range"),(0,l.kt)("th",{parentName:"tr",align:null},"Source"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"All traffic"),(0,l.kt)("td",{parentName:"tr",align:null},"All"),(0,l.kt)("td",{parentName:"tr",align:null},"All"),(0,l.kt)("td",{parentName:"tr",align:null},"Custom ",(0,l.kt)("inlineCode",{parentName:"td"},"${cidr_block_2}")),(0,l.kt)("td",{parentName:"tr",align:null},"Allow cluster 2 to communicate with cluster 1")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"All traffic"),(0,l.kt)("td",{parentName:"tr",align:null},"All"),(0,l.kt)("td",{parentName:"tr",align:null},"All"),(0,l.kt)("td",{parentName:"tr",align:null},"Custom ",(0,l.kt)("inlineCode",{parentName:"td"},"${cidr_block_3}")),(0,l.kt)("td",{parentName:"tr",align:null},"Allow cluster 3 to communicate with cluster 1"))))))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Follow the instructions in the previous step to update the security groups for cluster 2 and cluster 3."))),(0,l.kt)("h3",{id:"configure-load-balancers"},"Configure load balancers"),(0,l.kt)("p",null,"Each cluster needs to expose its CoreDNS service to other clusters via a ",(0,l.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/elasticloadbalancing/latest/network/introduction.html"},"network load balancer"),". This section describes how to configure load balancers."),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Create a load balancer service definition file ",(0,l.kt)("inlineCode",{parentName:"p"},"dns-lb.yaml")," as follows:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    k8s-app: kube-dns\n  name: across-cluster-dns-tcp\n  namespace: kube-system\n  annotations:\n    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"\n    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"\n    service.beta.kubernetes.io/aws-load-balancer-internal: "true"\nspec:\n  ports:\n  - name: dns\n    port: 53\n    protocol: TCP\n    targetPort: 53\n  selector:\n    k8s-app: kube-dns\n  type: LoadBalancer\n'))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Deploy the load balancer service in each cluster:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl --context ${context_1} apply -f dns-lb.yaml\n\nkubectl --context ${context_2} apply -f dns-lb.yaml\n\nkubectl --context ${context_3} apply -f dns-lb.yaml\n"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Get the load balancer name of each cluster, and wait for all load balancers to become ",(0,l.kt)("inlineCode",{parentName:"p"},"Active"),"."),(0,l.kt)("p",{parentName:"li"},"Get the load balancer names by running the following commands:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'lb_name_1=$(kubectl --context ${context_1} -n kube-system get svc across-cluster-dns-tcp -o jsonpath="{.status.loadBalancer. ingress[0].hostname}" | cut -d - -f 1)\n\nlb_name_2=$(kubectl --context ${context_2} -n kube-system get svc across-cluster-dns-tcp -o jsonpath="{.status.loadBalancer. ingress[0].hostname}" | cut -d - -f 1)\n\nlb_name_3=$(kubectl --context ${context_3} -n kube-system get svc across-cluster-dns-tcp -o jsonpath="{.status.loadBalancer. ingress[0].hostname}" | cut -d - -f 1)\n')),(0,l.kt)("p",{parentName:"li"},"Check the load balancer status of each cluster by running the following commands. If the output of all commands is ",(0,l.kt)("inlineCode",{parentName:"p"},"active"),", all load balancers are in the ",(0,l.kt)("inlineCode",{parentName:"p"},"Active")," state."),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"aws elbv2 describe-load-balancers --names ${lb_name_1} --region ${region_1} --query 'LoadBalancers[*].State' --output text\n\naws elbv2 describe-load-balancers --names ${lb_name_2} --region ${region_2} --query 'LoadBalancers[*].State' --output text\n\naws elbv2 describe-load-balancers --names ${lb_name_3} --region ${region_3} --query 'LoadBalancers[*].State' --output text\n")),(0,l.kt)("details",null,(0,l.kt)("summary",null,"Expected output"),(0,l.kt)("pre",null,(0,l.kt)("code",null,"active active active")))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Check the IP address associated with the load balancer of each cluster."),(0,l.kt)("p",{parentName:"li"},"Check the IP address associated with the load balancer of cluster 1:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"aws ec2 describe-network-interfaces --region ${region_1} --filters Name=description,Values=\"ELB net/${lb_name_1}*\" --query  'NetworkInterfaces[*].PrivateIpAddress' --output text\n")),(0,l.kt)("details",null,(0,l.kt)("summary",null,"Expected output"),(0,l.kt)("pre",null,(0,l.kt)("code",null,"10.1.175.233 10.1.144.196"))),(0,l.kt)("p",{parentName:"li"},"Repeat the same step for cluster 2 and cluster 3."),(0,l.kt)("p",{parentName:"li"},"In the following sections, ",(0,l.kt)("inlineCode",{parentName:"p"},"${lb_ip_list_1}"),", ",(0,l.kt)("inlineCode",{parentName:"p"},"${lb_ip_list_2}"),", and ",(0,l.kt)("inlineCode",{parentName:"p"},"${lb_ip_list_3}")," refer to the IP addresses associated with the load balancer of each cluster."),(0,l.kt)("p",{parentName:"li"},"The load balancers in different Regions might have different numbers of IP addresses. For example, in the example above, ",(0,l.kt)("inlineCode",{parentName:"p"},"${lb_ip_list_1}")," is ",(0,l.kt)("inlineCode",{parentName:"p"},"10.1.175.233 10.1.144.196"),"."))),(0,l.kt)("h3",{id:"configure-coredns"},"Configure CoreDNS"),(0,l.kt)("p",null,"To allow Pods in a cluster to access services in other clusters, you need to configure CoreDNS for each cluster to forward DNS requests to the CoreDNS services of other clusters."),(0,l.kt)("p",null,"You can configure CoreDNS by modifying the ConfigMap corresponding to the CoreDNS. For information on more configuration items, refer to ",(0,l.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers/#coredns"},"Customizing DNS Service"),"."),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Modify the CoreDNS configuration of cluster 1."),(0,l.kt)("ol",{parentName:"li"},(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Back up the current CoreDNS configuration:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl --context ${context_1} -n kube-system get configmap coredns -o yaml > ${cluster_1}-coredns.yaml.bk\n"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Modify the ConfigMap:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl --context ${context_1} -n kube-system edit configmap coredns\n")),(0,l.kt)("p",{parentName:"li"},"Modify the ",(0,l.kt)("inlineCode",{parentName:"p"},"data.Corefile")," field as follows. In the example below, ",(0,l.kt)("inlineCode",{parentName:"p"},"${namespace_2}")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"${namespace_3}")," are the namespaces that cluster 2 and cluster 3 deploy ",(0,l.kt)("inlineCode",{parentName:"p"},"TidbCluster")," in."),(0,l.kt)("blockquote",{parentName:"li"},(0,l.kt)("p",{parentName:"blockquote"},(0,l.kt)("strong",{parentName:"p"},"Warning:")),(0,l.kt)("p",{parentName:"blockquote"},"Because you cannot modify the cluster domain of an EKS cluster, you need to use the namespace as an identifier for DNS forwarding. Therefore, ",(0,l.kt)("inlineCode",{parentName:"p"},"${namespace_1}"),", ",(0,l.kt)("inlineCode",{parentName:"p"},"${namespace_2}"),", and ",(0,l.kt)("inlineCode",{parentName:"p"},"${namespace_3}")," must be different from each other.")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: v1\nkind: ConfigMap\n# ...\ndata:\n  Corefile: |\n     .:53 {\n        # Do not modify the default configuration.\n     }\n     ${namespace_2}.svc.cluster.local:53 {\n         errors\n         cache 30\n         forward . ${lb_ip_list_2} {\n             force_tcp\n         }\n     }\n     ${namespace_3}.svc.cluster.local:53 {\n         errors\n         cache 30\n         forward . ${lb_ip_list_3} {\n             force_tcp\n         }\n     }\n"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Wait for the CoreDNS to reload the configuration. It might take around 30 seconds.")))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Follow the instructions in the previous step, and modify the CoreDNS configuration of cluster 2 and cluster 3."),(0,l.kt)("p",{parentName:"li"},"For the CoreDNS configuration of each cluster, you need to perform the following operations:"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"Configure ",(0,l.kt)("inlineCode",{parentName:"li"},"${namespace_2}")," and ",(0,l.kt)("inlineCode",{parentName:"li"},"${namespace_3}")," to the namespace that the other two clusters deploy ",(0,l.kt)("inlineCode",{parentName:"li"},"TidbCluster")," in."),(0,l.kt)("li",{parentName:"ul"},"Configure the IP address to the IP addresses of the load balancers of the other two clusters.")))),(0,l.kt)("p",null,"In the following sections, ",(0,l.kt)("inlineCode",{parentName:"p"},"${namespace_1}"),", ",(0,l.kt)("inlineCode",{parentName:"p"},"${namespace_2}"),", and ",(0,l.kt)("inlineCode",{parentName:"p"},"${namespace_3}")," refer to the namespaces that each cluster deploy ",(0,l.kt)("inlineCode",{parentName:"p"},"TidbCluster")," in."),(0,l.kt)("h2",{id:"step-3-verify-the-network-interconnectivity"},"Step 3. Verify the network interconnectivity"),(0,l.kt)("p",null,"Before you deploy the TiDB cluster, you need to verify that the network between the EKS clusters is interconnected."),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Save the following content in the ",(0,l.kt)("inlineCode",{parentName:"p"},"sample-nginx.yaml")," file."),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: v1\nkind: Pod\nmetadata:\n  name: sample-nginx\n  labels:\n    app: sample-nginx\nspec:\n  hostname: sample-nginx\n  subdomain: sample-nginx-peer\n  containers:\n  - image: nginx:1.21.5\n    imagePullPolicy: IfNotPresent\n    name: nginx\n    ports:\n      - name: http\n        containerPort: 80\n  restartPolicy: Always\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: sample-nginx-peer\nspec:\n  ports:\n    - port: 80\n  selector:\n    app: sample-nginx\n  clusterIP: None\n"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Deploy the nginx service to the namespaces of the three clusters:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl --context ${context_1} -n ${namespace_1} apply -f sample-nginx.yaml\n\nkubectl --context ${context_2} -n ${namespace_2} apply -f sample-nginx.yaml\n\nkubectl --context ${context_3} -n ${namespace_3} apply -f sample-nginx.yaml\n"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Access the nginx services of each cluster to verify the network interconnectivity."),(0,l.kt)("p",{parentName:"li"},"The following command verifies the network from cluster 1 to cluster 2:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl --context ${context_1} exec sample-nginx -- curl http://sample-nginx.sample-nginx-peer.${namespace_2}.svc.cluster.local:80\n")),(0,l.kt)("p",{parentName:"li"},"If the output is the welcome page of nginx, the network is connected.")),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"After the verification, delete the nginx services:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl --context ${context_1} -n ${namespace_1} delete -f sample-nginx.yaml\n\nkubectl --context ${context_2} -n ${namespace_2} delete -f sample-nginx.yaml\n\nkubectl --context ${context_3} -n ${namespace_3} delete -f sample-nginx.yaml\n")))),(0,l.kt)("h2",{id:"step-4-deploy-tidb-operator"},"Step 4. Deploy TiDB Operator"),(0,l.kt)("p",null,"The ",(0,l.kt)("inlineCode",{parentName:"p"},"TidbCluster")," CR of each cluster is managed by TiDB Operator of the cluster. Therefore, you must deploy TiDB Operator for each cluster."),(0,l.kt)("p",null,"Refer to ",(0,l.kt)("a",{parentName:"p",href:"/deploy-tidb-operator"},"Deploy TiDB Operator")," and deploy TiDB Operator in each EKS cluster. Note that you need to use ",(0,l.kt)("inlineCode",{parentName:"p"},"kubectl --context ${context}")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"helm --kube-context ${context}")," in the commands to deploy TiDB Operator for each EKS cluster."),(0,l.kt)("h2",{id:"step-5-deploy-tidb-clusters"},"Step 5. Deploy TiDB clusters"),(0,l.kt)("p",null,"Refer to ",(0,l.kt)("a",{parentName:"p",href:"/deploy-tidb-cluster-across-multiple-kubernetes"},"Deploy a TiDB Cluster across Multiple Kubernetes Clusters")," and deploy a ",(0,l.kt)("inlineCode",{parentName:"p"},"TidbCluster")," CR for each EKS cluster. Note the following operations:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"You must deploy the TidbCluster CR in the corresponding namespace configured in the ",(0,l.kt)("a",{parentName:"p",href:"#configure-coredns"},"Configure CoreDNS")," section. Otherwise, the TiDB cluster will fail to start.")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},'The cluster domain of each cluster must be set to "cluster.local".'))),(0,l.kt)("p",null,"Take cluster 1 as an example. When you deploy the ",(0,l.kt)("inlineCode",{parentName:"p"},"TidbCluster")," CR to cluster 1, specify ",(0,l.kt)("inlineCode",{parentName:"p"},"metadata.namespace")," as ",(0,l.kt)("inlineCode",{parentName:"p"},"${namespace_1}"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: pingcap.com/v1alpha1\nkind: TidbCluster\nmetadata:\n   name: ${tc_name}\n   namespace: ${namespace_1}\nspec:\n  # ...\n  clusterDomain: "cluster.local"\n')),(0,l.kt)("h2",{id:"whats-next"},"What's next"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Read ",(0,l.kt)("a",{parentName:"li",href:"/deploy-tidb-cluster-across-multiple-kubernetes"},"Deploy a TiDB Cluster across Multiple Kubernetes Clusters")," to learn how to manage a TiDB cluster across multiple Kubernetes clusters.")))}d.isMDXComponent=!0}}]);