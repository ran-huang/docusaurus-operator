"use strict";(self.webpackChunkpingcap_docs=self.webpackChunkpingcap_docs||[]).push([[2901],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return m}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=p(n),m=r,g=d["".concat(s,".").concat(m)]||d[m]||c[m]||o;return n?a.createElement(g,i(i({ref:t},u),{},{components:n})):a.createElement(g,i({ref:t},u))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var p=2;p<o;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},4950:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return p},assets:function(){return u},toc:function(){return c},default:function(){return m}});var a=n(7462),r=n(3366),o=(n(7294),n(3905)),i=["components"],l={title:"Deploy DM in Kubernetes",summary:"Learn how to deploy TiDB DM cluster in Kubernetes."},s="Deploy DM in Kubernetes",p={unversionedId:"deploy-tidb-dm",id:"deploy-tidb-dm",title:"Deploy DM in Kubernetes",description:"TiDB Data Migration (DM) is an integrated data migration task management platform that supports the full data migration and the incremental data replication from MySQL/MariaDB into TiDB. This document describes how to deploy DM in Kubernetes using TiDB Operator and how to migrate MySQL data to TiDB cluster using DM.",source:"@site/docs/deploy-tidb-dm.md",sourceDirName:".",slug:"/deploy-tidb-dm",permalink:"/deploy-tidb-dm",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/deploy-tidb-dm.md",tags:[],version:"current",frontMatter:{title:"Deploy DM in Kubernetes",summary:"Learn how to deploy TiDB DM cluster in Kubernetes."},sidebar:"mySidebar",previous:{title:"Import Data",permalink:"/restore-data-using-tidb-lightning"},next:{title:"Use DM in Kubernetes",permalink:"/use-tidb-dm"}},u={},c=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Configure DM deployment",id:"configure-dm-deployment",level:2},{value:"Cluster name",id:"cluster-name",level:3},{value:"Version",id:"version",level:3},{value:"Cluster",id:"cluster",level:3},{value:"Configure DM-master",id:"configure-dm-master",level:4},{value:"Configure DM-worker",id:"configure-dm-worker",level:4},{value:"Topology Spread Constraint",id:"topology-spread-constraint",level:3},{value:"Deploy the DM cluster",id:"deploy-the-dm-cluster",level:2},{value:"Access the DM cluster in Kubernetes",id:"access-the-dm-cluster-in-kubernetes",level:2},{value:"What\u2019s next",id:"whats-next",level:2}],d={toc:c};function m(e){var t=e.components,n=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"deploy-dm-in-kubernetes"},"Deploy DM in Kubernetes"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://docs.pingcap.com/tidb-data-migration/v2.0"},"TiDB Data Migration")," (DM) is an integrated data migration task management platform that supports the full data migration and the incremental data replication from MySQL/MariaDB into TiDB. This document describes how to deploy DM in Kubernetes using TiDB Operator and how to migrate MySQL data to TiDB cluster using DM."),(0,o.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Complete ",(0,o.kt)("a",{parentName:"li",href:"/deploy-tidb-operator"},"deploying TiDB Operator"),".")),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Make sure that the TiDB Operator version >= 1.2.0."))),(0,o.kt)("h2",{id:"configure-dm-deployment"},"Configure DM deployment"),(0,o.kt)("p",null,"To configure the DM deployment, you need to configure the ",(0,o.kt)("inlineCode",{parentName:"p"},"DMCluster")," Custom Resource (CR). For the complete configurations of the ",(0,o.kt)("inlineCode",{parentName:"p"},"DMCluster")," CR, refer to the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/pingcap/tidb-operator/blob/master/examples/dm/dm-cluster.yaml"},"DMCluster example")," and ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/pingcap/tidb-operator/blob/master/docs/api-references/docs.md#dmcluster"},"API documentation"),". Note that you need to choose the example and API of the current TiDB Operator version."),(0,o.kt)("h3",{id:"cluster-name"},"Cluster name"),(0,o.kt)("p",null,"Configure the cluster name by changing the ",(0,o.kt)("inlineCode",{parentName:"p"},"metadata.name")," in the ",(0,o.kt)("inlineCode",{parentName:"p"},"DMCluster")," CR."),(0,o.kt)("h3",{id:"version"},"Version"),(0,o.kt)("p",null,"Usually, components in a cluster are in the same version. It is recommended to configure only ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.<master/worker>.baseImage")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.version"),". If you need to deploy different versions for different components, configure ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.<master/worker>.version"),"."),(0,o.kt)("p",null,"The formats of the related parameters are as follows:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"spec.version"),": the format is ",(0,o.kt)("inlineCode",{parentName:"li"},"imageTag"),", such as ",(0,o.kt)("inlineCode",{parentName:"li"},"v5.3.0"),"."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"spec.<master/worker>.baseImage"),": the format is ",(0,o.kt)("inlineCode",{parentName:"li"},"imageName"),", such as ",(0,o.kt)("inlineCode",{parentName:"li"},"pingcap/dm"),"."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"spec.<master/worker>.version"),": the format is ",(0,o.kt)("inlineCode",{parentName:"li"},"imageTag"),", such as ",(0,o.kt)("inlineCode",{parentName:"li"},"v5.3.0"),".")),(0,o.kt)("p",null,"TiDB Operator only supports deploying DM 2.0 and later versions."),(0,o.kt)("h3",{id:"cluster"},"Cluster"),(0,o.kt)("h4",{id:"configure-dm-master"},"Configure DM-master"),(0,o.kt)("p",null,"DM-master is an indispensable component of the DM cluster. You need to deploy at least three DM-master Pods if you want to achieve high availability."),(0,o.kt)("p",null,"You can configure DM-master parameters by ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.master.config")," in ",(0,o.kt)("inlineCode",{parentName:"p"},"DMCluster")," CR. For complete DM-master configuration parameters, refer to ",(0,o.kt)("a",{parentName:"p",href:"https://docs.pingcap.com/tidb-data-migration/v2.0/dm-master-configuration-file"},"DM-master Configuration File"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: pingcap.com/v1alpha1\nkind: DMCluster\nmetadata:\n  name: ${dm_cluster_name}\n  namespace: ${namespace}\nspec:\n  version: v5.3.0\n  pvReclaimPolicy: Retain\n  discovery: {}\n  master:\n    baseImage: pingcap/dm\n    maxFailoverCount: 0\n    imagePullPolicy: IfNotPresent\n    service:\n      type: NodePort\n      # Configures masterNodePort when you need to expose the DM-master service to a fixed NodePort\n      # masterNodePort: 30020\n    replicas: 1\n    storageSize: "10Gi"\n    requests:\n      cpu: 1\n    config:\n      rpc-timeout: 40s\n\n')),(0,o.kt)("h4",{id:"configure-dm-worker"},"Configure DM-worker"),(0,o.kt)("p",null,"You can configure DM-worker parameters by ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.worker.config")," in ",(0,o.kt)("inlineCode",{parentName:"p"},"DMCluster")," CR. For complete DM-worker configuration parameters\uff0crefer to ",(0,o.kt)("a",{parentName:"p",href:"https://docs.pingcap.com/tidb-data-migration/v2.0/dm-worker-configuration-file"},"DM-worker Configuration File"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: pingcap.com/v1alpha1\nkind: DMCluster\nmetadata:\n  name: ${dm_cluster_name}\n  namespace: ${namespace}\nspec:\n  ...\n  worker:\n    baseImage: pingcap/dm\n    maxFailoverCount: 0\n    replicas: 1\n    storageSize: "100Gi"\n    requests:\n      cpu: 1\n    config:\n      keepalive-ttl: 15\n\n')),(0,o.kt)("h3",{id:"topology-spread-constraint"},"Topology Spread Constraint"),(0,o.kt)("p",null,"By configuring ",(0,o.kt)("inlineCode",{parentName:"p"},"topologySpreadConstraints"),", you can make pods evenly spread in different topologies. For instructions about configuring ",(0,o.kt)("inlineCode",{parentName:"p"},"topologySpreadConstraints"),", see ",(0,o.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/"},"Pod Topology Spread Constraints"),"."),(0,o.kt)("p",null,"To use ",(0,o.kt)("inlineCode",{parentName:"p"},"topologySpreadConstraints"),", you must meet the following conditions:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Your Kubernetes cluster uses ",(0,o.kt)("inlineCode",{parentName:"li"},"default-scheduler")," instead of ",(0,o.kt)("inlineCode",{parentName:"li"},"tidb-scheduler"),". For details, refer to ",(0,o.kt)("a",{parentName:"li",href:"/tidb-scheduler#tidb-scheduler-and-default-scheduler"},"tidb-scheduler and default-scheduler"),"."),(0,o.kt)("li",{parentName:"ul"},"Your Kubernetes cluster enables the ",(0,o.kt)("inlineCode",{parentName:"li"},"EvenPodsSpread")," feature gate. If the Kubernetes version in use is earlier than v1.16 or if the ",(0,o.kt)("inlineCode",{parentName:"li"},"EvenPodsSpread")," feature gate is disabled, the configuration of ",(0,o.kt)("inlineCode",{parentName:"li"},"topologySpreadConstraints")," does not take effect.")),(0,o.kt)("p",null,"You can either configure ",(0,o.kt)("inlineCode",{parentName:"p"},"topologySpreadConstraints")," at a cluster level (",(0,o.kt)("inlineCode",{parentName:"p"},"spec.topologySpreadConstraints"),") for all components or at a component level (such as ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.tidb.topologySpreadConstraints"),") for specific components."),(0,o.kt)("p",null,"The following is an example configuration:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"topologySpreadConstrains:\n- topologyKey: kubernetes.io/hostname\n- topologyKey: topology.kubernetes.io/zone\n")),(0,o.kt)("p",null,"The example configuration can make pods of the same component evenly spread on different zones and nodes."),(0,o.kt)("p",null,"Currently, ",(0,o.kt)("inlineCode",{parentName:"p"},"topologySpreadConstraints")," only supports the configuration of the ",(0,o.kt)("inlineCode",{parentName:"p"},"topologyKey")," field. In the pod spec, the above example configuration will be automatically expanded as follows:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"topologySpreadConstrains:\n- topologyKey: kubernetes.io/hostname\n  maxSkew: 1\n  whenUnsatisfiable: DoNotSchedule\n  labelSelector: <object>\n- topologyKey: topology.kubernetes.io/zone\n  maxSkew: 1\n  whenUnsatisfiable: DoNotSchedule\n  labelSelector: <object>\n")),(0,o.kt)("h2",{id:"deploy-the-dm-cluster"},"Deploy the DM cluster"),(0,o.kt)("p",null,"After configuring the yaml file of the DM cluster in the above steps, execute the following command to deploy the DM cluster:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f ${dm_cluster_name}.yaml -n ${namespace}\n")),(0,o.kt)("p",null,"If the server does not have an external network, you need to download the Docker image used by the DM cluster and upload the image to the server, and then execute ",(0,o.kt)("inlineCode",{parentName:"p"},"docker load")," to install the Docker image on the server:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Deploy a DM cluster requires the following Docker image (assuming the version of the DM cluster is v5.3.0):"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"pingcap/dm:v5.3.0\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"To download the image, execute the following command:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"docker pull pingcap/dm:v5.3.0\ndocker save -o dm-v5.3.0.tar pingcap/dm:v5.3.0\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Upload the Docker image to the server, and execute ",(0,o.kt)("inlineCode",{parentName:"p"},"docker load")," to install the image on the server:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"docker load -i dm-v5.3.0.tar\n")))),(0,o.kt)("p",null,"After deploying the DM cluster, execute the following command to view the Pod status:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get po -n ${namespace} -l app.kubernetes.io/instance=${dm_cluster_name}\n")),(0,o.kt)("p",null,"You can use TiDB Operator to deploy and manage multiple DM clusters in a single Kubernetes cluster by repeating the above procedure and replacing ",(0,o.kt)("inlineCode",{parentName:"p"},"${dm_cluster_name}")," with a different name."),(0,o.kt)("p",null,"Different clusters can be in the same or different ",(0,o.kt)("inlineCode",{parentName:"p"},"namespace"),", which is based on your actual needs."),(0,o.kt)("h2",{id:"access-the-dm-cluster-in-kubernetes"},"Access the DM cluster in Kubernetes"),(0,o.kt)("p",null,"To access DM-master in the pod within a Kubernetes cluster, use the DM-master service domain name ",(0,o.kt)("inlineCode",{parentName:"p"},"${cluster_name}-dm-master.${namespace}"),"."),(0,o.kt)("p",null,"To access the DM cluster outside a Kubernetes cluster, expose the DM-master port by editing the ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.master.service")," field configuration in the ",(0,o.kt)("inlineCode",{parentName:"p"},"DMCluster")," CR."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  ...\n  master:\n    service:\n      type: NodePort\n")),(0,o.kt)("p",null,"You can access the DM-master service via the address of ",(0,o.kt)("inlineCode",{parentName:"p"},"${kubernetes_node_ip}:${node_port}"),"."),(0,o.kt)("p",null,"For more service exposure methods, refer to ",(0,o.kt)("a",{parentName:"p",href:"/access-tidb"},"Access the TiDB Cluster"),"."),(0,o.kt)("h2",{id:"whats-next"},"What\u2019s next"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"To migrate MySQL data to your TiDB cluster using DM in Kubernetes, see ",(0,o.kt)("a",{parentName:"li",href:"/use-tidb-dm"},"Migrate MySQL Data to TiDB Cluster Using DM"),"."),(0,o.kt)("li",{parentName:"ul"},"To enable TLS between components of the DM cluster in Kubernetes, see ",(0,o.kt)("a",{parentName:"li",href:"/enable-tls-for-dm"},"Enable TLS for DM"),".")))}m.isMDXComponent=!0}}]);