"use strict";(self.webpackChunkpingcap_docs=self.webpackChunkpingcap_docs||[]).push([[5651],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return u}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=p(n),u=r,h=d["".concat(l,".").concat(u)]||d[u]||m[u]||o;return n?a.createElement(h,i(i({ref:t},c),{},{components:n})):a.createElement(h,i({ref:t},c))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var p=2;p<o;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},8085:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return p},assets:function(){return c},toc:function(){return m},default:function(){return u}});var a=n(7462),r=n(3366),o=(n(7294),n(3905)),i=["components"],s={title:"Enable Admission Controller in TiDB Operator",summary:"Learn how to enable the admission controller in TiDB Operator and the functionality of the admission controller."},l="Enable Admission Controller in TiDB Operator",p={unversionedId:"enable-admission-webhook",id:"enable-admission-webhook",title:"Enable Admission Controller in TiDB Operator",description:"Kubernetes v1.9 introduces the dynamic admission control to modify and validate resources. TiDB Operator also supports the dynamic admission control to modify, validate, and maintain resources. This document describes how to enable the admission controller and introduces the functionality of the admission controller.",source:"@site/docs/enable-admission-webhook.md",sourceDirName:".",slug:"/enable-admission-webhook",permalink:"/enable-admission-webhook",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/enable-admission-webhook.md",tags:[],version:"current",frontMatter:{title:"Enable Admission Controller in TiDB Operator",summary:"Learn how to enable the admission controller in TiDB Operator and the functionality of the admission controller."},sidebar:"refSidebar",previous:{title:"Advanced StatefulSet Controller",permalink:"/advanced-statefulset"},next:{title:"TiDB in Kubernetes Sysbench Performance Test",permalink:"/benchmark-sysbench"}},c={},m=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Enable the admission controller",id:"enable-the-admission-controller",level:2},{value:"Set the TLS certificate for the admission controller",id:"set-the-tls-certificate-for-the-admission-controller",level:2},{value:"Functionality of the admission controller",id:"functionality-of-the-admission-controller",level:2}],d={toc:m};function u(e){var t=e.components,n=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"enable-admission-controller-in-tidb-operator"},"Enable Admission Controller in TiDB Operator"),(0,o.kt)("p",null,"Kubernetes v1.9 introduces the ",(0,o.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/"},"dynamic admission control")," to modify and validate resources. TiDB Operator also supports the dynamic admission control to modify, validate, and maintain resources. This document describes how to enable the admission controller and introduces the functionality of the admission controller."),(0,o.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,o.kt)("p",null,"Unlike those of most products on Kubernetes, the admission controller of TiDB Operator consists of two mechanisms: ",(0,o.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/access-kubernetes-api/setup-extension-api-server/"},"extension API-server")," and ",(0,o.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#configure-admission-webhooks-on-the-fly"},"Webhook Configuration"),"."),(0,o.kt)("p",null,"To use the admission controller, you need to enable the aggregation layer feature of the Kubernetes cluster. The feature is enabled by default. To check whether it is enabled, see ",(0,o.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/extend-kubernetes/configure-aggregation-layer/#enable-kubernetes-apiserver-flags"},"Enable Kubernetes Apiserver flags"),"."),(0,o.kt)("h2",{id:"enable-the-admission-controller"},"Enable the admission controller"),(0,o.kt)("p",null,"With a default installation, TiDB Operator disables the admission controller. Take the following steps to manually turn it on."),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Edit the ",(0,o.kt)("inlineCode",{parentName:"p"},"values.yaml")," file in TiDB Operator."),(0,o.kt)("p",{parentName:"li"},"Enable the ",(0,o.kt)("inlineCode",{parentName:"p"},"Operator Webhook")," feature:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"admissionWebhook:\n  create: true\n")),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"If your Kubernetes cluster version >= v1.13.0, enable the Webhook feature by using the configuration above.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"If your Kubernetes cluster version < v1.13.0, run the following command and configure the ",(0,o.kt)("inlineCode",{parentName:"p"},"admissionWebhook.cabundle")," in ",(0,o.kt)("inlineCode",{parentName:"p"},"values.yaml")," as the return value:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get configmap -n kube-system extension-apiserver-authentication -o=jsonpath='{.data.client-ca-file}' | base64 | tr -d '\\n'\n")),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"admissionWebhook:\n  # Configure the value of `admissionWebhook.cabundle` as the return value of the command above\n  cabundle: <cabundle>\n"))))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Configure the failure policy."),(0,o.kt)("p",{parentName:"li"},"Prior to Kubernetes v1.15, the management mechanism of the dynamic admission control is coarser-grained and is inconvenient to use. To prevent the impact of the dynamic admission control on the global cluster, you need to configure the ",(0,o.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#failure-policy"},"Failure Policy"),"."),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"For Kubernetes versions earlier than v1.15, it is recommended to set the ",(0,o.kt)("inlineCode",{parentName:"p"},"failurePolicy")," of TiDB Operator to ",(0,o.kt)("inlineCode",{parentName:"p"},"Ignore"),". This avoids the influence on the global cluster in case of ",(0,o.kt)("inlineCode",{parentName:"p"},"admission webhook")," exception in TiDB Operator."),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"......\nfailurePolicy:\n    validation: Ignore\n    mutation: Ignore\n"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"For Kubernetes v1.15 and later versions, it is recommended to set the ",(0,o.kt)("inlineCode",{parentName:"p"},"failurePolicy")," of TiDB Operator to ",(0,o.kt)("inlineCode",{parentName:"p"},"Failure"),". The exception occurs in ",(0,o.kt)("inlineCode",{parentName:"p"},"admission webhook")," does not affect the whole cluster, because the dynamic admission control supports the label-based filtering mechanism."),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"......\nfailurePolicy:\n    validation: Fail\n    mutation: Fail\n"))))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Install or update TiDB Operator."),(0,o.kt)("p",{parentName:"li"},"To install or update TiDB Operator, see ",(0,o.kt)("a",{parentName:"p",href:"/deploy-tidb-operator"},"Deploy TiDB Operator in Kubernetes"),"."))),(0,o.kt)("h2",{id:"set-the-tls-certificate-for-the-admission-controller"},"Set the TLS certificate for the admission controller"),(0,o.kt)("p",null,"By default, the admission controller and Kubernetes api-server skip the ",(0,o.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/access-kubernetes-api/configure-aggregation-layer/#contacting-the-extension-apiserver"},"TLS verification"),". To manually enable and configure the TLS verification between the admission controller and Kubernetes api-server, take the following steps:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Generate the custom certificate."),(0,o.kt)("p",{parentName:"li"},"To generate the custom CA (client auth) file, refer to Step 1 to Step 4 in ",(0,o.kt)("a",{parentName:"p",href:"/enable-tls-between-components#using-cfssl"},"Generate certificates using ",(0,o.kt)("inlineCode",{parentName:"a"},"cfssl")),"."),(0,o.kt)("p",{parentName:"li"},"Use the following configuration in ",(0,o.kt)("inlineCode",{parentName:"p"},"ca-config.json"),":"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "signing": {\n        "default": {\n            "expiry": "8760h"\n        },\n        "profiles": {\n            "server": {\n                "expiry": "8760h",\n                "usages": [\n                    "signing",\n                    "key encipherment",\n                    "server auth"\n                ]\n            }\n        }\n    }\n}\n')),(0,o.kt)("p",{parentName:"li"},"After executing Step 4, run the ",(0,o.kt)("inlineCode",{parentName:"p"},"ls")," command. The following files should be listed in the ",(0,o.kt)("inlineCode",{parentName:"p"},"cfssl")," folder:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"ca-config.json    ca-csr.json    ca-key.pem    ca.csr    ca.pem\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Generate the certificate for the admission controller."),(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Create the default ",(0,o.kt)("inlineCode",{parentName:"p"},"webhook-server.json")," file:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"cfssl print-defaults csr > webhook-server.json\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Modify the ",(0,o.kt)("inlineCode",{parentName:"p"},"webhook-server.json")," file as follows:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "CN": "TiDB Operator Webhook",\n    "hosts": [\n        "tidb-admission-webhook.<namespace>",\n        "tidb-admission-webhook.<namespace>.svc",\n        "tidb-admission-webhook.<namespace>.svc.cluster",\n        "tidb-admission-webhook.<namespace>.svc.cluster.local"\n    ],\n    "key": {\n        "algo": "rsa",\n        "size": 2048\n    },\n    "names": [\n        {\n            "C": "US",\n            "L": "CA",\n            "O": "PingCAP",\n            "ST": "Beijing",\n            "OU": "TiDB"\n        }\n    ]\n}\n')),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"p"},"<namespace>")," is the namespace which TiDB Operator is deployed in.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Generate the server-side certificate for TiDB Operator Webhook:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server webhook-server.json | cfssljson -bare webhook-server\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Run the ",(0,o.kt)("inlineCode",{parentName:"p"},"ls | grep webhook-server")," command. The following files should be listed:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"webhook-server-key.pem\nwebhook-server.csr\nwebhook-server.json\nwebhook-server.pem\n"))))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Create a secret in the Kubernetes cluster:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl create secret generic <secret-name> --namespace=<namespace> --from-file=tls.crt=~/cfssl/webhook-server.pem --from-file=tls.key=~/cfssl/webhook-server-key.pem --from-file=ca.crt=~/cfssl/ca.pem\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Modify ",(0,o.kt)("inlineCode",{parentName:"p"},"values.yaml"),", and install or upgrade TiDB Operator."),(0,o.kt)("p",{parentName:"li"},"Get the value of ",(0,o.kt)("inlineCode",{parentName:"p"},"ca.crt"),":"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get secret <secret-name> --namespace=<release-namespace> -o=jsonpath='{.data.ca\\.crt}'\n")),(0,o.kt)("p",{parentName:"li"},"Configure the items in ",(0,o.kt)("inlineCode",{parentName:"p"},"values.yaml")," as described below:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'admissionWebhook:\n  apiservice:\n    insecureSkipTLSVerify: false # Enable TLS verification\n    tlsSecret: "<secret-name>" # The name of the secret created in Step 3\n    caBundle: "<caBundle>" # The value of `ca.crt` obtained in the above step\n')),(0,o.kt)("p",{parentName:"li"},"After configuring the items, install or upgrade TiDB Operator. For installation, see ",(0,o.kt)("a",{parentName:"p",href:"/deploy-tidb-operator"},"Deploy TiDB Operator"),". For upgrade, see ",(0,o.kt)("a",{parentName:"p",href:"/upgrade-tidb-operator"},"Upgrade TiDB Operator"),"."))),(0,o.kt)("h2",{id:"functionality-of-the-admission-controller"},"Functionality of the admission controller"),(0,o.kt)("p",null,"TiDB Operator implements many functions using the admission controller. This section introduces the admission controller for each resource and its corresponding functions."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Admission controller for Pod validation"),(0,o.kt)("p",{parentName:"li"},"  The admission controller for Pod validation guarantees the safe logon and safe logoff of the PD/TiKV/TiDB component. You can ",(0,o.kt)("a",{parentName:"p",href:"/restart-a-tidb-cluster"},"restart a TiDB cluster in Kubernetes")," using this controller. The component is enabled by default if the admission controller is enabled."),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"admissionWebhook:\n  validation:\n    pods: true\n"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Admission controller for StatefulSet validation"),(0,o.kt)("p",{parentName:"li"},"  The admission controller for StatefulSet validation supports the gated launch of the TiDB/TiKV component in a TiDB cluster. The component is disabled by default if the admission controller is enabled."),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"admissionWebhook:\n  validation:\n    statefulSets: false\n")),(0,o.kt)("p",{parentName:"li"},"  You can control the gated launch of the TiDB/TiKV component in a TiDB cluster through two annotations, ",(0,o.kt)("inlineCode",{parentName:"p"},"tidb.pingcap.com/tikv-partition")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"tidb.pingcap.com/tidb-partition"),". To set the gated launch of the TiKV component in a TiDB cluster, execute the following commands. The effect of ",(0,o.kt)("inlineCode",{parentName:"p"},"partition=2")," is the same as that of ",(0,o.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#partitions"},"StatefulSet Partitions"),"."),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl annotate tidbcluster ${name} -n ${namespace} tidb.pingcap.com/tikv-partition=2 &&\ntidbcluster.pingcap.com/${name} annotated\n")),(0,o.kt)("p",{parentName:"li"},"  Execute the following commands to unset the gated launch:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl annotate tidbcluster ${name} -n ${namespace} tidb.pingcap.com/tikv-partition- &&\ntidbcluster.pingcap.com/${name} annotated\n")),(0,o.kt)("p",{parentName:"li"},"  This also applies to the TiDB component.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Admission controller for TiDB Operator resources validation"),(0,o.kt)("p",{parentName:"li"},"  The admission controller for TiDB Operator resources validation supports validating customized resources such as ",(0,o.kt)("inlineCode",{parentName:"p"},"TidbCluster")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"TidbMonitor")," in TiDB Operator. The component is disabled by default if the admission controller is enabled."),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"admissionWebhook:\n  validation:\n    pingcapResources: false\n")),(0,o.kt)("p",{parentName:"li"},"  For example, regarding ",(0,o.kt)("inlineCode",{parentName:"p"},"TidbCluster")," resources, the admission controller for TiDB Operator resources validation checks the required fields of the ",(0,o.kt)("inlineCode",{parentName:"p"},"spec")," field. When you create or update ",(0,o.kt)("inlineCode",{parentName:"p"},"TidbCluster"),", if the check is not passed (for example, neither of the ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.pd.image")," filed and the ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.pd.baseImage")," field is defined), this admission controller refuses the request.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Admission controller for Pod modification"),(0,o.kt)("p",{parentName:"li"},"  The admission controller for Pod modification supports the hotspot scheduling of TiKV in the auto-scaling scenario. To ",(0,o.kt)("a",{parentName:"p",href:"/enable-tidb-cluster-auto-scaling"},"enable TidbCluster auto-scaling"),", you need to enable this controller. The component is enabled by default if the admission controller is enabled."),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"admissionWebhook:\n  mutation:\n    pods: true\n"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Admission controller for TiDB Operator resources modification"),(0,o.kt)("p",{parentName:"li"},"  The admission controller for TiDB Operator resources modification supports filling in the default values of customized resources, such as ",(0,o.kt)("inlineCode",{parentName:"p"},"TidbCluster")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"TidbMonitor")," in TiDB Operator. The component is enabled by default if the admission controller is enabled."),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"admissionWebhook:\n  mutation:\n    pingcapResources: true\n")))))}u.isMDXComponent=!0}}]);