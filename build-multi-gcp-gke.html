<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.16">
<title data-rh="true">Build Multiple Interconnected GCP GKE Clusters | TiDB in Kubernetes Docs</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ran-huang.github.io/docusaurus-operator/build-multi-gcp-gke"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Build Multiple Interconnected GCP GKE Clusters | TiDB in Kubernetes Docs"><meta data-rh="true" name="description" content="This document describes how to create multiple GCP GKE clusters and configure network peering between these clusters. These interconnected clusters can be used for deploying TiDB clusters across multiple Kubernetes clusters. The example in this document shows how to configure three-cluster network peering."><meta data-rh="true" property="og:description" content="This document describes how to create multiple GCP GKE clusters and configure network peering between these clusters. These interconnected clusters can be used for deploying TiDB clusters across multiple Kubernetes clusters. The example in this document shows how to configure three-cluster network peering."><link data-rh="true" rel="icon" href="/docusaurus-operator/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ran-huang.github.io/docusaurus-operator/build-multi-gcp-gke"><link data-rh="true" rel="alternate" href="https://ran-huang.github.io/docusaurus-operator/build-multi-gcp-gke" hreflang="en"><link data-rh="true" rel="alternate" href="https://ran-huang.github.io/docusaurus-operator/build-multi-gcp-gke" hreflang="x-default"><link rel="stylesheet" href="/docusaurus-operator/assets/css/styles.732b35c1.css">
<link rel="preload" href="/docusaurus-operator/assets/js/runtime~main.b87ef9bf.js" as="script">
<link rel="preload" href="/docusaurus-operator/assets/js/main.51dee141.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docusaurus-operator/"><div class="navbar__logo"><img src="/docusaurus-operator/img/tidb-logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/docusaurus-operator/img/tidb-logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">TiDB in Kubernetes</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docusaurus-operator/">Docs</a><a class="navbar__item navbar__link" href="/docusaurus-operator/architecture">Reference</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ran-huang/docs-tidb-operator" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode (currently light mode)"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" href="/docusaurus-operator/">TiDB in Kubernetes</a><button aria-label="Toggle the collapsible sidebar category &#x27;TiDB in Kubernetes&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docusaurus-operator/get-started">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docusaurus-operator/prerequisites">Deploy</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docusaurus-operator/prerequisites">In Self-Managed Kubernetes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docusaurus-operator/deploy-on-aws-eks">In Public Cloud Kubernetes</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-cluster-on-arm64">On ARM64</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-tiflash">HTAP</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docusaurus-operator/build-multi-aws-eks">Across Multiple Kubernetes Clusters</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/build-multi-aws-eks">Amazon EKS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docusaurus-operator/build-multi-gcp-gke">GCP GKE</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-tidb-cluster-across-multiple-kubernetes">Deploy a TiDB Cluster across Multiple Kubernetes Clusters</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-heterogeneous-tidb-cluster">Heterogeneous Cluster</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-tidb-enterprise-edition">Enterprise Edition</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-ticdc">TiCDC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-tidb-binlog">TiDB Binlog</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docusaurus-operator/restore-data-using-tidb-lightning">Migrate</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docusaurus-operator/enable-tls-for-mysql-client">Manage</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docusaurus-operator/tips">Troubleshoot</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docusaurus-operator/faq">TiDB FAQs in Kubernetes</a></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">Deploy</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">Across Multiple Kubernetes Clusters</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/docusaurus-operator/build-multi-gcp-gke">GCP GKE</a></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Build Multiple Interconnected GCP GKE Clusters</h1><p>This document describes how to create multiple GCP GKE clusters and configure network peering between these clusters. These interconnected clusters can be used for <a href="/docusaurus-operator/deploy-tidb-cluster-across-multiple-kubernetes">deploying TiDB clusters across multiple Kubernetes clusters</a>. The example in this document shows how to configure three-cluster network peering.</p><p>If you need to deploy TiDB on a single GCP GKE cluster, refer to <a href="/docusaurus-operator/deploy-on-gcp-gke">Deploy TiDB on GCP GKE</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="prerequisites">Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">â€‹</a></h2><p>Before you deploy GKE clusters, make sure you have completed the following preparations:</p><ul><li>Install <a href="https://helm.sh/docs/intro/install/" target="_blank" rel="noopener noreferrer">Helm 3</a>. You need to use Helm to install TiDB Operator.</li><li>Install <a href="https://cloud.google.com/sdk/gcloud" target="_blank" rel="noopener noreferrer">gcloud</a>: <code>gcloud</code> is the CLI for creating and managing GCP services</li><li>Complete the <em>Before you begin</em> section in <a href="https://cloud.google.com/kubernetes-engine/docs/quickstart#before-you-begin" target="_blank" rel="noopener noreferrer">GKE Quickstart</a>.</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="configure-gcp-service">Configure GCP service<a class="hash-link" href="#configure-gcp-service" title="Direct link to heading">â€‹</a></h2><p>Configure your GCP project by running the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud config </span><span class="token builtin class-name">set</span><span class="token plain"> core/project </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">gcp-project</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="step-1-create-a-vpc-network">Step 1. Create a VPC network<a class="hash-link" href="#step-1-create-a-vpc-network" title="Direct link to heading">â€‹</a></h2><ol><li><p>Create a VPC network with custom subnets:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute networks create </span><span class="token variable" style="color:#36acaa">${network_name}</span><span class="token plain"> --subnet-mode</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">custom</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>In the VPC network created above, create three subnets that belong to different regions. The CIDR block of each subnet does not overlap with that of each other.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute networks subnets create </span><span class="token variable" style="color:#36acaa">${subnet_1}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --region</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${region_1}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --network</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${network_name}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --range</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.0.0/16 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --secondary-range </span><span class="token assign-left variable" style="color:#36acaa">pods</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.10</span><span class="token plain">.0.0/16,services</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.0.0/16</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute networks subnets create </span><span class="token variable" style="color:#36acaa">${subnet_2}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --region</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${region_2}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --network</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${network_name}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --range</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.1</span><span class="token plain">.0.0/16 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --secondary-range </span><span class="token assign-left variable" style="color:#36acaa">pods</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.11</span><span class="token plain">.0.0/16,services</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.101</span><span class="token plain">.0.0/16</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute networks subnets create </span><span class="token variable" style="color:#36acaa">${subnet_3}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --region</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${region_3}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --network</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${network_name}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --range</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.2</span><span class="token plain">.0.0/16 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --secondary-range </span><span class="token assign-left variable" style="color:#36acaa">pods</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.12</span><span class="token plain">.0.0/16,services</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.102</span><span class="token plain">.0.0/16</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>${subnet_1}</code>, <code>${subnet_2}</code>, and <code>${subnet_3}</code> refer to the names of the three subnets.</p><p><code>--range=10.0.0.0/16</code> specifies the CIDR block of the <code>${subnet_1}</code> in the cluster. The CIDR blocks of all cluster subnets <strong>must not</strong> overlap with each other.</p><p><code>--secondary-range pods=10.11.0.0/16,services=10.101.0.0/16</code> specifies the CIRD block used by Kubernetes Pods and Services. This CIRD block will be used later.</p></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="step-2-start-the-kubernetes-cluster">Step 2. Start the Kubernetes cluster<a class="hash-link" href="#step-2-start-the-kubernetes-cluster" title="Direct link to heading">â€‹</a></h2><p>Create three GKE clusters, and each cluster uses one of the subnets created in Step 1.</p><ol><li><p>Create three GKE clusters. Each cluster has a default node pool.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud beta container clusters create </span><span class="token variable" style="color:#36acaa">${cluster_1}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --region </span><span class="token variable" style="color:#36acaa">${region_1}</span><span class="token plain"> --num-nodes </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --network </span><span class="token variable" style="color:#36acaa">${network_name}</span><span class="token plain"> --subnetwork </span><span class="token variable" style="color:#36acaa">${subnet_1}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-dns clouddns --cluster-dns-scope vpc </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-dns-domain </span><span class="token variable" style="color:#36acaa">${cluster_domain_1}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --enable-ip-alias </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-secondary-range-name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pods --services-secondary-range-name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">services</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud beta container clusters create </span><span class="token variable" style="color:#36acaa">${cluster_2}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --region </span><span class="token variable" style="color:#36acaa">${region_2}</span><span class="token plain"> --num-nodes </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --network </span><span class="token variable" style="color:#36acaa">${network_name}</span><span class="token plain"> --subnetwork </span><span class="token variable" style="color:#36acaa">${subnet_2}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-dns clouddns --cluster-dns-scope vpc </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-dns-domain </span><span class="token variable" style="color:#36acaa">${cluster_domain_2}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --enable-ip-alias </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-secondary-range-name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pods --services-secondary-range-name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">services</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud beta container clusters create </span><span class="token variable" style="color:#36acaa">${cluster_3}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --region </span><span class="token variable" style="color:#36acaa">${region_3}</span><span class="token plain"> --num-nodes </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --network </span><span class="token variable" style="color:#36acaa">${network_name}</span><span class="token plain"> --subnetwork </span><span class="token variable" style="color:#36acaa">${subnet_3}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-dns clouddns --cluster-dns-scope vpc </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-dns-domain </span><span class="token variable" style="color:#36acaa">${cluster_domain_3}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --enable-ip-alias </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-secondary-range-name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pods --services-secondary-range-name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">services</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In the commands above, <code>${cluster_domain_n}</code> refers to the domain name of the <code>n</code>th cluster. In the following deployment steps, you need to configure <code>spec.clusterDomain</code> in TidbCluster CR to <code>${cluster_domain_n}</code>.</p><p>In the commands above, the <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/cloud-dns" target="_blank" rel="noopener noreferrer">Cloud DNS</a> in VPC scope is used so that the cluster can parse the Pod and Service addresses in other clusters.</p></li><li><p>Create the dedicated node pools used by PD, TiKV, and TiDB for each cluster.</p><p>Take cluster 1 as an example:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud container node-pools create pd --cluster </span><span class="token variable" style="color:#36acaa">${cluster_1}</span><span class="token plain"> --machine-type n1-standard-4 --num-nodes</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-labels</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pd --node-taints</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pd:NoSchedule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud container node-pools create tikv --cluster </span><span class="token variable" style="color:#36acaa">${cluster_1}</span><span class="token plain">  --machine-type n1-highmem-8 --num-nodes</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-labels</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tikv --node-taints</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tikv:NoSchedule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud container node-pools create tidb --cluster </span><span class="token variable" style="color:#36acaa">${cluster_1}</span><span class="token plain">  --machine-type n1-standard-8 --num-nodes</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-labels</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tidb --node-taints</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tidb:NoSchedule</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Obtain the Kubernetes context of each cluster. The context will be used in the subsequent <code>kubectl</code> commands.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl config get-contexts</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The expected output is as follows. The context is in the <code>NAME</code> column.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">CURRENT   NAME                          CLUSTER                       AUTHINFO                            NAMESPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*         gke_pingcap_us-west1_tidb-1   gke_pingcap_us-west1_tidb-1   gke_pingcap_us-west1_tidb-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          gke_pingcap_us-west2_tidb-2   gke_pingcap_us-west2_tidb-2   gke_pingcap_us-west2_tidb-2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          gke_pingcap_us-west3_tidb-3   gke_pingcap_us-west3_tidb-3   gke_pingcap_us-west3_tidb-3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In the following sections, <code>${context_1}</code>, <code>${context_2}</code>, and <code>${context_3}</code> refer to the context of each cluster.</p></li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="configure-the-firewall-rules">Configure the firewall rules<a class="hash-link" href="#configure-the-firewall-rules" title="Direct link to heading">â€‹</a></h3><ol><li><p>Update the firewall rules for cluster 1.</p><ol><li><p>Obtain the name of the firewall rule used for communication between GKE Pods. The name of the firewall rule is similar to <code>gke-${cluster_1}-${hash}-all</code>.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute firewall-rules list --filter</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;name~gke-${cluster_1}-.*-all&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The expected output is as follows. The rule name is in the <code>NAME</code> column.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">NAME                           NETWORK     DIRECTION  PRIORITY  ALLOW                         DENY  DISABLED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gke-${cluster_1}-b8b48366-all  ${network}  INGRESS    1000      tcp,udp,icmp,esp,ah,sctp            False</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Update the source range of the firewall rule. Add the CIDR blocks of the Pod network of the other two clusters to the source range:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute firewall-rules update </span><span class="token variable" style="color:#36acaa">${firewall_rule_name}</span><span class="token plain"> --source-ranges </span><span class="token number" style="color:#36acaa">10.10</span><span class="token plain">.0.0/16,10.11.0.0/16,10.12.0.0/16</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Run the following command to check whether the firewall rule is successfully updated:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute firewall-rules describe </span><span class="token variable" style="color:#36acaa">${firewall_rule_name}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol></li><li><p>Follow the same steps to update the firewall rules for cluster 2 and cluster 3.</p></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="step-3-verify-the-network-interconnectivity">Step 3. Verify the network interconnectivity<a class="hash-link" href="#step-3-verify-the-network-interconnectivity" title="Direct link to heading">â€‹</a></h2><p>Before you deploy the TiDB cluster, you need to verify that the network between the GKE clusters is interconnected.</p><ol><li><p>Save the following content in the <code>sample-nginx.yaml</code> file.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sample</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sample</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">hostname</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sample</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">subdomain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sample</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">nginx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">peer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">1.21.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">restartPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sample</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">nginx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">peer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sample</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">clusterIP</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> None</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Deploy the nginx service in the namespaces of three clusters.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl --context </span><span class="token variable" style="color:#36acaa">${context_1}</span><span class="token plain"> -n default apply -f sample-nginx.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl --context </span><span class="token variable" style="color:#36acaa">${context_2}</span><span class="token plain"> -n default apply -f sample-nginx.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl --context </span><span class="token variable" style="color:#36acaa">${context_3}</span><span class="token plain"> -n default apply -f sample-nginx.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Access the nginx services of each cluster to verify the network interconnectivity.</p><p>The following command verifies the network from cluster 1 to cluster 2:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl --context </span><span class="token variable" style="color:#36acaa">${context_1}</span><span class="token plain"> </span><span class="token builtin class-name">exec</span><span class="token plain"> sample-nginx -- </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://sample-nginx.sample-nginx-peer.default.svc.</span><span class="token variable" style="color:#36acaa">${cluster_domain_2}</span><span class="token plain">:80</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If the output is the welcome page of nginx, the network is connected.</p></li><li><p>After the verification, delete the nginx services:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl --context </span><span class="token variable" style="color:#36acaa">${context_1}</span><span class="token plain"> -n default delete -f sample-nginx.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl --context </span><span class="token variable" style="color:#36acaa">${context_2}</span><span class="token plain"> -n default delete -f sample-nginx.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl --context </span><span class="token variable" style="color:#36acaa">${context_3}</span><span class="token plain"> -n default delete -f sample-nginx.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="step-4-deploy-tidb-operator">Step 4. Deploy TiDB Operator<a class="hash-link" href="#step-4-deploy-tidb-operator" title="Direct link to heading">â€‹</a></h2><p>The <code>TidbCluster</code> CR of each cluster is managed by TiDB Operator of the cluster. Therefore, you must deploy TiDB Operator for each cluster.</p><p>Refer to <a href="/docusaurus-operator/deploy-tidb-operator">Deploy TiDB Operator</a> and deploy TiDB Operator in each GKE cluster. Note that you need to use <code>kubectl --context ${context}</code> and <code>helm --kube-context ${context}</code> in the commands to deploy TiDB Operator for each GKE cluster.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="step-5-deploy-tidb-clusters">Step 5. Deploy TiDB clusters<a class="hash-link" href="#step-5-deploy-tidb-clusters" title="Direct link to heading">â€‹</a></h2><p>Refer to <a href="/docusaurus-operator/deploy-tidb-cluster-across-multiple-kubernetes">Deploy a TiDB Cluster across Multiple Kubernetes Clusters</a>, and deploy a <code>TidbCluster</code> CR for each GKE cluster.</p><p>In the <code>TidbCluster</code> CR, the <code>spec.clusterDomain</code> field must be the same as <code>${cluster_domain_n}</code> defined in <a href="#step-2-start-the-kubernetes-cluster">Step 2</a>.</p><p>For example, when you deploy the <code>TidbCluster</code> CR to cluster 1, specify <code>spec.clusterDomain</code> as <code>${cluster_domain_1}</code>:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pingcap.com/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TidbCluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">#..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">clusterDomain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;${cluster_domain_1}&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="whats-next">What&#x27;s next<a class="hash-link" href="#whats-next" title="Direct link to heading">â€‹</a></h2><ul><li>Read <a href="/docusaurus-operator/deploy-tidb-cluster-across-multiple-kubernetes">Deploy a TiDB Cluster across Multiple Kubernetes Clusters</a> to learn how to manage a TiDB cluster across multiple Kubernetes clusters.</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/build-multi-gcp-gke.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docusaurus-operator/build-multi-aws-eks"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Build Multiple Interconnected AWS EKS Clusters</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docusaurus-operator/deploy-tidb-cluster-across-multiple-kubernetes"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Deploy a TiDB Cluster across Multiple Kubernetes Clusters</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#configure-gcp-service" class="table-of-contents__link toc-highlight">Configure GCP service</a></li><li><a href="#step-1-create-a-vpc-network" class="table-of-contents__link toc-highlight">Step 1. Create a VPC network</a></li><li><a href="#step-2-start-the-kubernetes-cluster" class="table-of-contents__link toc-highlight">Step 2. Start the Kubernetes cluster</a><ul><li><a href="#configure-the-firewall-rules" class="table-of-contents__link toc-highlight">Configure the firewall rules</a></li></ul></li><li><a href="#step-3-verify-the-network-interconnectivity" class="table-of-contents__link toc-highlight">Step 3. Verify the network interconnectivity</a></li><li><a href="#step-4-deploy-tidb-operator" class="table-of-contents__link toc-highlight">Step 4. Deploy TiDB Operator</a></li><li><a href="#step-5-deploy-tidb-clusters" class="table-of-contents__link toc-highlight">Step 5. Deploy TiDB clusters</a></li><li><a href="#whats-next" class="table-of-contents__link toc-highlight">What&#39;s next</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docusaurus-operator/">User Manual</a></li><li class="footer__item"><a class="footer__link-item" href="/docusaurus-operator/architecture">Reference</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/tidb" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://tidb.io" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>tidb.io<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/pingcap" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/pingcap/tidb-operator" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Source Code<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 TiDB in Kubernetes Docs, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/docusaurus-operator/assets/js/runtime~main.b87ef9bf.js"></script>
<script src="/docusaurus-operator/assets/js/main.51dee141.js"></script>
</body>
</html>