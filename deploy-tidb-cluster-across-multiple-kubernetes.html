<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.16">
<title data-rh="true">Deploy a TiDB Cluster across Multiple Kubernetes Clusters | TiDB in Kubernetes Docs</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ran-huang.github.io/docusaurus-operator/deploy-tidb-cluster-across-multiple-kubernetes"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Deploy a TiDB Cluster across Multiple Kubernetes Clusters | TiDB in Kubernetes Docs"><meta data-rh="true" name="description" content="This is still an experimental feature. It is NOT recommended that you use it in the production environment."><meta data-rh="true" property="og:description" content="This is still an experimental feature. It is NOT recommended that you use it in the production environment."><link data-rh="true" rel="icon" href="/docusaurus-operator/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ran-huang.github.io/docusaurus-operator/deploy-tidb-cluster-across-multiple-kubernetes"><link data-rh="true" rel="alternate" href="https://ran-huang.github.io/docusaurus-operator/deploy-tidb-cluster-across-multiple-kubernetes" hreflang="en"><link data-rh="true" rel="alternate" href="https://ran-huang.github.io/docusaurus-operator/deploy-tidb-cluster-across-multiple-kubernetes" hreflang="x-default"><link rel="stylesheet" href="/docusaurus-operator/assets/css/styles.824ca44c.css">
<link rel="preload" href="/docusaurus-operator/assets/js/runtime~main.7b6c7d1a.js" as="script">
<link rel="preload" href="/docusaurus-operator/assets/js/main.81ad91ac.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docusaurus-operator/"><div class="navbar__logo"><img src="/docusaurus-operator/img/tidb-logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/docusaurus-operator/img/tidb-logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">TiDB in Kubernetes</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docusaurus-operator/">Docs</a><a class="navbar__item navbar__link" href="/docusaurus-operator/architecture">Reference</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ran-huang/docusaurus-operator" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode (currently light mode)"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" href="/docusaurus-operator/">TiDB in Kubernetes</a><button aria-label="Toggle the collapsible sidebar category &#x27;TiDB in Kubernetes&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docusaurus-operator/get-started">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docusaurus-operator/prerequisites">Deploy</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docusaurus-operator/prerequisites">In Self-Managed Kubernetes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docusaurus-operator/deploy-on-aws-eks">In Public Cloud Kubernetes</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-cluster-on-arm64">On ARM64</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-tiflash">HTAP</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docusaurus-operator/build-multi-aws-eks">Across Multiple Kubernetes Clusters</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/build-multi-aws-eks">Amazon EKS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/build-multi-gcp-gke">GCP GKE</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docusaurus-operator/deploy-tidb-cluster-across-multiple-kubernetes">Deploy a TiDB Cluster across Multiple Kubernetes Clusters</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-heterogeneous-tidb-cluster">Heterogeneous Cluster</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-tidb-enterprise-edition">Enterprise Edition</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-ticdc">TiCDC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-tidb-binlog">TiDB Binlog</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docusaurus-operator/restore-data-using-tidb-lightning">Migrate</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docusaurus-operator/enable-tls-for-mysql-client">Manage</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docusaurus-operator/tips">Troubleshoot</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docusaurus-operator/faq">TiDB FAQs in Kubernetes</a></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">Deploy</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">Across Multiple Kubernetes Clusters</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/docusaurus-operator/deploy-tidb-cluster-across-multiple-kubernetes">Deploy a TiDB Cluster across Multiple Kubernetes Clusters</a></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Deploy a TiDB Cluster across Multiple Kubernetes Clusters</h1></header><div class="admonition admonition-danger alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>Warning</h5></div><div class="admonition-content"><p>This is still an experimental feature. It is <strong>NOT</strong> recommended that you use it in the production environment.</p></div></div><h1>Deploy a TiDB Cluster across Multiple Kubernetes Clusters</h1><p>To deploy a TiDB cluster across multiple Kubernetes clusters refers to deploying <strong>one</strong> TiDB cluster on multiple interconnected Kubernetes clusters. Each component of the cluster is distributed on multiple Kubernetes clusters to achieve disaster recovery among Kubernetes clusters. The interconnected network of Kubernetes clusters means that Pod IP can be accessed in any cluster and between clusters, and Pod FQDN records can be looked up by querying the DNS service in any cluster and between clusters.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="prerequisites">Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">â€‹</a></h2><p>You need to configure the Kubernetes network and DNS so that the Kubernetes cluster meets the following conditions:</p><ul><li>The TiDB components on each Kubernetes cluster can access the Pod IP of all TiDB components in and between clusters.</li><li>The TiDB components on each Kubernetes cluster can look up the Pod FQDN of all TiDB components in and between clusters.</li></ul><p>To build multiple connected EKS or GKE clusters, refer to <a href="/docusaurus-operator/build-multi-aws-eks">Build Multiple Interconnected AWS EKS Clusters</a> or <a href="/docusaurus-operator/build-multi-gcp-gke">Build Multiple Interconnected GCP GKE Clusters</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="supported-scenarios">Supported scenarios<a class="hash-link" href="#supported-scenarios" title="Direct link to heading">â€‹</a></h2><p>Currently supported scenarios:</p><ul><li>Deploy a new TiDB cluster across multiple Kubernetes clusters.</li><li>Deploy new TiDB clusters that enable this feature on other Kubernetes clusters and join the initial TiDB cluster.</li></ul><p>Experimentally supported scenarios:</p><ul><li>Enable this feature for a cluster that already has data. If you need to perform this action in a production environment, it is recommended to complete this requirement through data migration.</li></ul><p>Unsupported scenarios:</p><ul><li>You cannot interconnect two clusters that already have data. You might perform this action through data migration.</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="deploy-a-cluster-across-multiple-kubernetes-clusters">Deploy a cluster across multiple Kubernetes clusters<a class="hash-link" href="#deploy-a-cluster-across-multiple-kubernetes-clusters" title="Direct link to heading">â€‹</a></h2><p>Before you deploy a TiDB cluster across multiple Kubernetes clusters, you need to first deploy the Kubernetes clusters required for this operation. The following deployment assumes that you have completed Kubernetes deployment.</p><p>The following takes the deployment of two clusters as an example. Cluster #1 is the initial cluster. Create it according to the configuration given below. After cluster #1 is running normally, create cluster #2 according to the configuration given below. After creating and deploying clusters, two clusters run normally.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="deploy-the-initial-cluster">Deploy the initial cluster<a class="hash-link" href="#deploy-the-initial-cluster" title="Direct link to heading">â€‹</a></h3><p>Set the following environment variables according to the actual situation. You need to set the contents of the <code>cluster1_name</code> and <code>cluster1_cluster_domain</code> variables according to your actual use. <code>cluster1_name</code> is the cluster name of cluster #1, <code>cluster1_cluster_domain</code> is the <a href="https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers/#introduction" target="_blank" rel="noopener noreferrer">Cluster Domain</a> of cluster #1, and <code>cluster1_namespace</code> is the namespace of cluster #1.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">cluster1_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cluster1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">cluster1_cluster_domain</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cluster1.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">cluster1_namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;pingcap&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Run the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> kubectl apply -n </span><span class="token string bash punctuation variable" style="color:#36acaa">${cluster1_namespace}</span><span class="token string bash punctuation" style="color:#393A34"> -f -</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: pingcap.com/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: TidbCluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: &quot;</span><span class="token string variable" style="color:#36acaa">${cluster1_name}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  version: v4.0.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  timezone: UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  pvReclaimPolicy: Delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  enableDynamicConfiguration: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  configUpdateStrategy: RollingUpdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  clusterDomain: &quot;</span><span class="token string variable" style="color:#36acaa">${cluster1_cluster_domain}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  discovery: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  pd:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    baseImage: pingcap/pd</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    maxFailoverCount: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      storage: &quot;10Gi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    config: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tikv:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    baseImage: pingcap/tikv</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    maxFailoverCount: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      storage: &quot;10Gi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    config: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tidb:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    baseImage: pingcap/tidb</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    maxFailoverCount: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: ClusterIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    config: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="deploy-the-new-cluster-to-join-the-initial-cluster">Deploy the new cluster to join the initial cluster<a class="hash-link" href="#deploy-the-new-cluster-to-join-the-initial-cluster" title="Direct link to heading">â€‹</a></h3><p>You can wait for the cluster #1 to complete the deployment, and then create cluster #2. In the actual situation, cluster #2 refers to the cluster you newly created. You can create a new cluster to join any existing cluster in multiple clusters.</p><p>Refer to the following example and fill in the relevant information such as <code>Name</code>, <code>Cluster Domain</code>, and <code>Namespace</code> of cluster #1 and cluster #2 according to the actual situation:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">cluster1_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cluster1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">cluster1_cluster_domain</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cluster1.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">cluster1_namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;pingcap&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">cluster2_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cluster2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">cluster2_cluster_domain</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cluster2.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">cluster2_namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;pingcap&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Run the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> kubectl apply -n </span><span class="token string bash punctuation variable" style="color:#36acaa">${cluster2_namespace}</span><span class="token string bash punctuation" style="color:#393A34"> -f -</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: pingcap.com/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: TidbCluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: &quot;</span><span class="token string variable" style="color:#36acaa">${cluster2_name}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  version: v4.0.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  timezone: UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  pvReclaimPolicy: Delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  enableDynamicConfiguration: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  configUpdateStrategy: RollingUpdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  clusterDomain: &quot;</span><span class="token string variable" style="color:#36acaa">${cluster2_cluster_domain}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  cluster:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    name: &quot;</span><span class="token string variable" style="color:#36acaa">${cluster1_name}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    namespace: &quot;</span><span class="token string variable" style="color:#36acaa">${cluster1_namespace}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    clusterDomain: &quot;</span><span class="token string variable" style="color:#36acaa">${cluster1_clusterdomain}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  discovery: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  pd:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    baseImage: pingcap/pd</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    maxFailoverCount: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      storage: &quot;10Gi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    config: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tikv:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    baseImage: pingcap/tikv</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    maxFailoverCount: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      storage: &quot;10Gi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    config: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tidb:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    baseImage: pingcap/tidb</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    maxFailoverCount: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: ClusterIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    config: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="deploy-the-tls-enabled-tidb-cluster-across-multiple-kubernetes-clusters">Deploy the TLS-enabled TiDB cluster across multiple Kubernetes clusters<a class="hash-link" href="#deploy-the-tls-enabled-tidb-cluster-across-multiple-kubernetes-clusters" title="Direct link to heading">â€‹</a></h2><p>You can follow the steps below to enable TLS between TiDB components for TiDB clusters deployed across multiple Kubernetes clusters.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="issue-the-root-certificate">Issue the root certificate<a class="hash-link" href="#issue-the-root-certificate" title="Direct link to heading">â€‹</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="use-cfssl">Use <code>cfssl</code><a class="hash-link" href="#use-cfssl" title="Direct link to heading">â€‹</a></h4><p>If you use <code>cfssl</code>, the CA certificate issue process is the same as the general issue process. You need to save the CA certificate created for the first time, and use this CA certificate when you issue certificates for TiDB components later.</p><p>In other words, when you create a component certificate in a cluster, you do not need to create a CA certificate again. Complete step 1 ~ 4 in <a href="/docusaurus-operator/enable-tls-between-components#using-cfssl">Enabling TLS between TiDB components</a> once to issue the CA certificate. After that, start from step 5 to issue certificates between other cluster components.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="use-cert-manager">Use <code>cert-manager</code><a class="hash-link" href="#use-cert-manager" title="Direct link to heading">â€‹</a></h4><p>If you use <code>cert-manager</code>, you only need to create a <code>CA Issuer</code> and a <code>CA Certificate</code> in the initial cluster, and export the <code>CA Secret</code> to other new clusters that want to join.</p><p>For other clusters, you only need to create a component certificate <code>Issuer</code> (refers to <code>${cluster_name}-tidb-issuer</code> in the <a href="/docusaurus-operator/enable-tls-between-components#using-cert-manager">TLS document</a>) and configure the <code>Issuer</code> to use the <code>CA</code>. The detailed process is as follows:</p><ol><li><p>Create a <code>CA Issuer</code> and a <code>CA Certificate</code> in the initial cluster.</p><p>Set the following environment variables according to the actual situation:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">cluster_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cluster1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;pingcap&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Run the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> kubectl apply -f -</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: cert-manager.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Issuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: </span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-selfsigned-ca-issuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  namespace: </span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  selfSigned: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: cert-manager.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Certificate</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: </span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-ca</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  namespace: </span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  secretName: </span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-ca-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  commonName: &quot;TiDB&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  isCA: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  duration: 87600h # 10yrs</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  renewBefore: 720h # 30d</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  issuerRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    name: </span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-selfsigned-ca-issuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    kind: Issuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Export the CA and delete irrelevant information.</p><p>First, you need to export the <code>Secret</code> that stores the CA. The name of the <code>Secret</code> can be obtained from <code>.spec.secretName</code> of the <code>Certificate</code> YAML file in the first step.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl get secret cluster1-ca-secret -n </span><span class="token variable" style="color:#36acaa">${namespace}</span><span class="token plain"> -o yaml </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> ca.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Delete irrelevant information in the Secret YAML file. After the deletion, the YAML file is as follows (the information in <code>data</code> is omitted):</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ca.crt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> LS0</span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain">LQo=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tls.crt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> LS0t</span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain">.LQo=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tls.key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> LS0t</span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain">tCg==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cluster1</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ca</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes.io/tls</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Import the exported CA to other clusters.</p><p>You need to configure the <code>namespace</code> so that related components can access the CA certificate:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f ca.yaml -n </span><span class="token variable" style="color:#36acaa">${namespace}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Create a component certificate <code>Issuer</code> in the initial cluster and the new cluster, and configure it to use this CA.</p><ol><li><p>Create an <code>Issuer</code> that issues certificates between TiDB components in the initial cluster.</p><p>Set the following environment variables according to the actual situation:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">cluster_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cluster1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;pingcap&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ca_secret_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cluster1-ca-secret&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Run the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> kubectl apply -f -</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: cert-manager.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Issuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: </span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-tidb-issuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  namespace: </span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  ca:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    secretName: </span><span class="token string variable" style="color:#36acaa">${ca_secret_name}</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Create an <code>Issuer</code> that issues certificates between TiDB components in the new cluster.</p><p> Set the following environment variables according to the actual situation. Among them, <code>ca_secret_name</code> points to the imported <code>Secret</code> that stores the <code>CA</code>. You can use the <code>cluster_name</code> and <code>namespace</code> in the following operations:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">cluster_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cluster2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;pingcap&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ca_secret_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cluster1-ca-secret&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Run the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> kubectl apply -f -</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: cert-manager.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Issuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: </span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-tidb-issuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  namespace: </span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  ca:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    secretName: </span><span class="token string variable" style="color:#36acaa">${ca_secret_name}</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol></li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="issue-certificates-for-the-tidb-components-of-each-kubernetes-cluster">Issue certificates for the TiDB components of each Kubernetes cluster<a class="hash-link" href="#issue-certificates-for-the-tidb-components-of-each-kubernetes-cluster" title="Direct link to heading">â€‹</a></h3><p>You need to issue a component certificate for each TiDB component on the Kubernetes cluster. When issuing a component certificate, you need to add an authorization record ending with <code>.${cluster_domain}</code> to the hosts, for example, <code>${cluster_name}-pd.${namespace}.svc.${cluster_domain}</code>.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="use-the-cfssl-system-to-issue-certificates-for-tidb-components">Use the <code>cfssl</code> system to issue certificates for TiDB components<a class="hash-link" href="#use-the-cfssl-system-to-issue-certificates-for-tidb-components" title="Direct link to heading">â€‹</a></h4><p>The following example shows how to use <code>cfssl</code> to create a certificate used by PD. The <code>pd-server.json</code> file is as follows.</p><p>Set the following environment variables according to the actual situation:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">cluster_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">cluster2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">cluster_domain</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">cluster2.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pingcap</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You can create the <code>pd-server.json</code> by the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">&gt;</span><span class="token string bash punctuation" style="color:#393A34"> pd-server.json</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;CN&quot;: &quot;TiDB&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;hosts&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      &quot;127.0.0.1&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      &quot;::1&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      &quot;</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      &quot;</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd.</span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      &quot;</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd.</span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">.svc&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      &quot;</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd.</span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">.svc.</span><span class="token string variable" style="color:#36acaa">${cluster_domain}</span><span class="token string" style="color:#e3116c">&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      &quot;</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd-peer&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      &quot;</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd-peer.</span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      &quot;</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd-peer.</span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">.svc&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      &quot;</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd-peer.</span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">.svc.</span><span class="token string variable" style="color:#36acaa">${cluster_domain}</span><span class="token string" style="color:#e3116c">&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      &quot;*.</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd-peer&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      &quot;*.</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd-peer.</span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      &quot;*.</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd-peer.</span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">.svc&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      &quot;*.</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd-peer.</span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">.svc.</span><span class="token string variable" style="color:#36acaa">${cluster_domain}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;key&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;algo&quot;: &quot;ecdsa&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;size&quot;: 256</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;names&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;C&quot;: &quot;US&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;L&quot;: &quot;CA&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;ST&quot;: &quot;San Francisco&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="use-the-cert-manager-system-to-issue-certificates-for-tidb-components">Use the <code>cert-manager</code> system to issue certificates for TiDB components<a class="hash-link" href="#use-the-cert-manager-system-to-issue-certificates-for-tidb-components" title="Direct link to heading">â€‹</a></h4><p>The following example shows how to use <code>cert-manager</code> to create a certificate used by PD. <code>Certifcates</code> is shown below.</p><p>Set the following environment variables according to the actual situation.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">cluster_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cluster2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;pingcap&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">cluster_domain</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cluster2.com&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Run the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> kubectl apply -f -</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: cert-manager.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Certificate</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: </span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd-cluster-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  namespace: </span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  secretName: </span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd-cluster-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  duration: 8760h # 365d</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  renewBefore: 360h # 15d</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  subject:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    organizations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - PingCAP</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  commonName: &quot;TiDB&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  usages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - server auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - client auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  dnsNames:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - &quot;</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - &quot;</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd.</span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - &quot;</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd.</span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">.svc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - &quot;</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd.</span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">.svc.</span><span class="token string variable" style="color:#36acaa">${cluster_domain}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - &quot;</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd-peer&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - &quot;</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd-peer.</span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - &quot;</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd-peer.</span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">.svc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - &quot;</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd-peer.</span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">.svc.</span><span class="token string variable" style="color:#36acaa">${cluster_domain}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - &quot;*.</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd-peer&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - &quot;*.</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd-peer.</span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - &quot;*.</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd-peer.</span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">.svc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - &quot;*.</span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-pd-peer.</span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">.svc.</span><span class="token string variable" style="color:#36acaa">${cluster_domain}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  ipAddresses:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - ::1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  issuerRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    name: </span><span class="token string variable" style="color:#36acaa">${cluster_name}</span><span class="token string" style="color:#e3116c">-tidb-issuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    kind: Issuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    group: cert-manager.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You need to refer to the TLS-related documents, issue the corresponding certificates for the components, and create the <code>Secret</code> in the corresponding Kubernetes clusters.</p><p>For other TLS-related information, refer to the following documents:</p><ul><li><a href="/docusaurus-operator/enable-tls-between-components">Enable TLS between TiDB Components</a></li><li><a href="/docusaurus-operator/enable-tls-for-mysql-client">Enable TLS for the MySQL Client</a></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="deploy-the-initial-cluster-1">Deploy the initial cluster<a class="hash-link" href="#deploy-the-initial-cluster-1" title="Direct link to heading">â€‹</a></h3><p>This section introduces how to deploy and initialize the cluster.</p><p>In actual use, you need to set the contents of the <code>cluster1_name</code> and <code>cluster1_cluster_domain</code> variables according to your actual situation, where <code>cluster1_name</code> is the cluster name of cluster #1, <code>cluster1_cluster_domain</code> is the <code>Cluster Domain</code> of cluster #1, and <code>cluster1_namespace</code> is the namespace of cluster #1. The following <code>YAML</code> file enables the TLS feature, and each component starts to verify the certificates issued by the <code>CN</code> for the <code>CA</code> of <code>TiDB</code> by configuring the <code>cert-allowed-cn</code>.</p><p>Set the following environment variables according to the actual situation.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">cluster1_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cluster1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">cluster1_cluster_domain</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cluster1.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">cluster1_namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;pingcap&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Run the following command:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt; EOF | kubectl apply -n ${cluster1_namespace} -f -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: pingcap.com/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: TidbCluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: &quot;${cluster1_name}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version: v4.0.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timezone: UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tlsCluster:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pvReclaimPolicy: Delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enableDynamicConfiguration: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  configUpdateStrategy: RollingUpdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  clusterDomain: &quot;${cluster1_cluster_domain}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  discovery: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pd:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    baseImage: pingcap/pd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    maxFailoverCount: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      storage: &quot;10Gi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      security:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cert-allowed-cn:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - TiDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tikv:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    baseImage: pingcap/tikv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    maxFailoverCount: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      storage: &quot;10Gi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      security:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       cert-allowed-cn:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - TiDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tidb:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    baseImage: pingcap/tidb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    maxFailoverCount: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type: ClusterIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tlsClient:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      security:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       cert-allowed-cn:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - TiDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="deploy-a-new-cluster-to-join-the-initial-cluster">Deploy a new cluster to join the initial cluster<a class="hash-link" href="#deploy-a-new-cluster-to-join-the-initial-cluster" title="Direct link to heading">â€‹</a></h3><p>You can wait for the cluster #1 to complete the deployment. After completing the deployment, you can create cluster #2. The related commands are as follows. In actual use, cluster #1 might not the initial cluster. You can specify cluster #2 to join any cluster in the multiple clusters.</p><p>Set the following environment variables according to the actual situation:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">cluster1_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cluster1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">cluster1_cluster_domain</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cluster1.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">cluster1_namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;pingcap&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">cluster2_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cluster2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">cluster2_cluster_domain</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cluster2.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">cluster2_namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;pingcap&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Run the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> kubectl apply -n </span><span class="token string bash punctuation variable" style="color:#36acaa">${cluster2_namespace}</span><span class="token string bash punctuation" style="color:#393A34"> -f -</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: pingcap.com/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: TidbCluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: &quot;</span><span class="token string variable" style="color:#36acaa">${cluster2_name}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  version: v4.0.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  timezone: UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tlsCluster:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">   enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  pvReclaimPolicy: Delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  enableDynamicConfiguration: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  configUpdateStrategy: RollingUpdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  clusterDomain: &quot;</span><span class="token string variable" style="color:#36acaa">${cluster2_cluster_domain}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  cluster:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    name: &quot;</span><span class="token string variable" style="color:#36acaa">${cluster1_name}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    namespace: &quot;</span><span class="token string variable" style="color:#36acaa">${cluster1_namespace}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    clusterDomain: &quot;</span><span class="token string variable" style="color:#36acaa">${cluster1_clusterdomain}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  discovery: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  pd:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    baseImage: pingcap/pd</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    maxFailoverCount: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      storage: &quot;10Gi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      security:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        cert-allowed-cn:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          - TiDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tikv:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    baseImage: pingcap/tikv</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    maxFailoverCount: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      storage: &quot;10Gi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      security:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">       cert-allowed-cn:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">         - TiDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tidb:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    baseImage: pingcap/tidb</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    maxFailoverCount: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: ClusterIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    tlsClient:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      security:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">       cert-allowed-cn:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">         - TiDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="upgrade-tidb-cluster">Upgrade TiDB Cluster<a class="hash-link" href="#upgrade-tidb-cluster" title="Direct link to heading">â€‹</a></h2><p>For a TiDB cluster deployed across Kubernetes clusters, to perform a rolling upgrade for each component Pod of the TiDB cluster, take the following steps in sequence to modify the version configuration of each component in the TidbCluster spec for each Kubernetes cluster.</p><ol><li><p>Upgrade PD versions for all Kubernetes clusters.</p><ol><li><p>Modify the <code>spec.pd.version</code> field in the spec for cluster #1.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pingcap.com/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TidbCluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">pd</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">version</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Watch the status of PD Pods and wait for PD Pods in cluster #1 to finish recreation and become <code>Running</code>.</p></li><li><p>Repeat the first two substeps to upgrade all PD Pods in other clusters.</p></li></ol></li><li><p>Take step 1 as an example, perform the following upgrade operations in sequence:</p><ol><li>If TiFlash is deployed in clusters, upgrade the TiFlash versions for all the Kubernetes clusters that have TiFlash deployed.</li><li>Upgrade TiKV versions for all Kubernetes clusters.</li><li>If Pump is deployed in clusters, upgrade the Pump versions for all the Kubernetes clusters that have Pump deployed.</li><li>Upgrade TiDM versions for all Kubernetes clusters.</li><li>If TiCDC is deployed in clusters, upgrade the TiCDC versions for all the Kubernetes clusters that have TiCDC deployed.</li></ol></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="exit-and-reclaim-clusters-that-already-join-a-cross-kubernetes-cluster">Exit and reclaim clusters that already join a cross-Kubernetes cluster<a class="hash-link" href="#exit-and-reclaim-clusters-that-already-join-a-cross-kubernetes-cluster" title="Direct link to heading">â€‹</a></h2><p>When you need to make a cluster exit from the joined TiDB cluster deployed across Kubernetes and reclaim resources, you can perform the operation by scaling in the cluster. In this scenario, the following requirements of scaling-in need to be met.</p><ul><li>After scaling in the cluster, the number of TiKV replicas in the cluster should be greater than the number of <code>max-replicas</code> set in PD. By default, the number of TiKV replicas needs to be greater than three.</li></ul><p>Take the cluster #2 created in <a href="#deploy-a-new-cluster-to-join-the-initial-cluster">the last section</a> as an example. First, set the number of replicas of PD, TiKV, and TiDB to <code>0</code>. If you enable other components such as TiFlash, TiCDC, and Pump, set the number of these replicas to <code>0</code>:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch tc cluster2 --type merge -p </span><span class="token string" style="color:#e3116c">&#x27;{&quot;spec&quot;:{&quot;pd&quot;:{&quot;replicas&quot;:0},&quot;tikv&quot;:{&quot;replicas&quot;:0},&quot;tidb&quot;:{&quot;replicas&quot;:0}}}&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Wait for the status of cluster #2 to become <code>Ready</code>, and scale in related components to <code>0</code> replica:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -l app.kubernetes.io/instance</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">cluster2 -n pingcap</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The Pod list shows <code>No resources found</code>. At this time, Pods have all been scaled in, and cluster #2 exits the cluster. Check the cluster status of cluster #2:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get tc cluster2</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The result shows that cluster #2 is in the <code>Ready</code> status. At this time, you can delete the object and reclaim related resources.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete tc cluster2</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Through the above steps, you can complete exit and resources reclaim of the joined clusters.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="enable-the-feature-for-a-cluster-with-existing-data-and-make-it-the-initial-tidb-cluster">Enable the feature for a cluster with existing data and make it the initial TiDB cluster<a class="hash-link" href="#enable-the-feature-for-a-cluster-with-existing-data-and-make-it-the-initial-tidb-cluster" title="Direct link to heading">â€‹</a></h2><div class="admonition admonition-danger alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>Warning</h5></div><div class="admonition-content"><p>Currently, this is an experimental feature and might cause data loss. Please use it carefully.</p></div></div><ol><li><p>Update <code>.spec.clusterDomain</code> configuration:</p><p>Configure the following parameters according to the <code>clusterDomain</code> in your Kubernetes cluster information:</p><blockquote><p><strong>Warning:</strong></p><p>Currently, you need to configure <code>clusterDomain</code> with correct information. After modifying the configuration, you can not modify it again.</p></blockquote><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch tidbcluster cluster1 --type merge -p </span><span class="token string" style="color:#e3116c">&#x27;{&quot;spec&quot;:{&quot;clusterDomain&quot;:&quot;cluster1.com&quot;}}&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>After completing the modification, the TiDB cluster performs the rolling update.</p></li><li><p>Update the <code>PeerURL</code> information of PD:</p><p>After completing the rolling update, you need to use <code>port-forward</code> to expose PD&#x27;s API, and use API of PD to update <code>PeerURL</code> of PD.</p><ol><li><p>Use <code>port-forward</code> to expose API of PD:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl port-forward pods/cluster1-pd-0 </span><span class="token number" style="color:#36acaa">2380</span><span class="token plain">:2380 </span><span class="token number" style="color:#36acaa">2379</span><span class="token plain">:2379 -n pingcap</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Access <code>PD API</code> to obtain <code>members</code> information. Note that after using <code>port-forward</code>, the terminal session is occupied. You need to perform the following operations in another terminal session:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://127.0.0.1:2379/v2/members</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><blockquote><p><strong>Note:</strong></p><p>If the cluster enables TLS, you need to configure the certificate when using the curl command. For example:</p><p><code>curl --cacert /var/lib/pd-tls/ca.crt --cert /var/lib/pd-tls/tls.crt --key /var/lib/pd-tls/tls.key https://127.0.0.1:2379/v2/members</code></p></blockquote><p>After running the command, the output is as follows:</p><div class="codeBlockContainer_I0IT language-output theme-code-block"><div class="codeBlockContent_wNvx output"><pre tabindex="0" class="prism-code language-output codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;members&quot;:[{&quot;id&quot;:&quot;6ed0312dc663b885&quot;,&quot;name&quot;:&quot;cluster1-pd-0.cluster1-pd-peer.pingcap.svc.cluster1.com&quot;,&quot;peerURLs&quot;:[&quot;http://cluster1-pd-0.cluster1-pd-peer.pingcap.svc:2380&quot;],&quot;clientURLs&quot;:[&quot;http://cluster1-pd-0.cluster1-pd-peer.pingcap.svc.cluster1.com:2379&quot;]},{&quot;id&quot;:&quot;bd9acd3d57e24a32&quot;,&quot;name&quot;:&quot;cluster1-pd-1.cluster1-pd-peer.pingcap.svc.cluster1.com&quot;,&quot;peerURLs&quot;:[&quot;http://cluster1-pd-1.cluster1-pd-peer.pingcap.svc:2380&quot;],&quot;clientURLs&quot;:[&quot;http://cluster1-pd-1.cluster1-pd-peer.pingcap.svc.cluster1.com:2379&quot;]},{&quot;id&quot;:&quot;e04e42cccef60246&quot;,&quot;name&quot;:&quot;cluster1-pd-2.cluster1-pd-peer.pingcap.svc.cluster1.com&quot;,&quot;peerURLs&quot;:[&quot;http://cluster1-pd-2.cluster1-pd-peer.pingcap.svc:2380&quot;],&quot;clientURLs&quot;:[&quot;http://cluster1-pd-2.cluster1-pd-peer.pingcap.svc.cluster1.com:2379&quot;]}]}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Record the <code>id</code> of each PD instance, and use the <code>id</code> to update the <code>peerURL</code> of each member in turn:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">member_ID</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;6ed0312dc663b885&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">member_peer_url</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;http://cluster1-pd-0.cluster1-pd-peer.pingcap.svc.cluster1.com:2380&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://127.0.0.1:2379/v2/members/</span><span class="token variable" style="color:#36acaa">${member_ID}</span><span class="token plain"> -XPUT </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-H </span><span class="token string" style="color:#e3116c">&quot;Content-Type: application/json&quot;</span><span class="token plain"> -d </span><span class="token string" style="color:#e3116c">&#x27;{&quot;peerURLs&quot;:[&quot;${member_peer_url}&quot;]}&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol></li></ol><p>For more examples and development information, refer to <a href="https://github.com/pingcap/tidb-operator/tree/master/examples/multi-cluster" target="_blank" rel="noopener noreferrer"><code>multi-cluster</code></a>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/deploy-tidb-cluster-across-multiple-kubernetes.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docusaurus-operator/build-multi-gcp-gke"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Build Multiple Interconnected GCP GKE Clusters</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docusaurus-operator/deploy-heterogeneous-tidb-cluster"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Deploy a Heterogeneous Cluster for an Existing TiDB Cluster</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#supported-scenarios" class="table-of-contents__link toc-highlight">Supported scenarios</a></li><li><a href="#deploy-a-cluster-across-multiple-kubernetes-clusters" class="table-of-contents__link toc-highlight">Deploy a cluster across multiple Kubernetes clusters</a><ul><li><a href="#deploy-the-initial-cluster" class="table-of-contents__link toc-highlight">Deploy the initial cluster</a></li><li><a href="#deploy-the-new-cluster-to-join-the-initial-cluster" class="table-of-contents__link toc-highlight">Deploy the new cluster to join the initial cluster</a></li></ul></li><li><a href="#deploy-the-tls-enabled-tidb-cluster-across-multiple-kubernetes-clusters" class="table-of-contents__link toc-highlight">Deploy the TLS-enabled TiDB cluster across multiple Kubernetes clusters</a><ul><li><a href="#issue-the-root-certificate" class="table-of-contents__link toc-highlight">Issue the root certificate</a></li><li><a href="#issue-certificates-for-the-tidb-components-of-each-kubernetes-cluster" class="table-of-contents__link toc-highlight">Issue certificates for the TiDB components of each Kubernetes cluster</a></li><li><a href="#deploy-the-initial-cluster-1" class="table-of-contents__link toc-highlight">Deploy the initial cluster</a></li><li><a href="#deploy-a-new-cluster-to-join-the-initial-cluster" class="table-of-contents__link toc-highlight">Deploy a new cluster to join the initial cluster</a></li></ul></li><li><a href="#upgrade-tidb-cluster" class="table-of-contents__link toc-highlight">Upgrade TiDB Cluster</a></li><li><a href="#exit-and-reclaim-clusters-that-already-join-a-cross-kubernetes-cluster" class="table-of-contents__link toc-highlight">Exit and reclaim clusters that already join a cross-Kubernetes cluster</a></li><li><a href="#enable-the-feature-for-a-cluster-with-existing-data-and-make-it-the-initial-tidb-cluster" class="table-of-contents__link toc-highlight">Enable the feature for a cluster with existing data and make it the initial TiDB cluster</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docusaurus-operator/">User Manual</a></li><li class="footer__item"><a class="footer__link-item" href="/docusaurus-operator/architecture">Reference</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/tidb" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://tidb.io" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>tidb.io<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/pingcap" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/pingcap/tidb-operator" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Source Code<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 TiDB in Kubernetes Docs, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/docusaurus-operator/assets/js/runtime~main.7b6c7d1a.js"></script>
<script src="/docusaurus-operator/assets/js/main.81ad91ac.js"></script>
</body>
</html>