<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.16">
<title data-rh="true">Deploy TiDB on Azure AKS | TiDB in Kubernetes Docs</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ran-huang.github.io/docusaurus-operator/deploy-on-azure-aks"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Deploy TiDB on Azure AKS | TiDB in Kubernetes Docs"><meta data-rh="true" name="description" content="This document describes how to deploy a TiDB cluster on Azure Kubernetes Service (AKS)."><meta data-rh="true" property="og:description" content="This document describes how to deploy a TiDB cluster on Azure Kubernetes Service (AKS)."><link data-rh="true" rel="icon" href="/docusaurus-operator/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ran-huang.github.io/docusaurus-operator/deploy-on-azure-aks"><link data-rh="true" rel="alternate" href="https://ran-huang.github.io/docusaurus-operator/deploy-on-azure-aks" hreflang="en"><link data-rh="true" rel="alternate" href="https://ran-huang.github.io/docusaurus-operator/deploy-on-azure-aks" hreflang="x-default"><link rel="stylesheet" href="/docusaurus-operator/assets/css/styles.e3dbdb50.css">
<link rel="preload" href="/docusaurus-operator/assets/js/runtime~main.5f239d35.js" as="script">
<link rel="preload" href="/docusaurus-operator/assets/js/main.4a76a225.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docusaurus-operator/"><div class="navbar__logo"><img src="/docusaurus-operator/img/tidb-logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/docusaurus-operator/img/tidb-logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">TiDB in Kubernetes</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docusaurus-operator/">Docs</a><a class="navbar__item navbar__link" href="/docusaurus-operator/architecture">Reference</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ran-huang/docusaurus-operator" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode (currently light mode)"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" href="/docusaurus-operator/">TiDB in Kubernetes</a><button aria-label="Toggle the collapsible sidebar category &#x27;TiDB in Kubernetes&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docusaurus-operator/get-started">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docusaurus-operator/prerequisites">Deploy</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docusaurus-operator/prerequisites">In Self-Managed Kubernetes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docusaurus-operator/deploy-on-aws-eks">In Public Cloud Kubernetes</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-on-aws-eks">Deploy TiDB on AWS EKS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-on-gcp-gke">Deploy TiDB on GCP GKE</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docusaurus-operator/deploy-on-azure-aks">Deploy TiDB on Azure AKS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-on-alibaba-cloud">Deploy TiDB on Alibaba Cloud Kubernetes</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-cluster-on-arm64">On ARM64</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-tiflash">HTAP</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docusaurus-operator/build-multi-aws-eks">Across Multiple Kubernetes Clusters</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-heterogeneous-tidb-cluster">Heterogeneous Cluster</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-tidb-enterprise-edition">Enterprise Edition</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-ticdc">TiCDC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docusaurus-operator/deploy-tidb-binlog">TiDB Binlog</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docusaurus-operator/restore-data-using-tidb-lightning">Migrate</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docusaurus-operator/enable-tls-for-mysql-client">Manage</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docusaurus-operator/tips">Troubleshoot</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docusaurus-operator/faq">TiDB FAQs in Kubernetes</a></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">Deploy</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">In Public Cloud Kubernetes</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/docusaurus-operator/deploy-on-azure-aks">Deploy TiDB on Azure AKS</a></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Deploy TiDB on Azure AKS</h1><p>This document describes how to deploy a TiDB cluster on Azure Kubernetes Service (AKS).</p><p>To deploy TiDB Operator and the TiDB cluster in a self-managed Kubernetes environment, refer to <a href="/docusaurus-operator/deploy-tidb-operator">Deploy TiDB Operator</a> and <a href="/docusaurus-operator/deploy-on-general-kubernetes">Deploy TiDB in General Kubernetes</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="prerequisites">Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">â€‹</a></h2><p>Before deploying a TiDB cluster on Azure AKS, perform the following operations:</p><ul><li><p>Install <a href="https://helm.sh/docs/intro/install/" target="_blank" rel="noopener noreferrer">Helm 3</a> for deploying TiDB Operator.</p></li><li><p><a href="https://docs.microsoft.com/en-us/azure/aks/tutorial-kubernetes-deploy-cluster" target="_blank" rel="noopener noreferrer">Deploy a Kubernetes (AKS) cluster</a> and install and configure <code>az cli</code>.</p><blockquote><p><strong>Noteï¼š</strong></p><p>To verify whether AZ CLI is configured correctly, run the <code>az login</code> command. If login with account credentials succeeds, AZ CLI is configured correctly. Otherwise, you need to re-configure AZ CLI.</p></blockquote></li><li><p>Refer to <a href="https://docs.microsoft.com/en-us/azure/aks/use-ultra-disks" target="_blank" rel="noopener noreferrer">use Ultra disks</a> to create a new cluster that can use Ultra disks or enable Ultra disks in an exist cluster.</p></li><li><p>Acquire <a href="https://docs.microsoft.com/en-us/azure/aks/concepts-identity#aks-service-permissions" target="_blank" rel="noopener noreferrer">AKS service permissions</a>.</p></li><li><p>If the Kubernetes version of the cluster is earlier than 1.21, install <a href="https://docs.microsoft.com/en-us/azure/aks/custom-node-configuration#install-aks-preview-cli-extension" target="_blank" rel="noopener noreferrer">aks-preview CLI extension</a> for using Ultra Disks and register <a href="https://docs.microsoft.com/en-us/azure/aks/csi-storage-drivers#install-csi-storage-drivers-on-a-new-cluster-with-version--121" target="_blank" rel="noopener noreferrer">EnableAzureDiskFileCSIDriver</a> in <a href="https://docs.microsoft.com/en-us/cli/azure/feature?view=azure-cli-latest#az_feature_register-optional-parameters" target="_blank" rel="noopener noreferrer">your subscription</a>.</p><ul><li><p>Install the aks-preview CLI extension:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">az extension </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> --name aks-preview</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Register <code>EnableAzureDiskFileCSIDriver</code>:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">az feature register --name EnableAzureDiskFileCSIDriver --namespace Microsoft.ContainerService --subscription </span><span class="token variable" style="color:#36acaa">${your-subscription-id}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="create-an-aks-cluster-and-a-node-pool">Create an AKS cluster and a node pool<a class="hash-link" href="#create-an-aks-cluster-and-a-node-pool" title="Direct link to heading">â€‹</a></h2><p>Most of the TiDB cluster components use Azure disk as storage. According to <a href="https://docs.microsoft.com/en-us/azure/aks/operator-best-practices-cluster-isolation" target="_blank" rel="noopener noreferrer">AKS Best Practices</a>, when creating an AKS cluster, it is recommended to ensure that each node pool uses one availability zone (at least 3 in total).</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="create-an-aks-cluster-with-csi-enabled">Create an AKS cluster with CSI enabled<a class="hash-link" href="#create-an-aks-cluster-with-csi-enabled" title="Direct link to heading">â€‹</a></h3><p>To create an AKS cluster with <a href="https://docs.microsoft.com/en-us/azure/aks/csi-storage-drivers" target="_blank" rel="noopener noreferrer">CSI enabled</a>, run the following command:</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>If the Kubernetes version of the cluster is earlier than 1.21, you need to append an <code>--aks-custom-headers</code> flag to enable the <strong>EnableAzureDiskFileCSIDriver</strong> feature by running the following command:</p></div></div><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># create AKS cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az aks create </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --resource-group </span><span class="token variable" style="color:#36acaa">${resourceGroup}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --name </span><span class="token variable" style="color:#36acaa">${clusterName}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --location </span><span class="token variable" style="color:#36acaa">${location}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --generate-ssh-keys </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --vm-set-type VirtualMachineScaleSets </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --load-balancer-sku standard </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-count </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --zones </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --aks-custom-headers </span><span class="token assign-left variable" style="color:#36acaa">EnableAzureDiskFileCSIDriver</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="create-component-node-pools">Create component node pools<a class="hash-link" href="#create-component-node-pools" title="Direct link to heading">â€‹</a></h3><p>After creating an AKS cluster, run the following commands to create component node pools. Each node pool may take two to five minutes to create. It is recommended to enable <a href="https://docs.microsoft.com/en-us/azure/aks/use-ultra-disks#enable-ultra-disks-on-an-existing-cluster" target="_blank" rel="noopener noreferrer">Ultra disks</a> in the TiKV node pool. For more details about cluster configuration, refer to <a href="https://docs.microsoft.com/en-us/cli/azure/aks?view=azure-cli-latest#az_aks_create" target="_blank" rel="noopener noreferrer"><code>az aks</code> documentation</a> and <a href="https://docs.microsoft.com/en-us/cli/azure/aks/nodepool?view=azure-cli-latest" target="_blank" rel="noopener noreferrer"><code>az aks nodepool</code> documentation</a>.</p><ol><li><p>To create a TiDB Operator and monitor pool:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">az aks nodepool </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> --name admin </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-name </span><span class="token variable" style="color:#36acaa">${clusterName}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --resource-group </span><span class="token variable" style="color:#36acaa">${resourceGroup}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --zones </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --aks-custom-headers </span><span class="token assign-left variable" style="color:#36acaa">EnableAzureDiskFileCSIDriver</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-count </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --labels </span><span class="token assign-left variable" style="color:#36acaa">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">admin</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Create a PD node pool with <code>nodeType</code> being <code>Standard_F4s_v2</code> or higher:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">az aks nodepool </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> --name pd </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-name </span><span class="token variable" style="color:#36acaa">${clusterName}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --resource-group </span><span class="token variable" style="color:#36acaa">${resourceGroup}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-vm-size </span><span class="token variable" style="color:#36acaa">${nodeType}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --zones </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --aks-custom-headers </span><span class="token assign-left variable" style="color:#36acaa">EnableAzureDiskFileCSIDriver</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-count </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --labels </span><span class="token assign-left variable" style="color:#36acaa">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pd </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-taints </span><span class="token assign-left variable" style="color:#36acaa">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pd:NoSchedule</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Create a TiDB node pool with <code>nodeType</code> being <code>Standard_F8s_v2</code> or higher. You can set <code>--node-count</code> to <code>2</code> because only two TiDB nodes are required by default. You can also scale out this node pool by modifying this parameter at any time if necessary.</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">az aks nodepool </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> --name tidb </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-name </span><span class="token variable" style="color:#36acaa">${clusterName}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --resource-group </span><span class="token variable" style="color:#36acaa">${resourceGroup}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-vm-size </span><span class="token variable" style="color:#36acaa">${nodeType}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --zones </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --aks-custom-headers </span><span class="token assign-left variable" style="color:#36acaa">EnableAzureDiskFileCSIDriver</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-count </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --labels </span><span class="token assign-left variable" style="color:#36acaa">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tidb </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-taints </span><span class="token assign-left variable" style="color:#36acaa">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tidb:NoSchedule</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Create a TiKV node pool with <code>nodeType</code> being <code>Standard_E8s_v4</code> or higher:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">az aks nodepool </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> --name tikv </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-name </span><span class="token variable" style="color:#36acaa">${clusterName}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --resource-group </span><span class="token variable" style="color:#36acaa">${resourceGroup}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-vm-size </span><span class="token variable" style="color:#36acaa">${nodeType}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --zones </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --aks-custom-headers </span><span class="token assign-left variable" style="color:#36acaa">EnableAzureDiskFileCSIDriver</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-count </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --labels </span><span class="token assign-left variable" style="color:#36acaa">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tikv </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-taints </span><span class="token assign-left variable" style="color:#36acaa">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tikv:NoSchedule </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --enable-ultra-ssd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="deploy-component-node-pools-in-availability-zones">Deploy component node pools in availability zones<a class="hash-link" href="#deploy-component-node-pools-in-availability-zones" title="Direct link to heading">â€‹</a></h3><p>The Azure AKS cluster deploys nodes across multiple zones using &quot;best effort zone balance&quot;. If you want to apply &quot;strict zone balance&quot; (not supported in AKS now), you can deploy one node pool in one zone. For example:</p><ol><li><p>Create TiKV node pool 1 in zone 1:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">az aks nodepool </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> --name tikv1 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-name </span><span class="token variable" style="color:#36acaa">${clusterName}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --resource-group </span><span class="token variable" style="color:#36acaa">${resourceGroup}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-vm-size </span><span class="token variable" style="color:#36acaa">${nodeType}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --zones </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --aks-custom-headers </span><span class="token assign-left variable" style="color:#36acaa">EnableAzureDiskFileCSIDriver</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-count </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --labels </span><span class="token assign-left variable" style="color:#36acaa">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tikv </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-taints </span><span class="token assign-left variable" style="color:#36acaa">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tikv:NoSchedule </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --enable-ultra-ssd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Create TiKV node pool 2 in zone 2:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">az aks nodepool </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> --name tikv2 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-name </span><span class="token variable" style="color:#36acaa">${clusterName}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --resource-group </span><span class="token variable" style="color:#36acaa">${resourceGroup}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-vm-size </span><span class="token variable" style="color:#36acaa">${nodeType}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --zones </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --aks-custom-headers </span><span class="token assign-left variable" style="color:#36acaa">EnableAzureDiskFileCSIDriver</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-count </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --labels </span><span class="token assign-left variable" style="color:#36acaa">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tikv </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-taints </span><span class="token assign-left variable" style="color:#36acaa">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tikv:NoSchedule </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --enable-ultra-ssd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Create TiKV node pool 3 in zone 3:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">az aks nodepool </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> --name tikv3 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-name </span><span class="token variable" style="color:#36acaa">${clusterName}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --resource-group </span><span class="token variable" style="color:#36acaa">${resourceGroup}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-vm-size </span><span class="token variable" style="color:#36acaa">${nodeType}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --zones </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --aks-custom-headers </span><span class="token assign-left variable" style="color:#36acaa">EnableAzureDiskFileCSIDriver</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-count </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --labels </span><span class="token assign-left variable" style="color:#36acaa">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tikv </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-taints </span><span class="token assign-left variable" style="color:#36acaa">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tikv:NoSchedule </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --enable-ultra-ssd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol><div class="admonition admonition-danger alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>Warning</h5></div><div class="admonition-content"><p>About node pool scale-in:</p><ul><li>You can manually scale in or out an AKS cluster to run a different number of nodes. When you scale in, nodes are carefully <a href="https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/" target="_blank" rel="noopener noreferrer">cordoned and drained</a> to minimize disruption to running applications. Refer to <a href="https://docs.microsoft.com/en-us/azure/aks/scale-cluster" target="_blank" rel="noopener noreferrer">Scale the node count in an Azure Kubernetes Service (AKS) cluster</a>.</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="configure-storageclass">Configure StorageClass<a class="hash-link" href="#configure-storageclass" title="Direct link to heading">â€‹</a></h2><p>To improve disk IO performance, it is recommended to add <code>mountOptions</code> in <code>StorageClass</code> to configure <code>nodelalloc</code> and <code>noatime</code>. Refer to <a href="https://docs.pingcap.com/tidb/stable/check-before-deployment#mount-the-data-disk-ext4-filesystem-with-options-on-the-target-machines-that-deploy-tikv" target="_blank" rel="noopener noreferrer">Mount the data disk ext4 filesystem with options on the target machines that deploy TiKV</a>.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> StorageClass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> storage.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">mountOptions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> nodelalloc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">noatime</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="deploy-tidb-operator">Deploy TiDB Operator<a class="hash-link" href="#deploy-tidb-operator" title="Direct link to heading">â€‹</a></h2><p>Deploy TiDB Operator in the AKS cluster by referring to <a href="/docusaurus-operator/get-started#step-2-deploy-tidb-operator"><em>Deploy TiDB Operator</em> section</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="deploy-a-tidb-cluster-and-the-monitoring-component">Deploy a TiDB cluster and the monitoring component<a class="hash-link" href="#deploy-a-tidb-cluster-and-the-monitoring-component" title="Direct link to heading">â€‹</a></h2><p>This section describes how to deploy a TiDB cluster and its monitoring component in Azure AKS.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="create-namespace">Create namespace<a class="hash-link" href="#create-namespace" title="Direct link to heading">â€‹</a></h3><p>To create a namespace to deploy the TiDB cluster, run the following command:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create namespace tidb-cluster</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div></div><p>A <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/" target="_blank" rel="noopener noreferrer"><code>namespace</code></a> is a virtual cluster backed by the same physical cluster. This document takes <code>tidb-cluster</code> as an example. If you want to use other namespaces, modify the corresponding arguments of <code>-n</code> or <code>--namespace</code>.</p><p>:::</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="deploy">Deploy<a class="hash-link" href="#deploy" title="Direct link to heading">â€‹</a></h3><p>First, download the sample <code>TidbCluster</code> and <code>TidbMonitor</code> configuration files:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -O https://raw.githubusercontent.com/pingcap/tidb-operator/master/examples/aks/tidb-cluster.yaml </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -O https://raw.githubusercontent.com/pingcap/tidb-operator/master/examples/aks/tidb-monitor.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Refer to <a href="/docusaurus-operator/configure-a-tidb-cluster">configure the TiDB cluster</a> to further customize and configure the CR before applying.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>By default, TiDB LoadBalancer in <code>tidb-cluster.yaml</code> is set to &quot;internal&quot;, indicating that the LoadBalancer is only accessible within the cluster virtual network, not externally. To access TiDB over the MySQL protocol, you need to use a bastion to access the internal host of the cluster or use <code>kubectl port-forward</code>. You can delete the &quot;internal&quot; schema in the <code>tidb-cluster.yaml</code> file to expose the LoadBalancer publicly by default. However, notice that this practice may expose TiDB to risks.</p></div></div><p>To deploy the <code>TidbCluster</code> and <code>TidbMonitor</code> CR in the AKS cluster, run the following command:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f tidb-cluster.yaml -n tidb-cluster </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f tidb-monitor.yaml -n tidb-cluster</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>After the yaml file above is applied to the Kubernetes cluster, TiDB Operator creates the desired TiDB cluster and its monitoring component according to the yaml file.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="view-the-cluster-status">View the cluster status<a class="hash-link" href="#view-the-cluster-status" title="Direct link to heading">â€‹</a></h3><p>To view the status of the TiDB cluster, run the following command:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -n tidb-cluster</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>When all the pods are in the <code>Running</code> or <code>Ready</code> state, the TiDB cluster is successfully started. For example:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">NAME                              READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tidb-discovery-5cb8474d89-n8cxk   1/1     Running   0          47h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tidb-monitor-6fbcc68669-dsjlc     3/3     Running   0          47h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tidb-pd-0                         1/1     Running   0          47h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tidb-pd-1                         1/1     Running   0          46h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tidb-pd-2                         1/1     Running   0          46h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tidb-tidb-0                       2/2     Running   0          47h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tidb-tidb-1                       2/2     Running   0          46h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tidb-tikv-0                       1/1     Running   0          47h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tidb-tikv-1                       1/1     Running   0          47h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tidb-tikv-2                       1/1     Running   0          47h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="access-the-database">Access the database<a class="hash-link" href="#access-the-database" title="Direct link to heading">â€‹</a></h2><p>After deploying a TiDB cluster, you can access the TiDB database to test or develop applications.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="access-method">Access method<a class="hash-link" href="#access-method" title="Direct link to heading">â€‹</a></h3><ul><li>Access via Bastion</li></ul><p>The LoadBalancer created for your TiDB cluster resides in an intranet. You can create a <a href="https://docs.microsoft.com/en-us/azure/bastion/tutorial-create-host-portal" target="_blank" rel="noopener noreferrer">Bastion</a> in the cluster virtual network to connect to an internal host and then access the database.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>In addition to the bastion host, you can also connect an existing host to the cluster virtual network by <a href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-peering-overview" target="_blank" rel="noopener noreferrer">Peering</a>. If the AKS cluster is created in an existing virtual network, you can use hosts in this virtual network to access the database.</p></div></div><ul><li>Access via SSH</li></ul><p>You can <a href="https://docs.microsoft.com/en-us/azure/aks/ssh#create-the-ssh-connection-to-a-linux-node" target="_blank" rel="noopener noreferrer">create the SSH connection to a Linux node</a> to access the database.</p><ul><li>Access via node-shell</li></ul><p>You can simply use tools like <a href="https://github.com/kvaps/kubectl-node-shell" target="_blank" rel="noopener noreferrer">node-shell</a> to connect to nodes in the cluster, then access the database.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="access-via-the-mysql-client">Access via the MySQL client<a class="hash-link" href="#access-via-the-mysql-client" title="Direct link to heading">â€‹</a></h3><p>After access to the internal host via SSH, you can access the TiDB cluster through the MySQL client.</p><ol><li><p>Install the MySQL client on the host:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> yum </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> mysql -y</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Connect the client to the TiDB cluster:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql --comments -h </span><span class="token variable" style="color:#36acaa">${tidb-lb-ip}</span><span class="token plain"> -P </span><span class="token number" style="color:#36acaa">4000</span><span class="token plain"> -u root</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>${tidb-lb-ip}</code> is the LoadBalancer IP address of the TiDB service. To obtain it, run the <code>kubectl get svc basic-tidb -n tidb-cluster</code> command. The <code>EXTERNAL-IP</code> field returned is the IP address.</p><p>For example:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ mysql --comments -h </span><span class="token number" style="color:#36acaa">20.240</span><span class="token plain">.0.7 -P </span><span class="token number" style="color:#36acaa">4000</span><span class="token plain"> -u root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Welcome to the MariaDB monitor.  Commands end with </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> or </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">g.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Your MySQL connection </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> is </span><span class="token number" style="color:#36acaa">1189</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Server version: </span><span class="token number" style="color:#36acaa">5.7</span><span class="token plain">.25-TiDB-v4.0.2 TiDB Server </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Apache License </span><span class="token number" style="color:#36acaa">2.0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> Community Edition, MySQL </span><span class="token number" style="color:#36acaa">5.7</span><span class="token plain"> compatible</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Copyright </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2000</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">2018</span><span class="token plain">, Oracle, MariaDB Corporation Ab and others.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type </span><span class="token string" style="color:#e3116c">&#x27;help;&#x27;</span><span class="token plain"> or </span><span class="token string" style="color:#e3116c">&#x27;\h&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> help. Type </span><span class="token string" style="color:#e3116c">&#x27;\c&#x27;</span><span class="token plain"> to </span><span class="token function" style="color:#d73a49">clear</span><span class="token plain"> the current input statement.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MySQL </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">none</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> show status</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+--------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Variable_name      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Value                                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+--------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Ssl_cipher         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">                                      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Ssl_cipher_list    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">                                      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Ssl_verify_mode    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                                    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Ssl_version        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">                                      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ddl_schema_version </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">                                   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> server_id          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ed4ba88b-436a-424d-9087-977e897cf5ec </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+--------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> rows </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin class-name">set</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.00</span><span class="token plain"> sec</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><ul><li><a href="https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_default_authentication_plugin" target="_blank" rel="noopener noreferrer">The default authentication plugin of MySQL 8.0</a> is updated from <code>mysql_native_password</code> to <code>caching_sha2_password</code>. Therefore, if you access the TiDB service (earlier than v4.0.7) by using MySQL 8.0 client via password authentication, you need to specify the <code>--default-auth=mysql_native_password</code> parameter.</li><li>By default, TiDB (starting from v4.0.2) periodically shares usage details with PingCAP to help understand how to improve the product. For details about what is shared and how to disable the sharing, see <a href="https://docs.pingcap.com/tidb/stable/telemetry" target="_blank" rel="noopener noreferrer">Telemetry</a>.</li></ul></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="access-the-grafana-monitoring-dashboard">Access the Grafana monitoring dashboard<a class="hash-link" href="#access-the-grafana-monitoring-dashboard" title="Direct link to heading">â€‹</a></h2><p>Obtain the LoadBalancer IP address of Grafana:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -n tidb-cluster get svc basic-grafana</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>For example:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get svc basic-grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME            TYPE           CLUSTER-IP      EXTERNAL-IP   PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">          AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">basic-grafana   LoadBalancer   </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.199.42   </span><span class="token number" style="color:#36acaa">20.240</span><span class="token plain">.0.8    </span><span class="token number" style="color:#36acaa">3000</span><span class="token plain">:30761/TCP   121m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In the output above, the <code>EXTERNAL-IP</code> column is the LoadBalancer IP address.</p><p>You can access the <code>${grafana-lb}:3000</code> address using your web browser to view monitoring metrics. Replace <code>${grafana-lb}</code> with the LoadBalancer IP address.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>The default Grafana username and password are both <code>admin</code>.</p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="access-tidb-dashboard">Access TiDB Dashboard<a class="hash-link" href="#access-tidb-dashboard" title="Direct link to heading">â€‹</a></h2><p>See <a href="/docusaurus-operator/access-dashboard">Access TiDB Dashboard</a> for instructions about how to securely allow access to TiDB Dashboard.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="upgrade">Upgrade<a class="hash-link" href="#upgrade" title="Direct link to heading">â€‹</a></h2><p>To upgrade the TiDB cluster, execute the following command:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch tc basic -n tidb-cluster --type merge -p &#x27;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;spec&quot;</span><span class="token plain">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;version&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${version}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">`.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The upgrade process does not finish immediately. You can view the upgrade progress by running the <code>kubectl get pods -n tidb-cluster --watch</code> command.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="scale-out">Scale out<a class="hash-link" href="#scale-out" title="Direct link to heading">â€‹</a></h2><p>Before scaling out the cluster, you need to scale out the corresponding node pool so that the new instances have enough resources for operation.</p><p>This section describes how to scale out the AKS node pool and TiDB components.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="scale-out-aks-node-pool">Scale out AKS node pool<a class="hash-link" href="#scale-out-aks-node-pool" title="Direct link to heading">â€‹</a></h3><p>When scaling out TiKV, the node pools must be scaled out evenly among availability zones. The following example shows how to scale out the TiKV node pool of the <code>${clusterName}</code> cluster to 6 nodes:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">az aks nodepool scale </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --resource-group </span><span class="token variable" style="color:#36acaa">${resourceGroup}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-name </span><span class="token variable" style="color:#36acaa">${clusterName}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --name </span><span class="token variable" style="color:#36acaa">${nodePoolName}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-count </span><span class="token number" style="color:#36acaa">6</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>For more information on node pool management, refer to <a href="https://docs.microsoft.com/zh-cn/cli/azure/aks/nodepool?view=azure-cli-latest" target="_blank" rel="noopener noreferrer"><code>az aks nodepool</code></a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="scale-out-tidb-components">Scale out TiDB components<a class="hash-link" href="#scale-out-tidb-components" title="Direct link to heading">â€‹</a></h3><p>After scaling out the AKS node pool, run the <code>kubectl edit tc basic -n tidb-cluster</code> command with <code>replicas</code> of each component set to desired value. The scaling-out process is then completed.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="deploy-tiflashticdc">Deploy TiFlash/TiCDC<a class="hash-link" href="#deploy-tiflashticdc" title="Direct link to heading">â€‹</a></h2><p><a href="https://docs.pingcap.com/tidb/stable/tiflash-overview" target="_blank" rel="noopener noreferrer">TiFlash</a> is the columnar storage extension of TiKV.</p><p><a href="https://docs.pingcap.com/tidb/stable/ticdc-overview" target="_blank" rel="noopener noreferrer">TiCDC</a> is a tool for replicating the incremental data of TiDB by pulling TiKV change logs.</p><p>The two components are <em>not required</em> in the deployment. This section shows a quick start example.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="add-node-pools">Add node pools<a class="hash-link" href="#add-node-pools" title="Direct link to heading">â€‹</a></h3><p>Add a node pool for TiFlash/TiCDC respectively. You can set <code>--node-count</code> as required.</p><ol><li><p>Create a TiFlash node pool with <code>nodeType</code> being <code>Standard_E8s_v4</code> or higher:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">az aks nodepool </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> --name tiflash </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-name </span><span class="token variable" style="color:#36acaa">${clusterName}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --resource-group </span><span class="token variable" style="color:#36acaa">${resourceGroup}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-vm-size </span><span class="token variable" style="color:#36acaa">${nodeType}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --zones </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --aks-custom-headers </span><span class="token assign-left variable" style="color:#36acaa">EnableAzureDiskFileCSIDriver</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-count </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --labels </span><span class="token assign-left variable" style="color:#36acaa">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tiflash </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-taints </span><span class="token assign-left variable" style="color:#36acaa">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tiflash:NoSchedule</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Create a TiCDC node pool with <code>nodeType</code> being <code>Standard_E16s_v4</code> or higher:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">az aks nodepool </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> --name ticdc </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-name </span><span class="token variable" style="color:#36acaa">${clusterName}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --resource-group </span><span class="token variable" style="color:#36acaa">${resourceGroup}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-vm-size </span><span class="token variable" style="color:#36acaa">${nodeType}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --zones </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --aks-custom-headers </span><span class="token assign-left variable" style="color:#36acaa">EnableAzureDiskFileCSIDriver</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-count </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --labels </span><span class="token assign-left variable" style="color:#36acaa">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ticdc </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-taints </span><span class="token assign-left variable" style="color:#36acaa">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ticdc:NoSchedule</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="configure-and-deploy">Configure and deploy<a class="hash-link" href="#configure-and-deploy" title="Direct link to heading">â€‹</a></h3><ul><li><p>To deploy TiFlash, configure <code>spec.tiflash</code> in <code>tidb-cluster.yaml</code>. The following is an example:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tiflash</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">baseImage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pingcap/tiflash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">maxFailoverCount</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">storageClaims</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">requests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">storage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 100Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">tolerations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">effect</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NoSchedule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dedicated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">operator</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Equal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tiflash</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>  For other parameters, refer to <a href="/docusaurus-operator/configure-a-tidb-cluster">Configure a TiDB Cluster</a>.</p><blockquote><p><strong>Warning:</strong></p><p>TiDB Operator automatically mounts PVs <strong>in the order of the configuration</strong> in the <code>storageClaims</code> list. Therefore, if you need to add disks for TiFlash, make sure that you add the disks <strong>only to the end of the original configuration</strong> in the list. In addition, you must <strong>not</strong> alter the order of the original configuration.</p></blockquote></li><li><p>To deploy TiCDC, configure <code>spec.ticdc</code> in <code>tidb-cluster.yaml</code>. The following is an example:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ticdc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">baseImage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pingcap/ticdc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">tolerations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">effect</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NoSchedule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dedicated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">operator</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Equal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ticdc</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>  Modify <code>replicas</code> as required.</p></li></ul><p>Finally, run the <code>kubectl -n tidb-cluster apply -f tidb-cluster.yaml</code> command to update the TiDB cluster configuration.</p><p>For detailed CR configuration, refer to <a href="https://github.com/pingcap/tidb-operator/blob/master/docs/api-references/docs.md" target="_blank" rel="noopener noreferrer">API references</a> and <a href="/docusaurus-operator/configure-a-tidb-cluster">Configure a TiDB Cluster</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="deploy-tidb-enterprise-edition">Deploy TiDB Enterprise Edition<a class="hash-link" href="#deploy-tidb-enterprise-edition" title="Direct link to heading">â€‹</a></h2><p>To deploy TiDB/PD/TiKV/TiFlash/TiCDC Enterprise Edition, configure <code>spec.[tidb|pd|tikv|tiflash|ticdc].baseImage</code> in <code>tidb-cluster.yaml</code> as the enterprise image. The enterprise image format is <code>pingcap/[tidb|pd|tikv|tiflash|ticdc]-enterprise</code>.</p><p>For example:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">pd</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">baseImage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pingcap/pd</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">enterprise</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tikv</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">baseImage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pingcap/tikv</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">enterprise</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="use-other-disk-volume-types">Use other Disk volume types<a class="hash-link" href="#use-other-disk-volume-types" title="Direct link to heading">â€‹</a></h2><p>Azure disks support multiple volume types. Among them, <code>UltraSSD</code> delivers low latency and high throughput and can be enabled by performing the following steps:</p><ol><li><p><a href="https://docs.microsoft.com/en-us/azure/aks/use-ultra-disks#enable-ultra-disks-on-an-existing-cluster" target="_blank" rel="noopener noreferrer">Enable Ultra disks on an existing cluster</a> and create a storage class for <code>UltraSSD</code>:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> storage.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> StorageClass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ultra</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">provisioner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> disk.csi.azure.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">parameters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">skuname</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> UltraSSD_LRS  </span><span class="token comment" style="color:#999988;font-style:italic"># alias: storageaccounttype, available values: Standard_LRS, Premium_LRS, StandardSSD_LRS, UltraSSD_LRS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">cachingMode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">reclaimPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">allowVolumeExpansion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">volumeBindingMode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> WaitForFirstConsumer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">mountOptions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> nodelalloc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">noatime</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You can add more <a href="https://github.com/kubernetes-sigs/azuredisk-csi-driver/blob/master/docs/driver-parameters.md" target="_blank" rel="noopener noreferrer">Driver Parameters</a> as required.</p></li><li><p>In <code>tidb-cluster.yaml</code>, specify the <code>ultra</code> storage class to apply for the <code>UltraSSD</code> volume type through the <code>storageClassName</code> field.</p><p>The following is a TiKV configuration example you can refer to:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tikv</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">storageClassName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ultra</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol><p>You can use any supported Azure disk type. It is recommended to use <code>Premium_LRS</code> or <code>UltraSSD_LRS</code>.</p><p>For more information about the storage class configuration and Azure disk types, refer to <a href="https://github.com/kubernetes-sigs/azuredisk-csi-driver" target="_blank" rel="noopener noreferrer">Storage Class documentation</a> and <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/disks-types" target="_blank" rel="noopener noreferrer">Azure Disk Types</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="use-local-storage">Use local storage<a class="hash-link" href="#use-local-storage" title="Direct link to heading">â€‹</a></h2><p>Use Azure LRS disks for storage in production environment. To simulate bare-metal performance, use additional <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/sizes-storage" target="_blank" rel="noopener noreferrer">NVMe SSD local store volumes</a> provided by some Azure instances. You can choose such instances for the TiKV node pool to achieve higher IOPS and lower latency.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><ul><li>You cannot dynamically change the storage class of a running TiDB cluster. In this case, create a new cluster for testing.</li><li>Local NVMe Disks are ephemeral. Data will be lost on these disks if you stop/deallocate your node. When the node is reconstructed, you need to migrate data in TiKV. If you do not want to migrate data, it is recommended not to use the local disk in a production environment.</li></ul></div></div><p>For instance types that provide local disks, refer to <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/lsv2-series" target="_blank" rel="noopener noreferrer">Lsv2-series</a>. The following takes <code>Standard_L8s_v2</code> as an example:</p><ol><li><p>Create a node pool with local storage for TiKV.</p><p>Modify the instance type of the TiKV node pool in the <code>az aks nodepool add</code> command to <code>Standard_L8s_v2</code>:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">az aks nodepool </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> --name tikv </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-name </span><span class="token variable" style="color:#36acaa">${clusterName}</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --resource-group </span><span class="token variable" style="color:#36acaa">${resourceGroup}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-vm-size Standard_L8s_v2 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --zones </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --aks-custom-headers </span><span class="token assign-left variable" style="color:#36acaa">EnableAzureDiskFileCSIDriver</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-count </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --enable-ultra-ssd </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --labels </span><span class="token assign-left variable" style="color:#36acaa">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tikv </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --node-taints </span><span class="token assign-left variable" style="color:#36acaa">dedicated</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tikv:NoSchedule</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If the TiKV node pool already exists, you can either delete the old group and then create a new one, or change the group name to avoid conflict.</p></li><li><p>Deploy the local volume provisioner.</p><p>You need to use the <a href="https://sigs.k8s.io/sig-storage-local-static-provisioner" target="_blank" rel="noopener noreferrer">local-volume-provisioner</a> to discover and manage the local storage. Run the following command to deploy and create a <code>local-storage</code> storage class:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/pingcap/tidb-operator/master/manifests/eks/local-volume-provisioner.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Use local storage.</p><p>After the steps above, the local volume provisioner can discover all the local NVMe SSD disks in the cluster.</p><p>Add the <code>tikv.storageClassName</code> field to the <code>tidb-cluster.yaml</code> file and set the value of the field to <code>local-storage</code>.</p><p>For more information, refer to <a href="#deploy">Deploy TiDB cluster and its monitoring components</a></p></li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/deploy-on-azure-aks.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docusaurus-operator/deploy-on-gcp-gke"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Deploy TiDB on GCP GKE</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docusaurus-operator/deploy-on-alibaba-cloud"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Deploy TiDB on Alibaba Cloud Kubernetes</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#create-an-aks-cluster-and-a-node-pool" class="table-of-contents__link toc-highlight">Create an AKS cluster and a node pool</a><ul><li><a href="#create-an-aks-cluster-with-csi-enabled" class="table-of-contents__link toc-highlight">Create an AKS cluster with CSI enabled</a></li><li><a href="#create-component-node-pools" class="table-of-contents__link toc-highlight">Create component node pools</a></li><li><a href="#deploy-component-node-pools-in-availability-zones" class="table-of-contents__link toc-highlight">Deploy component node pools in availability zones</a></li><li><a href="#deploy" class="table-of-contents__link toc-highlight">Deploy</a></li><li><a href="#view-the-cluster-status" class="table-of-contents__link toc-highlight">View the cluster status</a></li></ul></li><li><a href="#access-the-database" class="table-of-contents__link toc-highlight">Access the database</a><ul><li><a href="#access-method" class="table-of-contents__link toc-highlight">Access method</a></li><li><a href="#access-via-the-mysql-client" class="table-of-contents__link toc-highlight">Access via the MySQL client</a></li></ul></li><li><a href="#access-the-grafana-monitoring-dashboard" class="table-of-contents__link toc-highlight">Access the Grafana monitoring dashboard</a></li><li><a href="#access-tidb-dashboard" class="table-of-contents__link toc-highlight">Access TiDB Dashboard</a></li><li><a href="#upgrade" class="table-of-contents__link toc-highlight">Upgrade</a></li><li><a href="#scale-out" class="table-of-contents__link toc-highlight">Scale out</a><ul><li><a href="#scale-out-aks-node-pool" class="table-of-contents__link toc-highlight">Scale out AKS node pool</a></li><li><a href="#scale-out-tidb-components" class="table-of-contents__link toc-highlight">Scale out TiDB components</a></li></ul></li><li><a href="#deploy-tiflashticdc" class="table-of-contents__link toc-highlight">Deploy TiFlash/TiCDC</a><ul><li><a href="#add-node-pools" class="table-of-contents__link toc-highlight">Add node pools</a></li><li><a href="#configure-and-deploy" class="table-of-contents__link toc-highlight">Configure and deploy</a></li></ul></li><li><a href="#deploy-tidb-enterprise-edition" class="table-of-contents__link toc-highlight">Deploy TiDB Enterprise Edition</a></li><li><a href="#use-other-disk-volume-types" class="table-of-contents__link toc-highlight">Use other Disk volume types</a></li><li><a href="#use-local-storage" class="table-of-contents__link toc-highlight">Use local storage</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docusaurus-operator/">User Manual</a></li><li class="footer__item"><a class="footer__link-item" href="/docusaurus-operator/architecture">Reference</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/tidb" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://tidb.io" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>tidb.io<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/pingcap" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/pingcap/tidb-operator" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Source Code<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 TiDB in Kubernetes Docs, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/docusaurus-operator/assets/js/runtime~main.5f239d35.js"></script>
<script src="/docusaurus-operator/assets/js/main.4a76a225.js"></script>
</body>
</html>